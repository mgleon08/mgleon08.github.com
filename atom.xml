<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Leon's Blogging]]></title>
  <link href="http://mgleon08.github.com/atom.xml" rel="self"/>
  <link href="http://mgleon08.github.com/"/>
  <updated>2016-02-01T22:25:45+08:00</updated>
  <id>http://mgleon08.github.com/</id>
  <author>
    <name><![CDATA[LeonJi]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[自定 Module 和 Class 檔案]]></title>
    <link href="http://mgleon08.github.com/blog/2016/02/01/customer-module-class/"/>
    <updated>2016-02-01T22:19:13+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/02/01/customer-module-class</id>
    <content type="html"><![CDATA[<p>在 rails 當中，可以自訂一些好用方便的檔案，在適當的時機來使用。</p>

<!-- more -->


<h1>method</h1>

<p>在 <code>lib/require/object.rb</code>，可以自行新增 class</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Object</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">is?</span><span class="p">(</span><span class="o">*</span><span class="n">objects</span><span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">object</span> <span class="k">in</span> <span class="n">objects</span>
</span><span class='line'>      <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="nb">self</span> <span class="o">==</span> <span class="n">object</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>require</h1>

<p>但要記得要在使用的檔案，先 require 才能夠使用</p>

<p>也可以直接在 <code>config/initializer/require.rb</code> require 進來，就不用每個檔案上面都 require 了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#單個檔案</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/lib/require/object.rb&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#多個檔案</span>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/lib/require/object.rb&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">require</span> <span class="n">file</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>使用</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;hello&quot;</span><span class="o">.</span><span class="n">is?</span><span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;hello)</span>
</span><span class='line'><span class="s2">#=&gt; true</span>
</span><span class='line'>
</span><span class='line'><span class="s2">&quot;</span><span class="n">hello</span><span class="s2">&quot;.is?(&quot;</span><span class="n">yes</span><span class="s2">&quot;, &quot;</span><span class="n">no</span><span class="s2">&quot;)</span>
</span><span class='line'><span class="s2">#=&gt; false</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[如何測試上傳檔案 Rspec Upload File]]></title>
    <link href="http://mgleon08.github.com/blog/2016/02/01/rspec-upload-file/"/>
    <updated>2016-02-01T21:32:55+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/02/01/rspec-upload-file</id>
    <content type="html"><![CDATA[<p>rails 本身就有內建的 helper 可以很快的建造假的檔案，然後就可以測試上傳的功能了。</p>

<!-- more -->


<h1>建立資料夾</h1>

<p><code>spec/fixtures/files</code></p>

<p>在資料夾裡放入用來測試的檔案</p>

<h1>Rack::Test::UploadedFile.new</h1>

<p><code>Rack::Test::UploadedFile.new('path','mime-type')</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">UploadedFile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;test.jpg&#39;</span><span class="p">,</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">)</span>
</span><span class='line'><span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">UploadedFile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;/spec/fixtures/files/1.jpg&#39;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<h1>fixture_file_upload</h1>

<p>上面的簡短版本 <code>fixture_file_upload('path','mime-type')</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@file1</span> <span class="o">=</span> <span class="n">fixture_file_upload</span><span class="p">(</span><span class="s1">&#39;files/1.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;image/jpg&#39;</span><span class="p">)</span>
</span><span class='line'><span class="vi">@file2</span> <span class="o">=</span> <span class="n">fixture_file_upload</span><span class="p">(</span><span class="s1">&#39;files/2.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上兩個擇一，這樣就可以在 <code>create</code> 將 <code>@file</code> 帶入到 params</p>

<p>官方文件：
<a href="http://www.rubydoc.info/github/brynary/rack-test/Rack/Test/UploadedFile">Class: Rack::Test::UploadedFile</a>
<a href="http://apidock.com/rails/ActionDispatch/TestProcess/fixture_file_upload">fixture_file_upload</a></p>

<p>參考文件：
<a href="http://stackoverflow.com/questions/1178587/how-do-i-test-a-file-upload-in-rails">How do I test a file upload in rails?</a>
<a href="https://ruby-china.org/topics/21057">[求助] 文件上传的测试代码怎么写</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Ruby 進行 File ＆ Dir 檔案操作]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/31/ruby-file-dir/"/>
    <updated>2016-01-31T19:07:00+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/31/ruby-file-dir</id>
    <content type="html"><![CDATA[<p>用 ruby 來操作 file ＆ Dir 檔案。</p>

<!-- more -->


<h1>File 檔案操作</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ruby.rb&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># w 覆寫整個檔案</span>
</span><span class='line'><span class="c1"># a 將內容加到檔案後方</span>
</span><span class='line'><span class="c1"># r 將內容加在檔案最前面</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;/home/work/ruby.rb&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;ruby.rb&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;puts &#39;hello world&#39;&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1"># 打開檔案，並寫入文字</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/home/work/ruby.rb&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">#刪除檔案</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;ruby.rb&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">#讀取檔案</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Path</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; 目前檔案路徑</span>
</span><span class='line'><span class="c1"># __FILE__ 是一個預先定義好的變數，內容是目前這個檔案的名稱</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;ruby.rb&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; root_path/ruby.rb</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://stackoverflow.com/questions/224379/what-does-file-mean-in-ruby">What does <strong>FILE</strong> mean in Ruby?</a></p>

<h1>File data</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">extname</span><span class="p">(</span><span class="s2">&quot;ruby.rb&quot;&quot;)</span>
</span><span class='line'><span class="s2">#=&gt; &quot;</span><span class="o">.</span><span class="n">rb</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s2">File.basename(&quot;</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">ruby</span><span class="o">.</span><span class="n">rb</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">*</span><span class="s2">&quot;)</span>
</span><span class='line'><span class="s2">#=&gt; &quot;</span><span class="n">ruby</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2"># `*` Regular Expression，代表不管任何字</span>
</span><span class='line'>
</span><span class='line'><span class="s2">File.dirname(&quot;</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">ruby</span><span class="o">.</span><span class="n">rb</span><span class="s2">&quot;)</span>
</span><span class='line'><span class="s2"># =&gt; &quot;</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">work</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>資料夾操作</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># 建立資料夾</span>
</span><span class='line'>
</span><span class='line'><span class="no">Dir</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># 顯示目前的資料夾的檔案，回傳一個Array</span>
</span><span class='line'>
</span><span class='line'><span class="no">Dir</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1"># 檢查整個資料夾內的項目是否為檔案</span>
</span></code></pre></td></tr></table></div></figure>


<h1>判斷</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'><span class="c1"># 判斷是否為檔案？</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">directory?</span> <span class="s2">&quot;dir&quot;</span>
</span><span class='line'><span class="c1"># 判斷是否為資料夾？</span>
</span></code></pre></td></tr></table></div></figure>


<h1>FileUtils</h1>

<p>移動檔案</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;fileutils&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">FileUtils</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">current_path</span><span class="p">,</span> <span class="n">other_path</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">FileUtils</span><span class="o">.</span><span class="n">rm_rf</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># 刪除資料夾</span>
</span><span class='line'>
</span><span class='line'><span class="no">FileUtils</span><span class="o">.</span><span class="n">copy_entry</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">,</span> <span class="s2">&quot;new_dir&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># 複製整個資料夾內容</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：
<a href="http://ruby-doc.org/core-2.3.0/File.html">File</a>
<a href="http://ruby-doc.org/stdlib-2.2.2/libdoc/fileutils/rdoc/FileUtils.html#method-c-cd">FileUtils</a></p>

<p>參考文件：
<a href="http://motion-express.com/trainings/scripting-in-ruby/screencasts/manipulating-files">用Ruby Scripting維護系統</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[自訂 Validation]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/31/custom-validation/"/>
    <updated>2016-01-31T12:29:33+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/31/custom-validation</id>
    <content type="html"><![CDATA[<p>當內建的驗證沒有自己的需求時，可以自訂驗證的 method 來使用。</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="n">validate</span>  <span class="ss">:picture_size</span>  <span class="c1">#注意沒有加 &#39;s&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 驗證圖片的大小</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">picture_size</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">picture</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">.</span><span class="n">megabytes</span>
</span><span class='line'>      <span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:picture</span><span class="p">,</span> <span class="s2">&quot;should be less than 5MB&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="c1">#errors[:picture] &lt;&lt; &quot;should be less than 5MB&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://guides.rubyonrails.org/active_record_validations.html">Active Record 驗證</a><br/>
<a href="http://rails.ruby.tw/active_record_validations.html">Active Record 驗證 中文</a></p>

<p>參考文件：<br/>
<a href="https://ihower.tw/rails4/activerecord-lifecycle.html">ActiveRecord - 資料驗證及回呼</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Association Supports 方法]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/31/association-supports/"/>
    <updated>2016-01-31T11:54:15+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/31/association-supports</id>
    <content type="html"><![CDATA[<p>在 model 和 model 之間，經常要建立對應的關聯，rails 也提供很多 Supports 的 helper</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:active_relationships</span><span class="p">,</span>  <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">&quot;follower_id&quot;</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:passive_relationships</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span>  <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s2">&quot;followed_id&quot;</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:active_relationships</span><span class="p">,</span>  <span class="ss">source</span><span class="p">:</span> <span class="ss">:followed</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:passive_relationships</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="ss">:follower</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p><code>through</code> 透過關聯來建立另一個關聯集合，用於建立多對多的關係</p></li>
<li><p><code>class_name</code> 變更關聯的類別名稱</p></li>
</ul>


<p>可以用這個方式，自己關聯自己，像是要上面，User 可以 follower 很多個 User</p>

<blockquote><p>rails 慣例是 model 名稱，所以不用另外加 class_name</p></blockquote>

<ul>
<li><code>foreign_key</code> 可以修改外鍵名稱</li>
</ul>


<blockquote><p>rails 外鍵慣例是關聯的 Model 名稱加上 _id 後綴</p></blockquote>

<ul>
<li><code>dependent</code></li>
</ul>


<p>設定當物件刪除時，如何處理依賴它的資料</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:attendees</span><span class="p">,</span> <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#:destroy 把依賴的attendees也一併刪除，並且執行Attendee的destroy回呼</span>
</span><span class='line'><span class="c1">#:delete 把依賴的attendees也一併刪除，但不執行Attendee的destroy回呼</span>
</span><span class='line'><span class="c1">#:nullify 這是預設值，不會幫忙刪除attendees，但會把attendees的外部鍵event_id都設成NULL</span>
</span><span class='line'><span class="c1">#:restrict_with_exception 如果有任何依賴的attendees資料，則連event都不允許刪除。執行刪除時會丟出錯誤例外ActiveRecord::DeleteRestrictionError。</span>
</span><span class='line'><span class="c1">#:restrict_with_error 不允許刪除。執行刪除時會回傳false，在@event.errors中會留有錯誤訊息。</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>source</code></li>
</ul>


<p>搭配through設定使用，當關聯的名稱不一致的時候，需要加上source指名是哪一種物件。</p>

<ul>
<li><code>counter_cache</code> 參考之前文章 <a href="http://mgleon08.github.io/blog/2015/12/20/counter-cache/">counter-cache</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:pages</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Page</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:book</span><span class="p">,</span> <span class="ss">:counter_cache</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#設定成 ture，就會自動去找 pages_count 欄位，若要指定欄位則是 counter_cache: :count_of_pages</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>inverse_of</code></li>
</ul>


<p>關聯另一端的關聯名稱。</p>

<blockquote><p>belongs_to 無法與 :polymorphic 同時使用。
has_one 無法與 :through 或 :as 同時使用。</p></blockquote>

<ul>
<li><code>polymorphic</code> &amp; <code>as</code> 參考之前文章 <a href="http://mgleon08.github.io/blog/2015/12/20/ruby-on-rails-polymorphic-associations-and-sti/">polymorphic</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:commentable</span><span class="p">,</span> <span class="ss">:polymorphic</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:commentable</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:commentable</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>touch</code>
touch 為 true 時，儲存或刪除關聯物件時，關聯物件的 updated_at 或 updated_on 的時間戳會自動設成當前時間</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:customer</span><span class="p">,</span> <span class="ss">touch</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="c1">#更改欄位 touch: :orders_updated_at</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p><code>validate</code> 預設為 false，儲存物件時不會驗證關聯物件</p></li>
<li><p><code>primary_key</code> 可以修改主鍵名稱</p></li>
</ul>


<h1>Scope</h1>

<ul>
<li><code>where</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:customer</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>includes</code></li>
</ul>


<p>經常性使用 <code>@line_item.order.customer</code> 就可以加上</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">LineItem</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:order</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:customer</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:customer</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:line_items</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:orders</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>readonly</code></li>
</ul>


<p>如果設定了 readonly 選項，則關聯物件取出時為唯讀。</p>

<ul>
<li><code>select</code></li>
</ul>


<p>select 方法可以覆寫用來取出關聯的 SELECT 子句。預設會取出所有欄位</p>

<h3>has_many 額外方式</h3>

<p>條件也可透過 Hash 指定</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:confirmed_orders</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">confirmed</span><span class="p">:</span> <span class="kp">true</span> <span class="p">},</span>
</span><span class='line'>                              <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Order&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>用 Hash 的 where，產生出來的記錄會自動使用 Hash 的作用域。</p>

<p>上例中，使用 <code>@customer.confirmed_orders.create</code> 或 <code>@customer.confirmed_orders.build</code> 會建立出 confirmed 欄位為 true 的訂單</p>

<ul>
<li><code>group</code> 對結果做分組</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:line_items</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s1">&#39;orders.id&#39;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>limit</code> 限制透過關聯取出物件的數量</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">has_many</span> <span class="ss">:recent_orders</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">&#39;order_date desc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>offset</code> 指定開始從關聯取出物件的偏移量</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">offset</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>order</code> 指定關聯物件取出後的排序方式</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">&quot;date_confirmed DESC&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>distinct</code> 確保集合中沒有重複的物件</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">distinct</span> <span class="p">},</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:readings</span>
</span></code></pre></td></tr></table></div></figure>


<p>若想確保不插入重複的資料到資料庫（這樣取出來就確定是不重複的記錄了），應該要在資料表上新增一個唯一性的索引。</p>

<p>舉例來說，如果有 person_articles 資料表，想確保所有文章不重複，可加入下面這個遷移</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">add_index</span> <span class="ss">:person_articles</span><span class="p">,</span> <span class="ss">:article</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>不要使用 include? 來確保唯一性，因為多個使用者可能同時加入文章，可能會導致競態條件（Race Condition）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">person</span><span class="o">.</span><span class="n">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span> <span class="k">unless</span> <span class="n">person</span><span class="o">.</span><span class="n">articles</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>extending</code> 指定一個模組名稱，用來擴充關聯代理（association proxy）</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">FindRecentExtension</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_recent</span>
</span><span class='line'>    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;created_at &gt; ?&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:deliveries</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：
<a href="http://guides.rubyonrails.org/association_basics.html#has-many-association-reference">has_many Association Reference</a>
<a href="http://rails.ruby.tw/association_basics.html#has-many-%E9%97%9C%E8%81%AF%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A">has_many Association Reference 中文</a>
<a href="http://rails.ruby.tw/association_basics.html#belongs-to-%E9%97%9C%E8%81%AF%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A">belongs_to 關聯手冊</a>
<a href="http://rails.ruby.tw/association_basics.html#has-one-%E9%97%9C%E8%81%AF%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A">has_one 關聯手冊</a>
<a href="http://rails.ruby.tw/association_basics.html#has-many-%E9%97%9C%E8%81%AF%E5%8F%83%E8%80%83%E6%89%8B%E5%86%8A">has_many 關聯</a></p>

<p>參考文件：
<a href="https://ihower.tw/rails4/activerecord-relationships.html">ActiveRecord - 資料表關聯</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Transactions 交易]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/31/transactions/"/>
    <updated>2016-01-31T10:58:13+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/31/transactions</id>
    <content type="html"><![CDATA[<p>當兩件事情必須確實執行完畢，才存取到資料庫！</p>

<!-- more -->


<h1>Transactions交易</h1>

<p>像是銀行匯款，必須一方確實扣款，另一方確實有新增款項，這筆交易在算成功!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Feed</span><span class="o">.</span><span class="n">create!</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 transaction 裡面必須使用加上 <code>!</code> 才會丟例外，讓交易失敗。</p>

<p>另外，資料要在 transaction 完成後，才會存取到資料庫，因此有用 <code>after_save</code> 回呼，可能就會失敗。</p>

<p>因此必須改用 <code>after_commit</code>這個回呼，才能確保讀取到交易完成後的資料。</p>

<p><a href="https://ihower.tw/rails4/activerecord-others.html">ActiveRecord - 進階功能</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Try 來防止 Nil]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/29/try/"/>
    <updated>2016-01-29T21:35:23+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/29/try</id>
    <content type="html"><![CDATA[<p>在 rails 當中，經常會出現 nil 值，而爆錯，所以經常要去判斷
這個 try 就是簡化這個判斷產生的，懂得使用的話會非常好用。</p>

<!-- more -->


<p>但缺點就是每個地方都要去設定，即使是同一個值
因此另外一個解決方式就是用之前介紹的 <a href="http://mgleon08.github.io/blog/2015/12/13/ruby-on-rails-delegate/">delegate</a> 也可以達到同樣的效果。</p>

<h1>try</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># without try</span>
</span><span class='line'><span class="k">unless</span> <span class="vi">@number</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>  <span class="vi">@number</span><span class="o">.</span><span class="n">next</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># with try</span>
</span><span class='line'><span class="vi">@number</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:next</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>將原本要寫三行簡短成一行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'><span class="vi">@user</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:name</span><span class="o">=</span><span class="p">,</span> <span class="s2">&quot;haha&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">#@user.name = &quot;haha&quot; unless @user.nil?</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="c1">#=&gt; &quot;haha&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#若改成@user.try(:name&lt;&lt;, &quot;haha&quot;)</span>
</span><span class='line'><span class="c1">#則會變成Operation 的 &lt;&lt; 而爆錯</span>
</span><span class='line'><span class="c1">#@user.name &lt;&lt; &quot;haha&quot; unless @user.nil?</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以放入 block</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#@user.try { |u| &quot;#{u.first_name} #{u.last_name}&quot; }</span>
</span></code></pre></td></tr></table></div></figure>


<h3>用try 防止例外出現</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#假設 @user = nil</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@user</span><span class="o">.</span><span class="n">age</span>
</span><span class='line'><span class="c1">#=&gt; NoMethodError: undefined method `age&#39; for #&lt;User:0x007f80b74c70e0&gt;</span>
</span><span class='line'><span class="c1">#因為 nil.age</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@user</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:age</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; nil</span>
</span><span class='line'><span class="c1">#因為 nil.age unless nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：
<a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/core_ext/object/try.rb">try - rails_github</a>
<a href="http://guides.rubyonrails.org/active_support_core_extensions.html#try">try</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Rspec + Factory Girl 寫測試]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/29/rspec-plus-factory-girl/"/>
    <updated>2016-01-29T20:36:46+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/29/rspec-plus-factory-girl</id>
    <content type="html"><![CDATA[<p>程式寫久之後，就會發現測試的重要性!<br/>
因此來介紹 rails 中，比內建測試還好用的 rspec 搭配 factory_girl</p>

<!-- more -->


<h1>測試種類</h1>

<ul>
<li><p>單元測試(Unit test)<br/>
針對每個程式各個最小單位進行測試，像是在 controller 就單單只測試 controller 裡面的 action，而裡面產生的 model,method，都用假的方式來取代，已確保有錯誤時，可以很快知道是哪邊有問題 。</p></li>
<li><p>整合測試(Integration test)<br/>
主要是用來測試，每個 class 的互動，像是 controller 裡面會 call 到 model ，也會 call 到 view ，並測試回傳的值是否正確。</p></li>
</ul>


<h1>寫測試的好處</h1>

<ul>
<li>Instant Feedback 即時反饋（寫測試的時間 &lt; debug的時間）</li>
<li>回歸測試及重構 （重構時就不需要再重複的測試）</li>
<li>幫助設計API（TDD = 先測試，在實作）</li>
<li>一種程式文件（可以讓很快就知道之前api怎麼寫的）</li>
</ul>


<h1>慣例</h1>

<ul>
<li>⼀個 rb 檔案配⼀個同名的 _spec.rb 檔案</li>
<li>guard 等⼯具容易設定<br/>
<a href="https://github.com/guard/guard-rspec">guard-rspec</a> 程式⼀修改完存檔，⾃動跑對應的測試（bundle後，輸入 guard init repec 初始化，打guard（bundle exec guard 真正執行））</li>
<li>editor 有⽀援快速鍵</li>
<li>describe “#name” 是 instance method</li>
<li>describe “.name” 是 class method</li>
<li>測試spec盡量比較簡單清楚，可以不用DRY，實作才會要DRY</li>
</ul>


<h1>輸出格式</h1>

<ul>
<li>rspec filename.rb 預設不產⽣⽂件</li>
<li>rspec filename.rb -fd 輸出 specdoc ⽂件</li>
<li>rspec filename.rb -fh 輸出 html ⽂件</li>
</ul>


<h1>安裝</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>設定</h1>

<h3>顏色描述</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#vi .rspec檔案輸入</span>
</span><span class='line'><span class="o">--</span><span class="n">color</span> <span class="c1">#顯示顏色</span>
</span><span class='line'><span class="o">--</span><span class="nb">format</span> <span class="c1">#documentation顯示描述</span>
</span></code></pre></td></tr></table></div></figure>


<h3>將不需要的檔案關閉</h3>

<p>generate 新的 controller 或是 model 時，rails 就會很聰明的順便新增 sepc 檔案，但有時候我們會希望用到的時候再去建立即可，所以需要關閉就輸入以下指令。</p>

<p><code>/config/application.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">generators</span> <span class="k">do</span> <span class="o">|</span><span class="n">g</span><span class="o">|</span>
</span><span class='line'>  <span class="n">g</span><span class="o">.</span><span class="n">view_specs</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">g</span><span class="o">.</span><span class="n">helper_specs</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">g</span><span class="o">.</span><span class="n">request_specs</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">g</span><span class="o">.</span><span class="n">controller_specs</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">g</span><span class="o">.</span><span class="n">routing_specs</span> <span class="kp">false</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Rspec</h1>

<h3>model</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span> <span class="c1">#必須載入才能使用裡面的方法</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">Post</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:model</span> <span class="k">do</span> <span class="c1">#RSpec 可省略</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;is accessible&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create!</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">post</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="no">Post</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;has title and content columns&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">columns</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">column_names</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>describe</code>, <code>context</code> 描述要測試的是什麼，可以用nested</li>
<li><code>it</code>, <code>specify</code>, <code>example</code> 就是⼀⼩段測試</li>
<li><code>expect(…).to</code> 或 <code>expect(…).to_not</code> 定義期望</li>
<li><code>eq</code> 預期的是否和自己設定的相等</li>
<li><code>include</code> 預期的是否有包括自己設定的值</li>
<li><code>describe</code> 和 <code>it</code> 前面加上 x 代表 pending，執行 rspec 就會先跳拓</li>
<li><a href="https://www.relishapp.com/rspec/rspec-expectations/v/3-4/docs/built-in-matchers/change-matcher">其他方法</a></li>
</ul>


<h3>Routing spec syntax</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="ss">:get</span> <span class="o">=&gt;</span> <span class="s2">&quot;/events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">route_to</span><span class="p">(</span><span class="s2">&quot;events#index&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">expect</span><span class="p">(</span><span class="ss">:get</span> <span class="o">=&gt;</span> <span class="s2">&quot;/widgets/1/edit&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_routable</span>
</span><span class='line'>
</span><span class='line'><span class="n">expect</span><span class="p">(</span><span class="ss">:get</span> <span class="o">=&gt;</span> <span class="s2">&quot;/posts/1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">route_to</span><span class="p">(</span>
</span><span class='line'>      <span class="ss">:controller</span> <span class="o">=&gt;</span> <span class="s2">&quot;posts&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s2">&quot;show&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;1&quot;</span>
</span><span class='line'>      <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Controller spec syntax</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">render_template</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span>
</span><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">events_url</span><span class="p">)</span>
</span><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">assigns</span><span class="p">(</span><span class="ss">:event</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_a_new</span><span class="p">(</span><span class="no">Event</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>View spec syntax</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">render</span>
</span><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;Title&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">render_template</span><span class="p">(</span><span class="ss">partial</span><span class="p">:</span> <span class="s2">&quot;_form&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Helper spec syntax</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">helper</span><span class="o">.</span><span class="n">your_method</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>request</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:request</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;GET /users&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">get</span> <span class="s2">&quot;/users&quot;</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">render_template</span><span class="p">(</span><span class="ss">:index</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;GET /user/:id&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">get</span> <span class="s2">&quot;/user&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_http_status</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">render_template</span><span class="p">(</span><span class="ss">:index</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>request 通常直接從網址進行 Get 或 Post ，接著判斷傳回來的值是否正確。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#也有 after(:each)，afte(:all)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>before(:each) 每段it之前執行</li>
<li>before(:all) 整段describe前只執行一次</li>
<li>after(:each) 每段it之後執行</li>
<li>after(:all) 整段describe後只執行一次</li>
<li>(:each) 可以不用加，預設為(:each)</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">){</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;hello&quot;</span><span class="p">)}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>相較於 before(:each) 可增加執⾏速度</li>
<li>有使⽤到才會運算(lazy)，並且在同⼀個 example 測試中多次呼叫會 Memoized 快取起來。</li>
<li>let! 則是⾮ lazy 版本</li>
</ul>


<h1>Stub</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">allow_any_instance_of</span><span class="p">(</span><span class="no">User</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:follow</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>用stub 假造 method，讓它忽略這個 method，或是指定回傳東西，可以避免在測試時，測試不必要的東西。</p>

<h1>factory_girl</h1>

<p>到 <code>spec/rails_helper.rb</code> 設定</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">FactoryGirl</span><span class="o">::</span><span class="no">Syntax</span><span class="o">::</span><span class="no">Methods</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 <code>spec</code> 底下新增 <code>factories</code> 資料夾，接著在裡面新增相對應的物件名稱，像是 <code>user.rb</code></p>

<p><code>spec/factories/user.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">factory</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="no">User</span><span class="s2">&quot; do</span>
</span><span class='line'><span class="s2">    name &quot;</span><span class="n">hello</span><span class="s2">&quot;</span>
</span><span class='line'><span class="s2">    age  18</span>
</span><span class='line'><span class="s2">    </span>
</span><span class='line'><span class="s2">    # 可以設定create 之後要做哪些動作</span>
</span><span class='line'><span class="s2">    after(:create) do |video|</span>
</span><span class='line'><span class="s2">      create(:photo, photo_id: photo.id)</span>
</span><span class='line'><span class="s2">      create(:photo, size: &quot;</span><span class="mi">500</span><span class="s2">&quot;, photo_id: photo.id)</span>
</span><span class='line'><span class="s2">      create(:photo, size: &quot;</span><span class="mi">800</span><span class="s2">&quot;, photo_id: photo.id)</span>
</span><span class='line'><span class="s2">    end</span>
</span><span class='line'><span class="s2">    </span>
</span><span class='line'><span class="s2">    # 也可以設定多種條件</span>
</span><span class='line'><span class="s2">    trait :child do</span>
</span><span class='line'><span class="s2">      age 6</span>
</span><span class='line'><span class="s2">      #after(:create) {|user| user.add_role(:admin) } </span>
</span><span class='line'><span class="s2">      #after(:build)  {|user| user.add_role(:admin) } </span>
</span><span class='line'><span class="s2">      # 也可以設定 create 之後的設定</span>
</span><span class='line'><span class="s2">    end</span>
</span><span class='line'><span class="s2">  end</span>
</span><span class='line'><span class="s2">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣在 spec 裡面就可以直接建立假資料</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@user</span>  <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="c1">#FactoryGirl 可省略</span>
</span><span class='line'>  <span class="vi">@child</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:child</span><span class="p">)</span> <span class="c1">#就只替換掉 age</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>為什麼要假物件?</h3>

<ul>
<li>無法控制回傳值的外部系統 (例如第三⽅ web service)</li>
<li>建構正確的回傳值很⿇煩 (例如得準備很多假資料)</li>
<li>可能很慢，拖慢測試速度 (例如耗時的運算)</li>
<li>有難以預測的回傳值 (例如亂數⽅法)</li>
<li>還沒開始實作 (特別是採⽤ TDD 流程)</li>
</ul>


<h1>Capybara</h1>

<p>RSpec除了可以拿來寫單元程式，我們也可以把測試的層級拉高做整合性測試，以Web應用程式來說，就是去自動化瀏覽器的操作，實際去向網站伺服器請求，然後驗證出來的HTML是正確的輸出。</p>

<p><a href="https://github.com/jnicklas/capybara">capybara</a>就是一套可以搭配的工具，用來模擬瀏覽器行為</p>

<h1>CI server</h1>

<p>CI(Continuous Integration)
伺服器的用處是每次有人Commit就會自動執行編譯及測試(Ruby不用編譯，所以主要的用處是跑測試)，並回報結果，如果有人送交的程式搞砸了回歸測試，馬上就有回饋可以知道。</p>

<p><a href="https://circleci.com">circleci.com</a></p>

<p>建立 <code>circle.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">machine</span><span class="p">:</span>
</span><span class='line'>  <span class="ss">timezone</span><span class="p">:</span>
</span><span class='line'>    <span class="no">Asia</span><span class="o">/</span><span class="no">Taipei</span>
</span><span class='line'>  <span class="ss">ruby</span><span class="p">:</span>
</span><span class='line'>    <span class="ss">version</span><span class="p">:</span> <span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">2</span>
</span><span class='line'><span class="ss">dependencies</span><span class="p">:</span>
</span><span class='line'>  <span class="ss">pre</span><span class="p">:</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">rvm</span> <span class="n">use</span> <span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">2</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">bundler</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">rubocop</span>
</span><span class='line'>  <span class="ss">post</span><span class="p">:</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">gem</span> <span class="n">update</span> <span class="n">rake</span>
</span><span class='line'><span class="ss">database</span><span class="p">:</span>
</span><span class='line'>  <span class="ss">override</span><span class="p">:</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">cp</span> <span class="n">config</span><span class="o">/</span><span class="n">database</span><span class="o">.</span><span class="n">yml</span><span class="o">.</span><span class="n">example</span> <span class="n">config</span><span class="o">/</span><span class="n">database</span><span class="o">.</span><span class="n">yml</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">create</span> <span class="ss">db</span><span class="p">:</span><span class="n">migrate</span> <span class="o">--</span><span class="n">trace</span>
</span><span class='line'><span class="nb">test</span><span class="p">:</span>
</span><span class='line'>  <span class="ss">override</span><span class="p">:</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rspec</span> <span class="o">--</span><span class="n">color</span>
</span></code></pre></td></tr></table></div></figure>


<p>建立 <code>config/database.yml.example</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">default</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">default</span>
</span><span class='line'>  <span class="ss">adapter</span><span class="p">:</span> <span class="n">mysql2</span>
</span><span class='line'>  <span class="ss">encoding</span><span class="p">:</span> <span class="n">utf8</span>
</span><span class='line'>  <span class="ss">host</span><span class="p">:</span> <span class="n">localhost</span>
</span><span class='line'>  <span class="ss">username</span><span class="p">:</span>
</span><span class='line'>  <span class="ss">password</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="nb">test</span><span class="p">:</span>
</span><span class='line'>  <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">default</span>
</span><span class='line'>  <span class="ss">database</span><span class="p">:</span> <span class="n">test_db</span>
</span><span class='line'>
</span><span class='line'><span class="ss">development</span><span class="p">:</span>
</span><span class='line'>  <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">default</span>
</span><span class='line'>  <span class="ss">database</span><span class="p">:</span> <span class="n">development_db</span>
</span><span class='line'>
</span><span class='line'><span class="ss">production</span><span class="p">:</span>
</span><span class='line'>  <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">default</span>
</span><span class='line'>  <span class="ss">database</span><span class="p">:</span> <span class="n">production_db</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著到 <a href="https://circleci.com">circleci.com</a> 和 github 帳號做連結。<br/>
接著將要跑的 project 加進去，之後只要 push 到 github 就會自動跑了！</p>

<h1>大師引言</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">大部份都是寫</span><span class="n">model</span><span class="err">的測試</span>
</span><span class='line'><span class="n">controller</span><span class="err">偶爾會寫</span>
</span><span class='line'>
</span><span class='line'><span class="err">其他的因為後面有驗收測試也會測試到，所以不浪費時間去寫測試</span>
</span><span class='line'><span class="err">驗收測試多半是測試子路徑，不會測到所有的條件，所以個別的小項測試，就直接在</span><span class="n">model</span><span class="err">寫就好了</span>
</span><span class='line'>
</span><span class='line'><span class="err">工程是寫到</span><span class="n">request</span><span class="err">就很棒了</span>
</span><span class='line'><span class="n">feature</span> <span class="err">比較像是</span><span class="no">QA</span><span class="err">在寫的</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://betterspecs.org/">Better Specs</a><br/>
<a href="https://www.relishapp.com/">Relish</a></p>

<p>Gem：<br/>
<a href="https://github.com/rspec/rspec-rails">rspec-rails</a><br/>
<a href="https://github.com/thoughtbot/factory_girl_rails">factory_girl_rails</a>  <br/>
<a href="https://github.com/guard/guard-rspec">guard-rspec</a><br/>
<a href="https://github.com/jnicklas/capybara">capybara</a></p>

<p>參考文件：<br/>
<a href="https://ihower.tw/rails4/testing.html">自動化測試</a><br/>
<a href="http://motion-express.com/trainings/rspec-rails-1">RSpec-Rails (基礎篇)</a><br/>
<a href="http://motion-express.com/blog/20150320-custom-helpers-in-rspec">RSpec-Rails當中自訂methods及helpers</a><br/>
<a href="http://motion-express.com/blog/20150327-rspec-rails-testing-module">RSpec-Rails 針對module進行unit test</a><br/>
<a href="http://www.slideshare.net/ihower/rspec-7394497">RSpec 讓你愛上寫測試</a><br/>
<a href="https://blog.alphacamp.co/2015/03/02/tdd-kata/">程式設計師升級必練內功：TDD Kata</a><br/>
<a href="https://codility.com/programmers/lessons/">codility 練習</a><br/>
<a href="http://www.sportcalculators.com/bowling-score-calculator">保齡球練習</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Carrierwave + FFMPEG 影片轉檔]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/29/carrierwavea-plus-ffmpeg/"/>
    <updated>2016-01-29T20:26:02+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/29/carrierwavea-plus-ffmpeg</id>
    <content type="html"><![CDATA[<p>若是上傳的檔案是影片，並且要對影片做其他處理，就可以使用 FFMPRG 來處理。</p>

<!-- more -->


<p></p>

<h1>電腦先安裝ffmpeg</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install ffmpeg</span></code></pre></td></tr></table></div></figure>


<h1>Gem</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;carrierwave&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;streamio-ffmpeg&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>設定</h1>

<p><code>application.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;carrierwave&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>lib/carrierwave/ffmpeg.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;streamio-ffmpeg&#39;</span>
</span><span class='line'><span class="k">module</span> <span class="nn">CarrierWave</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">FFMPEG</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="n">bitrate</span><span class="p">)</span>
</span><span class='line'>        <span class="n">process</span> <span class="ss">:resample</span> <span class="o">=&gt;</span> <span class="n">bitrate</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="n">bitrate</span><span class="p">)</span>
</span><span class='line'>      <span class="n">directory</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span>
</span><span class='line'>      <span class="n">tmpfile</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;tmpfile&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">FileUtils</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span> <span class="n">current_path</span><span class="p">,</span> <span class="n">tmpfile</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">file</span> <span class="o">=</span> <span class="o">::</span><span class="no">FFMPEG</span><span class="o">::</span><span class="no">Movie</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
</span><span class='line'>      <span class="n">file</span><span class="o">.</span><span class="n">transcode</span><span class="p">(</span><span class="n">current_path</span><span class="p">,</span> <span class="ss">video_bitrate</span><span class="p">:</span> <span class="n">bitrate</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>app/uploaders/video_uploader.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;carrierwave&quot;</span><span class="p">,</span> <span class="s2">&quot;ffmpeg&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">VideoUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">FFMPEG</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">store_dir</span>
</span><span class='line'>    <span class="s2">&quot;uploads/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">extension_white_list</span>
</span><span class='line'>    <span class="sx">%w(mp4 flv)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">version</span> <span class="ss">:bitrate_800k</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">process</span> <span class="ss">:resample</span> <span class="o">=&gt;</span> <span class="s2">&quot;800k&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">version</span> <span class="ss">:bitrate_500k</span><span class="p">,</span> <span class="ss">from_version</span><span class="p">:</span> <span class="ss">:bitrate_800k</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">process</span> <span class="ss">:resample</span> <span class="o">=&gt;</span> <span class="s2">&quot;500k&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>FFMPEG</h1>

<p>也可以用 ruby 直接下 ffmpef 的指令</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">y</span> <span class="o">-</span><span class="n">i</span> <span class="c1">#{input_path} -vf &quot;scale=ceil(oh*a):480&quot; -vcodec libx264 -preset:v slow -pix_fmt yuv420p -profile:v baseline -level 3.0 -b #{bitrate} -r 29.97 -acodec libvo_aacenc -ac 2 -ar 44100 -ab 64k -movflags faststart #{output_path}</span>
</span></code></pre></td></tr></table></div></figure>


<p>縮圖</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="c1">#{input} -ss 00:00:05 -vframes 1 #{thumbnil}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Calling shell commands from Ruby</h1>

<ol>
<li>Kernel#`, commonly called backticks – <code>cmd</code></li>
</ol>


<p>Returns the result of the shell command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">value</span> <span class="o">=</span> <span class="sb">`echo &#39;hi&#39;`</span>
</span><span class='line'><span class="n">value</span> <span class="o">=</span> <span class="sb">`</span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Built-in syntax, <code>%x( cmd )</code></li>
</ol>


<p>Returns the result of the shell command, just like the backticks.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">value</span> <span class="o">=</span> <span class="sx">%x( echo &#39;hi&#39; )</span>
</span><span class='line'><span class="n">value</span> <span class="o">=</span> <span class="sx">%x[ </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="sx"> ]</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Kernel# <code>system</code></li>
</ol>


<p>Return: true if the command was found and ran successfully, false otherwise</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">wasGood</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span> <span class="s2">&quot;echo &#39;hi&#39;&quot;</span> <span class="p">)</span>
</span><span class='line'><span class="n">wasGood</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span> <span class="n">cmd</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Kernel#exec</li>
</ol>


<p>Return: none, the current process is replaced and never continues</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">exec</span><span class="p">(</span> <span class="s2">&quot;echo &#39;hi&#39;&quot;</span> <span class="p">)</span>
</span><span class='line'><span class="nb">exec</span><span class="p">(</span> <span class="n">cmd</span> <span class="p">)</span> <span class="c1"># Note: this will never be reached because of the line above</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="https://github.com/carrierwaveuploader/carrierwave">carrierwave</a><br/>
<a href="https://github.com/streamio/streamio-ffmpeg">streamio-ffmpeg</a><br/>
<a href="https://www.ffmpeg.org/">FFMPEG</a><br/>
<a href="http://ruby-doc.org/core-2.3.0/Kernel.html">Kernel</a></p>

<p>參考文件：<br/>
<a href="http://www.freezzo.com/2010/12/23/create-ffmpeg-processor-for-carrierwave-in-rails-3/">Create FFMPEG processor for Carrierwave in Rails 3</a><br/>
<a href="https://prograils.com/posts/carrierwave-basic-video-conversion">CarrierWave - basic video conversion</a><br/>
<a href="http://stackoverflow.com/questions/3159945/running-command-line-commands-within-ruby-script">Running command line commands within Ruby script</a><br/>
<a href="http://stackoverflow.com/questions/2232/calling-shell-commands-from-ruby">Calling shell commands from Ruby</a><br/>
<a href="http://tech.natemurray.com/2007/03/ruby-shell-commands.html">6 Ways to Run Shell Commands in Ruby Tuesday</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Rubocop 寫出好風格]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/22/rubocop/"/>
    <updated>2016-01-22T22:39:47+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/22/rubocop</id>
    <content type="html"><![CDATA[<p>rubocop 像是一個程式評量工具，會告知在 rails 中的寫法，要如何才會比較好!</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="n">install</span> <span class="n">rubocop</span>
</span></code></pre></td></tr></table></div></figure>


<p>指令</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rubocop</span> <span class="n">app</span> <span class="n">spec</span> <span class="n">lib</span><span class="o">/</span><span class="n">something</span><span class="o">.</span><span class="n">rb</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/bbatsov/rubocop">rubocop</a></p>

<p>參考文件：
<a href="https://blog.alphacamp.co/2015/12/24/how-to-use-rubocop-in-rails-project/">如何在Rails專案中使用Rubocop統一程式風格？</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Carrierwave 輕鬆做上傳檔案功能]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/22/carrierwave/"/>
    <updated>2016-01-22T22:12:46+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/22/carrierwave</id>
    <content type="html"><![CDATA[<p>另一個上傳檔案的 gem ，相當的實用，和 Paperclip 擇一即可。</p>

<!-- more -->


<h1>安裝</h1>

<p>Gemfile</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;carrierwave&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;rmagick&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># or gem &quot;mini_magick&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>carrierwave 上傳檔案</li>
<li>rmagick 處理圖片</li>
</ul>


<blockquote><p>必須有安裝 ImageMagick 才能使用 rmagick</p></blockquote>

<p>有 homebrew 可以直接</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">imagemagick</span>
</span></code></pre></td></tr></table></div></figure>


<h1>設定</h1>

<p>先建立資料夾，主要用來存放所有的檔案</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">generate</span> <span class="n">uploader</span> <span class="n">file</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著在在要存放的 model 新增一筆欄位</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">generate</span> <span class="n">migration</span> <span class="n">add_file_to_products</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Model</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">mount_uploader</span> <span class="ss">:file</span><span class="p">,</span> <span class="no">FileUploader</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最後記得再 strong params 加入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="kp">private</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">product_params</span>
</span><span class='line'>    <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:file</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Form</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= form_for @product do |f| %&gt;</span>
</span><span class='line'><span class="sx">  &lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:file</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;%= f.submit &quot;Submit&quot; %&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>view</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">image_tag</span> <span class="vi">@product</span><span class="o">.</span><span class="n">image_url</span><span class="o">.</span><span class="n">to_s</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>imageurl是預設的helper，to_s是要確定把上傳的路徑轉變為字串，以免發生錯誤。</p>

<h1>RMagick</h1>

<p><code>app/uploaders/file_uploader.rb</code></p>

<p>可以將設定打開，有 RMagick 和 MiniMagick ，都是用來縮圖的。(擇一即可)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Include RMagick or MiniMagick support:</span>
</span><span class='line'><span class="c1"># include CarrierWave::RMagick</span>
</span><span class='line'><span class="c1"># include CarrierWave::MiniMagick</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面把註解拿掉就可以使用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Create</span> <span class="n">different</span> <span class="n">versions</span> <span class="n">of</span> <span class="n">your</span> <span class="n">uploaded</span> <span class="ss">files</span><span class="p">:</span>
</span><span class='line'><span class="n">version</span> <span class="ss">:thumb</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">process</span> <span class="ss">:resize_to_fit</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>之後再 view 中只要指定，就會去抓取縮小後的圖檔</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">image_tag</span> <span class="vi">@product</span><span class="o">.</span><span class="n">image_url</span><span class="p">(</span><span class="ss">:thumb</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>其他</h1>

<p>限制存取大小<br/>
<a href="https://github.com/carrierwaveuploader/carrierwave/wiki/How-to:-Validate-attachment-file-size">How to: Validate attachment file size</a></p>

<p>存取圖片長寬<br/>
<a href="https://github.com/carrierwaveuploader/carrierwave/wiki/How-to:-Get-image-dimensions">How to: Get image dimensions</a></p>

<p>存取圖片大小和類型<br/>
<a href="https://github.com/carrierwaveuploader/carrierwave/wiki/How-to:-Store-the-uploaded-file-size-and-content-type">How to: Store the uploaded file size and content type</a></p>

<p>官方文件：<br/>
<a href="https://github.com/carrierwaveuploader/carrierwave">carrierwave</a></p>

<p>參考資料：<br/>
<a href="http://motion-express.com/blog/20140708-ruby-gem-carrierwave">Ruby gem &lsquo;Carrierwave&rsquo; 上傳檔案神器的簡易安裝與使用</a><br/>
<a href="http://rubyist.marsz.tw/blog/2012-01-10/carrierwave-guides-with-amazon-s3-and-imagemagick-integration/">使用 Carrierwave 處理檔案上傳 (整合 imagemagick 與 Amazon S3)</a> <br/>
<a href="https://ruby-china.org/topics/4992">gem &lsquo;carrierwave'简易实用介绍</a><br/>
<a href="http://springok-blog.logdown.com/posts/2015/10/21/railsgem-how-to-use-carrierwave-upload-pictures">Rails如何使用Carrierwave上傳圖片</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Paperclip 輕鬆做上傳檔案功能]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/22/paperclip/"/>
    <updated>2016-01-22T22:12:20+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/22/paperclip</id>
    <content type="html"><![CDATA[<p>在網站中經常會需要用到上傳檔案功能
而 Paperclip 就是可以在上傳檔案這件事變得更加便利。</p>

<!-- more -->


<h1>安裝</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;paperclip&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>設定</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddAvatarColumnsToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">add_attachment</span> <span class="ss">:topics</span><span class="p">,</span> <span class="ss">:picture</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="n">remove_attachment</span> <span class="ss">:topics</span><span class="p">,</span> <span class="ss">:picture</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>attachment 會自動產生以下四個攔位</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">string</span>   <span class="s2">&quot;picture_file_name&quot;</span><span class="p">,</span>    <span class="ss">limit</span><span class="p">:</span> <span class="mi">255</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">string</span>   <span class="s2">&quot;picture_content_type&quot;</span><span class="p">,</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">255</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">integer</span>  <span class="s2">&quot;picture_file_size&quot;</span><span class="p">,</span>    <span class="ss">limit</span><span class="p">:</span> <span class="mi">4</span>
</span><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">datetime</span> <span class="s2">&quot;picture_updated_at&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Model</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_attached_file</span> <span class="ss">:picture</span><span class="p">,</span> <span class="ss">styles</span><span class="p">:</span> <span class="p">{</span> <span class="ss">medium</span><span class="p">:</span> <span class="s2">&quot;300x300&gt;&quot;</span><span class="p">,</span> <span class="ss">thumb</span><span class="p">:</span> <span class="s2">&quot;100x100&gt;&quot;</span> <span class="p">},</span> <span class="ss">default_url</span><span class="p">:</span> <span class="s2">&quot;/images/:style/missing.png&quot;</span>
</span><span class='line'>  <span class="n">validates_attachment_content_type</span> <span class="ss">:picture</span><span class="p">,</span> <span class="ss">content_type</span><span class="p">:</span> <span class="sr">/\Aimage\/.*\Z/</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Form</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= form_for @user, url: users_path, html: { multipart: true } do |form| %&gt;</span>
</span><span class='line'><span class="sx">  &lt;%=</span> <span class="n">form</span><span class="o">.</span><span class="n">file_field</span> <span class="ss">:picture</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;%=%&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% if </span><span class="vi">@user</span><span class="o">.</span><span class="n">picture</span><span class="o">.</span><span class="n">exist?</span><span class="sx">%&gt;</span>
</span><span class='line'><span class="sx"> &lt;%= check_box_tag “remove” ,”1”%&gt;</span> <span class="c1">#刪除按鈕</span>
</span><span class='line'><span class="o">&lt;%</span><span class="k">end</span><span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;% end %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在編輯的時候設定如果remove=1就設定圖片欄位為nil就會刪除</p>

<h3>controller</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:remove</span><span class="o">]==</span><span class="mi">1</span>
</span><span class='line'>    <span class="vi">@user</span><span class="o">.</span><span class="n">picture</span><span class="o">=</span><span class="kp">nil</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>View</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= image_tag @topic.picture.url %&gt;</span>
</span><span class='line'><span class="sx">&lt;%=</span> <span class="n">image_tag</span> <span class="vi">@topic</span><span class="o">.</span><span class="n">picture</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="ss">:medium</span><span class="p">)</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;%= image_tag @topic.picture.url(:thumb) %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>同時上傳多個檔案</h1>

<p>1-to-1 可以使用 <code>fields_for</code> 來達成，但若是 1-to-many ，則必須要搭配 JavaScript 協助動態增減欄位，動態加減數量。</p>

<p>可以使用以下 gem<br/>
<a href="https://github.com/ncri/nested_form_fields">nested_form_fields</a></p>

<p>(注意 Strong Parameter，這個 gem 的 README 沒提到)</p>

<h3>model</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:banners</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</span><span class='line'><span class="n">accepts_nested_attributes_for</span> <span class="ss">:banners</span><span class="p">,</span> <span class="ss">allow_destroy</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:reject_if</span> <span class="o">=&gt;</span> <span class="ss">:all_blank</span>
</span></code></pre></td></tr></table></div></figure>


<h3>strong params</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:company</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:banners_attributes</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:banner</span><span class="p">,</span> <span class="ss">:banner_alt</span><span class="p">,</span> <span class="ss">:_destroy</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>form</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="no">Banner</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'><span class="sr">    &lt;%= c.nested_fields_for :banners do |b| %&gt;</span>
</span><span class='line'><span class="sr">      &lt;div class=&quot;form-group&quot;&gt;</span>
</span><span class='line'><span class="sr">      &lt;%= b.file_field :banner%&gt;</span>
</span><span class='line'><span class="sr">      &lt;%= b.label :banner_alt, &quot;banner_alt&quot; %&gt;&lt;br&gt;</span>
</span><span class='line'><span class="sr">      &lt;%= b.text_field :banner_alt, :class=&gt;&quot;form-control&quot;%&gt;</span>
</span><span class='line'><span class="sr">      &lt;%= b.remove_nested_fields_link &#39;Remove me&#39;%&gt;</span>
</span><span class='line'><span class="sr">    &lt;% end %&gt;</span>
</span><span class='line'><span class="sr">    &lt;%=c.add_nested_fields_link :banners, &#39;新增Banner&#39;, :class =&gt; &quot;btn btn-default&quot;%&gt;</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>或是  <a href="https://github.com/nathanvda/cocoon">cocoon</a></p>

<h3>可參考之前的</h3>

<p><a href="http://mgleon08.github.io/blog/2015/12/13/ruby-on-rails-accepts-nested-attributes-for/">Ruby on Rails - Accepts_nested_attributes_for</a></p>

<p>官方文件：<br/>
<a href="https://github.com/thoughtbot/paperclip">paperclip</a><br/>
<a href="https://github.com/ncri/nested_form_fields">nested_form_fields</a><br/>
<a href="https://github.com/nathanvda/cocoon">cocoon</a></p>

<p>參考文件：<br/>
<a href="http://chouandy.logdown.com/posts/249554-use-paperclip-implement-any-format-file-uploading">使用 paperclip 實作任意格式檔案上傳</a><br/>
<a href="http://chouandy.logdown.com/posts/252165-use-paperclip-implement-any-format-file-uploading-to-aws-s3">使用 paperclip 實作任意格式檔案上傳至 AWS S3</a><br/>
<a href="http://blog.jex.tw/blog/2015/07/13/rails-upload/">Rails 上傳 Upload</a><br/>
<a href="http://www.railscook.com/recipes/multiple-files-upload-with-nested-resource-using-paperclip-in-rails/">Multiple files upload with nested resource using Paperclip in Rails</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[會員管理系統 Devise-Rolify-Cancan]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/21/devise-rolify-cancan/"/>
    <updated>2016-01-21T22:17:48+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/21/devise-rolify-cancan</id>
    <content type="html"><![CDATA[<p>Devise + Rolify + Cancancan</p>

<p>Devise    負責登入、註冊、退出等等，會員註冊登入流程<br/>
Rolify    負責給予角色<br/>
Cancancan 負責指定角色的權限，可以執行哪些 action</p>

<!-- more -->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'devise'
</span><span class='line'>gem 'rolify'
</span><span class='line'>gem 'cancancan'</span></code></pre></td></tr></table></div></figure>


<h1><a href="https://github.com/plataformatec/devise">Device</a></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">generate</span> <span class="ss">devise</span><span class="p">:</span><span class="n">install</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#create  config/initializers/devise.rb</span>
</span><span class='line'><span class="c1">#create  config/locales/devise.en.yml</span>
</span></code></pre></td></tr></table></div></figure>


<h3>接下來有幾個設定是 divice 建議設定的</h3>

<ul>
<li>確認 root 有設定到</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">root</span> <span class="s2">&quot;welcome#index&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>編輯 <code>config/environments/development.rb</code> 和 <code>production.rb</code> 加入寄信時預設的網站網址</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">&#39;localhost:3000&#39;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在 view 中 加入可以顯示 flash 的 code</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%</span><span class="k">if</span> <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">].</span><span class="n">present?</span><span class="sx">%&gt;</span>
</span><span class='line'><span class="sx"> &lt;div class=&quot;alert alert-success text-center&quot; role=&quot;notice&quot;&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="sx">%= flash[:notice] %&gt;</span>
</span><span class='line'><span class="sx"> &lt;/div&gt;</span>
</span><span class='line'><span class="sx">&lt;%end%&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">&lt;%if flash[:alert].present?%&gt;</span>
</span><span class='line'><span class="sx">    &lt;div class=</span><span class="s2">&quot;alert alert-danger text-center&quot;</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;%=</span> <span class="n">flash</span><span class="o">[</span><span class="ss">:alert</span><span class="o">]</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">    &lt;/div&gt;</span>
</span><span class='line'><span class="o">&lt;%</span><span class="k">end</span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>預設不會產生 devise 的 view，因此必須輸入以下指令，就可以去更改 view 的樣式。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">g</span> <span class="ss">devise</span><span class="p">:</span><span class="n">views</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#預設在 app/views/devise </span>
</span></code></pre></td></tr></table></div></figure>


<h3>產生 model</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">generate</span> <span class="n">devise</span> <span class="no">User</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#invoke  active_record</span>
</span><span class='line'><span class="c1">#create  db/migrate/20160117113653_add_devise_to_users.rb</span>
</span><span class='line'><span class="c1">#insert  app/models/user.rb</span>
</span><span class='line'><span class="c1">#route   devise_for :users</span>
</span></code></pre></td></tr></table></div></figure>


<p>models/user</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">rolify</span>
</span><span class='line'>  <span class="c1"># Include default devise modules. Others available are:</span>
</span><span class='line'>  <span class="c1"># :confirmable, :lockable, :timeoutable and :omniauthable</span>
</span><span class='line'>  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>裡面有些是預設沒打開的，像是寄認證信之類的，需要再打開設定就可以了，migration 也是。<br/>
也可以自行在 model 增加欄位，因為預設的可能是比較基本的。</p>

<h3>驗證</h3>

<p>在需要登入的 controller 加上</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before_action</span> <span class="ss">:authenticate_user!</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 view 中加入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% if </span><span class="n">current_user</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx"> &lt;%= link_to(&#39;登出&#39;, destroy_user_session_path, :method =&gt;</span> <span class="ss">:delete</span><span class="p">)</span> <span class="sx">%&gt; </span>
</span><span class='line'><span class="sx"> |</span>
</span><span class='line'><span class="sx"> &lt;%= link_to(&#39;修改密碼&#39;, edit_registration_path(:user)) %&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% else %&gt;</span>
</span><span class='line'><span class="sx"> &lt;%= link_to(&#39;註冊&#39;, new_registration_path(:user)) %&gt;</span>
</span><span class='line'>  <span class="o">|</span>
</span><span class='line'>  <span class="o">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s1">&#39;登入&#39;</span><span class="p">,</span> <span class="n">new_session_path</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;% end %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>編輯 <code>application_controller.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:configure_permitted_parameters</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="ss">:devise_controller?</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">configure_permitted_parameters</span>
</span><span class='line'>    <span class="n">devise_parameter_sanitizer</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:sign_up</span><span class="p">,</span> <span class="ss">keys</span><span class="p">:</span> <span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>串接社群登入 Authentication: 使用 Omniauth</h3>

<p><a href="https://github.com/mkdynamic/omniauth-facebook">omniauth-facebook</a><br/>
<a href="http://www.rubydoc.info/gems/omniauth-google-oauth2/0.2.5/frames">omniauth-google-oauth2</a><br/>
<a href="https://github.com/timbreitkreutz/omniauth-yahoo">omniauth-yahoo</a> <br/>
<a href="https://github.com/intridea/omniauth-github">omniauth-github</a></p>

<h1><a href="https://github.com/RolifyCommunity/rolify">Rolify</a></h1>

<p>產生權限的 modle 和設定檔</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">generate</span> <span class="n">rolify</span> <span class="no">Role</span> <span class="no">User</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#invoke  active_record</span>
</span><span class='line'><span class="c1">#create  app/models/role.rb</span>
</span><span class='line'><span class="c1">#insert  app/models/role.rb</span>
</span><span class='line'><span class="c1">#create  db/migrate/20160117114226_rolify_create_roles.rb</span>
</span><span class='line'><span class="c1">#insert  app/models/user.rb</span>
</span><span class='line'><span class="c1">#create  config/initializers/rolify.rb</span>
</span></code></pre></td></tr></table></div></figure>


<p>新增權限</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">add_role</span> <span class="ss">:admin</span>
</span></code></pre></td></tr></table></div></figure>


<p>移除權限</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">remove_role</span> <span class="ss">:admin</span>
</span></code></pre></td></tr></table></div></figure>


<p>判斷權限</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">has_role?</span> <span class="ss">:admin</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>找擁有權限的人</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">with_role</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
</span><span class='line'><span class="c1">#找單一權限</span>
</span><span class='line'>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">with_any_role</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">)</span>
</span><span class='line'><span class="c1">#找 a or b 權限</span>
</span><span class='line'>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">with_all_roles</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">)</span>
</span><span class='line'><span class="c1">#找 a + b 權限</span>
</span></code></pre></td></tr></table></div></figure>


<h3>對 resource 設定角色權限</h3>

<p>可以直接指定這個權限可以進入哪些 resource</p>

<p>先在要設定的 model 裡</p>

<blockquote><p>In the resource models you want to apply roles on, just add resourcify method. For example, on this ActiveRecord class:</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Forum</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">resourcify</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣就可以設定自己才可以看到自己的資料</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">add_role</span> <span class="ss">:moderator</span><span class="p">,</span> <span class="no">Forum</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="c1">#設定為第一個 Forum 的 resource</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">has_role?</span> <span class="ss">:moderator</span><span class="p">,</span> <span class="no">Forum</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">has_role?</span> <span class="ss">:moderator</span><span class="p">,</span> <span class="no">Forum</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'><span class="c1">#=&gt; false</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">add_role</span> <span class="ss">:moderator</span><span class="p">,</span> <span class="no">Forum</span>
</span><span class='line'><span class="c1">#設定為所有的 Forum 的 resource</span>
</span></code></pre></td></tr></table></div></figure>


<h3>resource 角色權限查詢</h3>

<p>Instance level</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">forum</span> <span class="o">=</span> <span class="no">Forum</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">forum</span><span class="o">.</span><span class="n">roles</span>
</span><span class='line'><span class="c1"># =&gt; [ list of roles that are only binded to forum instance ]</span>
</span><span class='line'><span class="n">forum</span><span class="o">.</span><span class="n">applied_roles</span>
</span><span class='line'><span class="c1"># =&gt; [ list of roles binded to forum instance and to the Forum class ]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Class level</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Forum</span><span class="o">.</span><span class="n">with_role</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [ list of Forum instances that has role &quot;admin&quot; binded to it ]</span>
</span><span class='line'><span class="no">Forum</span><span class="o">.</span><span class="n">with_role</span><span class="p">(</span><span class="ss">:admin</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [ list of Forum instances that has role &quot;admin&quot; binded to it and belongs to current_user roles ]</span>
</span><span class='line'><span class="no">Forum</span><span class="o">.</span><span class="n">with_roles</span><span class="p">(</span><span class="o">[</span><span class="ss">:admin</span><span class="p">,</span> <span class="ss">:user</span><span class="o">]</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [ list of Forum instances that has role &quot;admin&quot; or &quot;user&quot; binded to it and belongs to current_user roles ]</span>
</span><span class='line'>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">with_any_role</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [ list of User instances that has role &quot;admin&quot; or &quot;user&quot; binded to it ]</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">with_role</span><span class="p">(</span><span class="ss">:site_admin</span><span class="p">,</span> <span class="n">current_site</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [ list of User instances that have a scoped role of &quot;site_admin&quot; to a site instance ]</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">with_role</span><span class="p">(</span><span class="ss">:site_admin</span><span class="p">,</span> <span class="ss">:any</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [ list of User instances that have a scoped role of &quot;site_admin&quot; for any site instances ]</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">with_all_roles</span><span class="p">(</span><span class="ss">:site_admin</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [ list of User instances that have a role of &quot;site_admin&quot; and a role of &quot;admin&quot; binded to it ]</span>
</span><span class='line'>
</span><span class='line'><span class="no">Forum</span><span class="o">.</span><span class="n">find_roles</span>
</span><span class='line'><span class="c1"># =&gt; [ list of roles that binded to any Forum instance or to the Forum class ]</span>
</span><span class='line'><span class="no">Forum</span><span class="o">.</span><span class="n">find_roles</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [ list of roles that binded to any Forum instance or to the Forum class with &quot;admin&quot; as a role name ]</span>
</span><span class='line'><span class="no">Forum</span><span class="o">.</span><span class="n">find_roles</span><span class="p">(</span><span class="ss">:admin</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [ list of roles that binded to any Forum instance or to the Forum class with &quot;admin&quot; as a role name and belongs to current_user roles ]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Callbacks</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">rolify</span> <span class="ss">:before_add</span> <span class="o">=&gt;</span> <span class="ss">:before_add_method</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">before_add_method</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># do something before it gets added</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#四種 callbacks</span>
</span><span class='line'><span class="c1">#before_add</span>
</span><span class='line'><span class="c1">#after_add</span>
</span><span class='line'><span class="c1">#before_remove</span>
</span><span class='line'><span class="c1">#after_remove</span>
</span></code></pre></td></tr></table></div></figure>


<h1><a href="https://github.com/CanCanCommunity/cancancan">Cancancan</a></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">generate</span> <span class="ss">cancan</span><span class="p">:</span><span class="n">ability</span>
</span><span class='line'><span class="c1">#create  app/models/ability.rb</span>
</span></code></pre></td></tr></table></div></figure>


<p>ability.rb 主要是定義，每個角色擁有哪些權限，並在 view 或 controller ，設定條件時，就會到這邊去查看，是否符合此條件。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/models/ability.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Ability</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">Ability</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="c1">#這個 user 其實就是 devise 提供的 current_user</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">blank?</span> <span class="c1"># not logged in</span>
</span><span class='line'>      <span class="n">can</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span><span class="p">,</span> <span class="no">Forum</span> <span class="c1">#可以執行 Form Controller 裡的 new 和 create action</span>
</span><span class='line'>      <span class="n">cannot</span> <span class="o">[</span><span class="ss">:new</span><span class="o">]</span><span class="p">,</span> <span class="no">Comment</span>  <span class="c1">#無法執行 Comment Controller 裡的 new action</span>
</span><span class='line'>      <span class="n">basic_read_only</span> <span class="c1">#呼叫基本權限設定 Medthod</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">user</span><span class="o">.</span><span class="n">has_role?</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="c1">#如果 role 為 admin</span>
</span><span class='line'>      <span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="ss">:all</span> <span class="c1">#可管理所有資源</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">basic_read_only</span>
</span><span class='line'>    <span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Forum</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#:manage: 是指這個 controller 內所有的 action</span>
</span><span class='line'><span class="c1">#:read :  指 :index 和 :show</span>
</span><span class='line'><span class="c1">#:update: 指 :edit  和 :update</span>
</span><span class='line'><span class="c1">#:destroy:指 :destroy</span>
</span><span class='line'><span class="c1">#:create: 指 :new   和 :crate</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以這樣寫</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="o">[</span> <span class="no">Post</span><span class="p">,</span> <span class="no">Comment</span> <span class="o">]</span>
</span><span class='line'><span class="n">can</span> <span class="o">[</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:update</span> <span class="o">]</span><span class="p">,</span> <span class="o">[</span> <span class="no">Post</span><span class="p">,</span> <span class="no">Comment</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>自訂 Alias action</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">alias_action</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:modify</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:modify</span><span class="p">,</span> <span class="no">Comment</span>
</span></code></pre></td></tr></table></div></figure>


<p>自訂 method</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">basic_read_only</span>
</span><span class='line'>    <span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Forum</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>設定只能管理自己的post</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:update</span><span class="p">,</span> <span class="no">Post</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>    <span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">can</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="no">Post</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>    <span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 也可以這樣寫</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:update</span><span class="p">,</span>  <span class="no">Post</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="no">Post</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a href="https://github.com/CanCanCommunity/cancancan/wiki/Authorizing-controller-actions">Authorizing controller actions</a></h3>

<p>load_and_authorized_resource</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">load_and_authorize_resource</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">discontinue</span>
</span><span class='line'>    <span class="c1"># Automatically does the following:</span>
</span><span class='line'>    <span class="c1"># @product = Product.find(params[:id])</span>
</span><span class='line'>    <span class="c1"># authorize! :discontinue, @product</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#指定 action</span>
</span><span class='line'><span class="c1">#load_and_authorize_resource :only =&gt; [:index, :show]</span>
</span></code></pre></td></tr></table></div></figure>


<p>這個指令做了兩件事情</p>

<ul>
<li>load_resource</li>
</ul>


<p>主要是可以自動加入 @instance ， 預設跟 Class 名稱相同，Article => @article</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">load_resource</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="c1"># @article automatically set to Article.find(params[:id])</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>等於</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>authorize_resource</li>
</ul>


<p>代表將這個 Controller 加入權限的控制，並去 <code>model/ability.rb</code> 裡面判斷權限是否有效?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">authorize_resource</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以針對每個 action 去做設定</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>  <span class="vi">@project</span> <span class="o">=</span> <span class="no">Project</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:project</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">authorize!</span> <span class="ss">:show</span><span class="p">,</span> <span class="vi">@project</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>cancancan預設 ＠instance 變數 與 Controller Name 相同<br/>
若＠instance變數 不為 Controller Name，
設定控管時須加入 &ldquo;變數名稱&rdquo;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">TopicController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'> <span class="n">authorize_resource</span> <span class="ss">:post</span> <span class="c1">#變數名稱</span>
</span><span class='line'>
</span><span class='line'> <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Topic</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>  <span class="c1">#預設為 @topic</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#model/ability.rb 裡面要這樣下</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span>   <span class="no">Post</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:create</span><span class="p">,</span> <span class="no">Post</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:update</span><span class="p">,</span> <span class="no">Post</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://github.com/CanCanCommunity/cancancan/wiki/Ensure-Authorization">check_authorization</a></li>
</ul>


<p>確保controller 都有加入授權管理</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">check_authorization</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>if can?</h3>

<p>會根據 <code>model/ability.rb</code> 去判斷是否有權限，並顯示。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% if </span><span class="n">can?</span> <span class="ss">:create</span><span class="p">,</span> <span class="no">Project</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;%= link_to &quot;New Project&quot;, new_project_path %&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>例外處理<a href="https://github.com/CanCanCommunity/cancancan/wiki/Exception-Handling">Exception-Handling</a></h3>

<p>若 user 無權限進入， cancancan 會噴出一個 CanCan::AccessDenied exception。<br/>
但那樣子比較不好看，所以我們要另外重新導向一個顯示無權限的頁面。</p>

<blockquote><p><code>authorize_resource</code> or <code>authorize!</code> 才會丟例外。</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#application_controller.rb</span>
</span><span class='line'><span class="n">rescue_from</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">AccessDenied</span> <span class="k">do</span> <span class="o">|</span><span class="n">exception</span><span class="o">|</span>
</span><span class='line'>  <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:alert</span> <span class="o">=&gt;</span> <span class="n">exception</span><span class="o">.</span><span class="n">messag</span> <span class="c1">#導向另一個頁面</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#render json: &quot;Authorization failed. 權限錯誤，請洽管理人員。</span>
</span><span class='line'><span class="c1">#render :file =&gt; &quot;#{Rails.root}/public/403.html&quot;, :status =&gt; 403, :layout =&gt; false</span>
</span><span class='line'><span class="c1">#respond_to do |format|</span>
</span><span class='line'>  <span class="c1">#format.json { render nothing: true, status: :forbidden }</span>
</span><span class='line'>  <span class="c1">#format.html { redirect_to main_app.root_url, :alert =&gt; exception.message }</span>
</span><span class='line'><span class="c1">#end</span>
</span></code></pre></td></tr></table></div></figure>


<p>gem：<br/>
<a href="https://github.com/plataformatec/devise">Device</a><br/>
<a href="https://github.com/CanCanCommunity/cancancan">Cancancan</a><br/>
<a href="https://github.com/RolifyCommunity/rolify">Rolify</a><br/>
<a href="https://github.com/RolifyCommunity/rolify/wiki/Devise---CanCanCan---rolify-Tutorial">Devise CanCanCan rolify Tutorial</a></p>

<p>參考文件：<br/>
<a href="http://disco26.logdown.com/posts/210475-devise-rolify-cancan">Devise + Rolify + Cancan</a><br/>
<a href="http://deveede.logdown.com/posts/206943-use-deviserolify-cancan-control-permissions">使用Devise＋Rolify + Cancan 控管權限</a><br/>
<a href="http://blog.jex.tw/blog/2015/04/12/rails-user/">Rails - Devise + Cancancan + Rolify</a><br/>
<a href="http://blog.xdite.net/posts/2012/07/30/cancan-rule-engine-authorization-based-library-1/">Cancan 實作角色權限設計的最佳實踐(1)</a><br/>
<a href="http://blog.xdite.net/posts/2012/07/30/cancan-rule-engine-authorization-based-library-2/">Cancan 實作角色權限設計的最佳實踐(2)</a><br/>
<a href="http://blog.xdite.net/posts/2012/07/30/cancan-rule-engine-authorization-based-library-3/">Cancan 實作角色權限設計的最佳實踐(3)</a><br/>
<a href="https://ihower.tw/rails4/auth.html">使用者認證</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby on Rails Staging 環境和部署]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/13/staging-server/"/>
    <updated>2016-01-13T22:59:11+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/13/staging-server</id>
    <content type="html"><![CDATA[<p>部署上 server 後，通常會需要在一個 staging server
在上線之前，先部署到 staging server ，以防一些本機測試不到的一些東西。</p>

<!-- more -->


<h1>新增environments/staging.rb</h1>

<p>新增 <code>config/environments/staging.rb</code> 環境設定
內容同 <code>config/environments/production.rb</code></p>

<h1>新增deploy/staging.rb</h1>

<p>新增   <code>config/deploy/staging.rb</code>
內容同 <code>config/deploy/production.rb</code></p>

<p>佈署 ip 看看是不是同一台伺服器</p>

<h1>server新增設定檔</h1>

<p>server 上新增 <code>/opt/nginx/conf/vhost/staging.conf</code> 設定檔，內容跟 production 用的 nginx 設定檔一樣
除了需要加一行 <code>rack_env staging;</code>  因為預設是 <code>rack_env prodcution;</code></p>

<h1>設定網址和部署目錄</h1>

<p>如果 staging 和 production 同一台 server 的話
網址(domain name)和佈署目錄得要不一樣：
上述的 nginx vhost 設定，裡面</p>

<ol>
<li>server_name 的網址要改</li>
<li>root 目錄位置要改</li>
</ol>


<h1>搬移指令</h1>

<p>將專案本來 <code>config/deploy.rb</code> 裡面的
<code>set :deploy_to, '/home/deploy/shopping'</code> 設定搬到
<code>config/deploy/staging.rb</code> 和 <code>config/deploy/production.rb</code>
並且改成不同目錄</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;/home/username/staging&#39;</span>
</span><span class='line'><span class="c1">#指定目錄</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s1">&#39;staging&#39;</span>
</span><span class='line'><span class="c1">#指定branch</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Push code to github</h1>

<p><code>git push</code></p>

<h1>檢查部署缺少什麼檔案</h1>

<p><code>cap staging deploy:check</code>
到 server 上新增 shared/config/database.yml 和 secrets.yml，注意 yml 第一層要改成 staging。</p>

<p>如果有其他 yml 設定也需要一併設定
(例如 facebook.yml 和 email.yml 裡面要多加 staging)</p>

<h1>新增staging資料庫</h1>

<p>在 server 上新增 staging 用的資料庫
<code>mysql -u root -p</code>
<code>CREATE DATABASE ["databasename"] CHARACTER SET utf8;</code></p>

<h1>部署</h1>

<p><code>cap staging deploy</code></p>

<h1>重開nginx</h1>

<p><code>sudo service nginx restart</code></p>

<p>參考文件：
<a href="http://pm.5fpro.com/projects/public-wiki/wiki/Rails_%E4%BD%88%E7%BD%B2">Rails 佈署</a>
<a href="https://ihower.tw/rails4/deployment.html">網站佈署</a>
<a href="http://blog.xdite.net/posts/2012/07/09/3-way-to-speedup-asset-pipeline">3 招實用 Asset Pipeline 加速術</a>
<a href="https://ruby-china.org/topics/18616">Capistrano 3 实现 Rails 自动化部署</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[遠端 Server 指令]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/12/remote-server/"/>
    <updated>2016-01-12T23:02:38+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/12/remote-server</id>
    <content type="html"><![CDATA[<p>當部署上 server 後，很多時候都要在 server 上另外打指令
但可能跟本地的會有稍稍不一樣，所以主要來記錄一下哪些指令</p>

<!--more-->


<h1>MySQL</h1>

<p><code>mysql -u root -p （輸入後會進入 mysql 的 console ）</code></p>

<p>mysql 指令參數</p>

<p><code>-h</code> &lt;- mysql server 位置 , 若沒有指定, 預設就是 localhost
<code>-u</code> &lt;- mysql user 帳號
<code>-p</code> &lt;- 輸入 mysql user 密碼</p>

<p>若先前已經設定密碼</p>

<p><code>mysqladmin -h mysql_server -u root -p password 新密碼</code></p>

<p>若是還沒有設定</p>

<p><code>mysqladmin -h mysql_server -u root password 新密碼</code></p>

<p><code>show databases</code>
可以看目前所有的資料庫</p>

<h1>看遠端log?</h1>

<p>nginx log 在 /opt/nginx/logs 下，要用 root 身分才能看</p>

<p>顯示最後500行log
<code>tail -n 500 log/production.log</code></p>

<p>直掛著顯示log
<code>tail -f log/production.log</code></p>

<h1>在遠端如何進 rails console?</h1>

<p><code>cd ~/your_project/current</code>
<code>bin/rails c production</code> 或 <code>bundle exec rails c production</code></p>

<h1>重開 nginx sudo</h1>

<p><code>service nginx restart</code></p>

<h1>重開遠端 rails 而不重開 nginx</h1>

<p>在遠端 <code>~/your_project/current</code> 下執行 <code>touch tmp/restart.txt</code></p>

<h1>在遠端跑 rake</h1>

<p><code>RAILS_ENV=production bin/rake db:seed</code></p>

<h3>siedekiq</h3>

<p>Sidekiq
<code>RAILS_ENV=production bundle exec sidekiq -q default -q mailers</code></p>

<p>重新啟動
<code>cap production sidekiq:start</code></p>

<p>監控 sidekiq 看有沒有死掉
<a href="https://mmonit.com/monit/">monit</a></p>

<h3>sitemap</h3>

<p><code>RAILS_ENV=production rake -s sitemap:refresh</code>
Sitemap
<code>RAILS_ENV=production bin/rake sitemap:refresh:no_ping</code></p>

<h1>看有沒有定期執行的程式</h1>

<p><code>crontab -e</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby on Rails - 用 Include 和 Join 避免 N+1 Query]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/10/ruby-on-rails-include-join-avoid-n-1-query/"/>
    <updated>2016-01-10T10:00:44+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/10/ruby-on-rails-include-join-avoid-n-1-query</id>
    <content type="html"><![CDATA[<p>在 <code>rails</code> 當中，因為 ORM (Object-relational mapping ) 的便利，可以很快速地建立起連結，但在這過程中，經常會發生 <code>N+1 query</code> 的問題，造成效能上的緩慢，因此要如何解決這個問題，是很重要的。</p>

<!--more-->


<h1>N+1 query</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># model</span>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActieRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:skills</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Skill</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># controller</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>  <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># view</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% @users.each </span><span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx"> &lt;%= user.skills %&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上的關聯，就是透過 <code>User</code> 和 <code>Post 的關聯</code> ，在 <code>view</code> 中一筆一筆去資料庫找相關的 <code>post</code> ，而這每一筆去資料庫的動作，就會有以下的查詢，然後造成 <code>N+1 query</code> 的問題。</p>

<p>N+1就是指說，迴圈中查詢 N 筆資料，加上一開始的第一筆。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Skill</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="sb">`skills`</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="sb">`skills`</span> <span class="no">WHERE</span> <span class="sb">`skills`</span><span class="o">.</span><span class="n">`user_id</span><span class="sb">` = 1</span>
</span><span class='line'><span class="sb">Skill Load (0.2ms)  SELECT `</span><span class="n">skills</span><span class="sb">`.* FROM `</span><span class="n">skills</span><span class="sb">` WHERE `</span><span class="n">skills</span><span class="sb">`.`</span><span class="n">user_id</span><span class="sb">` = 2</span>
</span><span class='line'><span class="sb">Skill Load (1.6ms)  SELECT `</span><span class="n">skills</span><span class="sb">`.* FROM `</span><span class="n">skills</span><span class="sb">` WHERE `</span><span class="n">skills</span><span class="sb">`.`</span><span class="n">user_id</span><span class="sb">` = 3</span>
</span></code></pre></td></tr></table></div></figure>


<p>因此要解決這個問題，就能使用以下方式。</p>

<h1>includes</h1>

<p><code>includes</code> 主要用於可以直接將相關連的資料，在同一筆查詢，一起撈出來</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:skills</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">SELECT</span> <span class="sb">`skills`</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="sb">`skills`</span> <span class="no">WHERE</span> <span class="sb">`skills`</span><span class="o">.</span><span class="n">`user_id</span><span class="sb">` IN (1, 2, 3)</span>
</span><span class='line'>
</span><span class='line'><span class="sb"># 回傳所有 User 和 關聯的 skills</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到後面有 <code>IN (1, 2, 3)</code>，就是將上面一筆一筆查詢，變成這種方式一次撈出來。這樣在 <code>view</code> 中執行 <code>user.skills</code> 就不會再去資料庫查詢，因為已經都先撈出來了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">也可以一次</span> <span class="n">includes</span> <span class="err">多個關聯</span>
</span><span class='line'>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">skills</span><span class="p">:</span> <span class="ss">:profile</span><span class="p">)</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">skills</span><span class="p">:</span> <span class="o">[</span><span class="ss">:cees</span><span class="p">,</span> <span class="ss">:dees</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>joins</h1>

<p><code>joins</code> 則是關聯其他資料庫，可以進行查詢，但並不會將關聯的資料拉出來。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:skills</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">User</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="sb">`users`</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="sb">`users`</span> <span class="no">INNER</span> <span class="no">JOIN</span> <span class="sb">`skills`</span> <span class="no">ON</span> <span class="sb">`skills`</span><span class="o">.</span><span class="n">`user_id</span><span class="sb">` = `</span><span class="n">users</span><span class="sb">`.`</span><span class="nb">id</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="sb">#回傳所有，有 skill 的 user</span>
</span><span class='line'><span class="sb">#因為同一個 user 可能有多個 skill ，這樣就會撈出重複的 user 出來 ， 一個 skill 一個 user，因此可以用 .uniq 來去除重複的資料。</span>
</span><span class='line'><span class="sb">#如果是一對一就不會有這個問題了</span>
</span></code></pre></td></tr></table></div></figure>


<p>回傳的是所有有 <code>skill</code> 的 <code>user</code>，但並不會將 <code>skill</code> 資料撈出來，只是去做比對，因此再用 <code>user.skills</code> ，一樣會去資料庫中撈出資料。</p>

<p>官方資料：
<a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a>
<a href="http://rails.ruby.tw/active_record_querying.html">Active Record 查詢</a></p>

<p>參考資料：
<a href="https://ihower.tw/rails4/performance.html">網站效能</a>
<a href="https://ihower.tw/rails4/activerecord-relationships.html">ActiveRecord - 資料表關聯</a>
<a href="http://motion-express.com/blog/20141028-rails-include-join-avoid-n-1-query">Rails使用 include 和 join 避免 N+1 query</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby on Rails - Json]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/09/ruby-on-rails-json/"/>
    <updated>2016-01-09T12:26:46+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/09/ruby-on-rails-json</id>
    <content type="html"><![CDATA[<p>JSON 是很經常是用到的格式，不管是和程式溝通或是交換資料。</p>

<!--more-->


<h1>什麼是 JSON</h1>

<p>JSON 是個以純文字為基底去儲存和傳送簡單結構資料，可以透過特定的格式去儲存任何資料(字串,數字,陣列,物件)，也可以透過物件或陣列來傳送較複雜的資料。</p>

<p>一旦建立了您的 JSON 資料，就可以非常簡單的跟其他程式溝通或交換資料，因為 JSON 就只是純文字個格式。</p>

<p>JSON 的優點如下:</p>

<ul>
<li>相容性高</li>
<li>格式容易瞭解，閱讀及修改方便</li>
<li>支援許多資料格式 (number,string,booleans,nulls,array,associative array)</li>
<li>許多程式都支援函式庫讀取或修改 JSON 資料</li>
</ul>


<p>參考文件：
<a href="https://blog.wu-boy.com/2011/04/%E4%BD%A0%E4%B8%8D%E5%8F%AF%E4%B8%8D%E7%9F%A5%E7%9A%84-json-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9/">你不可不知的 JSON 基本介紹</a></p>

<h1>Rails 如何傳遞JSON</h1>

<h3>respond_to</h3>

<p>在 <code>rails</code> 當中可以用 <code>respond_to</code> 設定回傳的 <code>format</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="ss">:back</span> <span class="p">}</span>
</span><span class='line'>  <span class="nb">format</span><span class="o">.</span><span class="n">json</span>
</span><span class='line'>  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#也可以寫成單行</span>
</span><span class='line'><span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span><span class="p">,</span> <span class="ss">:js</span>
</span></code></pre></td></tr></table></div></figure>


<p>若後面沒指定會去找 <code>view</code> 中，後面是 <code>.json</code> 或 <code>.js</code> 的檔案
但記得因為 <code>format</code> 有三種，所以要 json 資料的話就在網址後面加 <code>.json</code></p>

<p>respond_to可以用來回應不同的資料格式。Rails內建支援格式包括有
<code>:html, :text, :js, :css, :ics, :csv, :xml, :rss, :atom, :yaml, :json</code></p>

<blockquote><p>如果需要擴充，可以編輯config/initializers/mime_types.rb這個檔案</p></blockquote>

<h3>render</h3>

<p>可以簡單使用 <code>render json</code> 的方式，直接強制 html 輸出成 json 格式
<code>render json: User.info</code>
這樣連view都不需要，就會直接顯示。</p>

<p>或是直接 <code>render template</code> 指定輸出 json 格式
<code>render template: "api/users/index.json.jbuilder"</code></p>

<h3>routes scope設定，指定controller使用json格式輸出</h3>

<p>最後是直接設定好 <code>routes</code> 的 <code>default</code> 格式，這樣就不用再指定要 <code>render</code> 什麼!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">scope</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">&#39;/api/v1/&#39;</span><span class="p">,</span> <span class="ss">:defaults</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="ss">:json</span> <span class="p">},</span> <span class="ss">:module</span> <span class="o">=&gt;</span> <span class="s2">&quot;api_v1&quot;</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="s1">&#39;v1&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">resources</span> <span class="ss">:users</span> <span class="c1">#ApiV1::CompaniesController</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>path</code>：指令網址前面的路徑
<code>defaults</code>：指定default的格式
<code>module</code>：指定 controller 會是 ApiV1::UsersController
<code>as</code>：產生URL helper</p>

<p>參考文件：
<a href="https://ihower.tw/rails4/routing.html">Scope</a>
<a href="http://motion-express.com/blog/20141124-rails-default-render-json">Rails修改預設顯示格式為json</a></p>

<h1>搭配gem - <a href="https://github.com/rails/jbuilder">jbuilder</a></h1>

<p>再rails當中，很常會用這個 <code>gem</code> 來轉 <code>json</code></p>

<p>像是剛才的<code>render template: "api/users/index.json.jbuilder"</code>
就會去找這個 template，並且像是 <code>html.erb</code> 一樣可以直接使用 <code>@</code> 的參數。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#api/users/index.json.jbuilder</span>
</span><span class='line'>
</span><span class='line'><span class="n">json</span><span class="o">.</span><span class="n">info</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">json</span><span class="o">.</span><span class="n">number</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">json</span><span class="o">.</span><span class="n">total</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">json</span><span class="o">.</span><span class="n">data</span> <span class="vi">@users</span> <span class="k">do</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span>
</span><span class='line'>    <span class="n">json</span><span class="o">.</span><span class="n">id</span> <span class="n">u</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>    <span class="n">json</span><span class="o">.</span><span class="n">name</span> <span class="n">u</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>就會生產出以下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#json</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="o">[</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;abc&quot;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="o">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>接收JSON</h1>

<p>可以用 <a href="https://github.com/rest-client/rest-client">rest-client</a> 這個gem
先用 <code>get</code> 取得資料，再用 <code>JSON.parse</code> 來將 <code>string</code> 解析成 <code>hash</code></p>

<p>範例： <a href="http://data.taipei/opendata/datalist/apiAccess?scope=resourceAquire&amp;rid=ddb80380-f1b3-4f8e-8016-7ed9cba571d5">Ubike</a> 資料，並存取到資料庫。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lib/tasks/dev.rake</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:dev</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:fetch_ubike</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;fetching ubike&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://data.taipei/opendata/datalist/apiAccess?scope=resourceAquire&amp;rid=ddb80380-f1b3-4f8e-8016-7ed9cba571d5&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">raw_content</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="n">raw_content</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">data</span><span class="o">[</span><span class="s2">&quot;result&quot;</span><span class="o">][</span><span class="s2">&quot;results&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span>
</span><span class='line'>      <span class="n">a</span> <span class="o">=</span> <span class="no">Ubike</span><span class="o">.</span><span class="n">find_by_ubike_id</span><span class="p">(</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;_id&quot;</span><span class="o">]</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="c1"># maybe update it!</span>
</span><span class='line'>        <span class="no">Ubike</span><span class="o">.</span><span class="n">create</span><span class="p">(</span> <span class="ss">:ubike_id</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;_id&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;sna&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="no">Ubike</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="ss">:ubike_id</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;_id&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;sna&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣只要打 <code>rake dev:fetch_ubike</code> 就會自動跑了!</p>

<p>範例2：<a href="http://vote.ly.g0v.tw/api/vote/?page=1">立委資料</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#立委資料，資料相當大，很多分頁</span>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:vote</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'> <span class="n">task</span> <span class="ss">:fetch_raw_vote</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>   <span class="nb">puts</span> <span class="s2">&quot;fetching raw_vote&quot;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://vote.ly.g0v.tw/api/vote/?page=1&quot;</span>
</span><span class='line'>   <span class="n">raw_content</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>   <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="n">raw_content</span> <span class="p">)</span>
</span><span class='line'>     <span class="k">while</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;next&quot;</span><span class="o">]</span> <span class="o">!=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="n">data</span><span class="o">[</span><span class="s2">&quot;results&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>           <span class="no">Vote</span><span class="o">.</span><span class="n">create</span><span class="p">(</span> <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;url&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;uid&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:sitting_id</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;sitting_id&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:vote_seq</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;vote_seq&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;content&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:conflict</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;conflict&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:results</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;results&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:result</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;result&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>         <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">url</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;next&quot;</span><span class="o">]</span>
</span><span class='line'>         <span class="n">raw_content</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>         <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="n">raw_content</span> <span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：
<a href="https://blog.wu-boy.com/2011/04/%E4%BD%A0%E4%B8%8D%E5%8F%AF%E4%B8%8D%E7%9F%A5%E7%9A%84-json-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9/">你不可不知的 JSON 基本介紹</a>
<a href="https://ihower.tw/rails4/routing.html">Scope</a>
<a href="http://motion-express.com/blog/20141124-rails-default-render-json">Rails修改預設顯示格式為json</a></p>

<p>gem：
<a href="https://github.com/rails/jbuilder">jbuilder</a>
<a href="https://github.com/rest-client/rest-client">rest-client</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby on Rails - 好用的 Enumerable]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/07/rails-enumerable/"/>
    <updated>2016-01-07T20:40:22+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/07/rails-enumerable</id>
    <content type="html"><![CDATA[<p>這次主要來介紹一些好用的 Enumerable
可以很方便的將需要的資料整合在一起</p>

<!-- more -->


<h1>Map/Collect</h1>

<p>對 block 每個值進行運算，並回傳成一個新的 <code>array</code>
處理 <code>hash</code> 時，也可以分開處理 key 和 value</p>

<p><code>map</code> 和 <code>collect</code> 其實是一樣的東西，主要是因為其他語言很多都是用 <code>collect</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">]</span>
</span><span class='line'><span class="n">array</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">*</span> <span class="mi">2</span><span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; [2, 4, 6]</span>
</span><span class='line'>
</span><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="ss">:age</span> <span class="o">=&gt;</span> <span class="mi">18</span><span class="p">}</span>
</span><span class='line'><span class="nb">hash</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; [&quot;abc&quot;, 18]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Select</h1>

<p>對物件，挑出指定欄位的值，並回傳 <code>ActiveRecord::Relation</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;User id: 1&gt;, #&lt;User id: 2&gt;, #&lt;User id: 3&gt;,...]&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以再搭配 <code>map</code> 變成一個 <code>array</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [1,2,3]</span>
</span></code></pre></td></tr></table></div></figure>


<p>或是直接針對 array 去篩選</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">my_array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">100</span><span class="o">]</span>
</span><span class='line'><span class="n">my_array</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="n">item</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; [2,4,6,8,100]</span>
</span></code></pre></td></tr></table></div></figure>


<p>hash</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">my_hash</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Joe&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;Jim&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;Patty&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;female&quot;</span><span class="p">}</span>
</span><span class='line'><span class="n">my_hash</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">gender</span><span class="o">|</span> <span class="n">gender</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; {&quot;Joe&quot; =&gt; &quot;male&quot;, &quot;Jim&quot; =&gt; &quot;male&quot;}</span>
</span><span class='line'>
</span><span class='line'><span class="err">也可以</span>
</span><span class='line'><span class="n">my_hash</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="o">[</span><span class="s2">&quot;Joe&quot;</span><span class="p">,</span> <span class="s2">&quot;Jim&quot;</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="n">k</span><span class="p">)}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#改成 map 會變成，回傳 boolean值，並且回傳 array</span>
</span><span class='line'><span class="n">my_hash</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">gender</span><span class="o">|</span> <span class="n">gender</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; [true, true, false]</span>
</span></code></pre></td></tr></table></div></figure>


<p>只回傳 ture 的選項</p>

<p>進階用法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#在Hash裡定義新的方法 沒有特定對象的通常可以放在lib資料夾</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Hash</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">keep</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">select</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">args</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">k</span><span class="p">)}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_hash</span><span class="o">.</span><span class="n">keep</span><span class="p">(</span><span class="s2">&quot;Joe&quot;</span><span class="p">,</span> <span class="s2">&quot;Jim&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; {&quot;Joe&quot; =&gt; &quot;male&quot;, &quot;Jim&quot; =&gt; &quot;male&quot;}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Pluck</h1>

<p>對物件，挑出指定欄位的值，並回傳一個新的 <code>array</code>
像是 <code>map</code> 和 <code>select</code> 合在一起的指令</p>

<p>Approach - map</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, 2, 3]</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">measure</span> <span class="p">{</span><span class="no">User</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)}</span>
</span><span class='line'><span class="c1">#0.000000   0.000000   0.000000 (  0.000857)</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; [1, 2, 3]</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">measure</span> <span class="p">{</span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">}}</span>
</span><span class='line'><span class="c1"># 0.000000   0.020000   0.020000 (  0.026401)</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;User id: 1&gt;, #&lt;User id: 2&gt;, #&lt;User id: 3&gt;]&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">measure</span> <span class="p">{</span><span class="no">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="p">}</span>
</span><span class='line'><span class="c1">#0.000000   0.000000   0.000000 (  0.001549)</span>
</span></code></pre></td></tr></table></div></figure>


<p>顯然效能上還是 <code>pluck</code> 最快</p>

<p><code>map</code> 會將所有欄位找出來，再根據 block 的值，回傳新的 <code>array</code></p>

<p><code>pluck</code> 和 <code>select</code> 則是只將需要的欄位選出來，但 <code>select</code> 回傳的是 <code>ActiveRecord::Relation</code> 必須再透過 map 轉成 <code>array</code></p>

<p>參考文件：
<a href="http://rubyinrails.com/2014/06/05/rails-pluck-vs-select-map-collect/">Rails Pluck vs Select and Map/Collect</a>
<a href="http://gavinmiller.io/2013/getting-to-know-pluck-and-select/">Getting to Know Pluck and Select</a>
<a href="http://ohm.sh/2014/02/09/pluck-vs-map-and-select.html">Pluck vs. map and select</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Person</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</span><span class='line'><span class="c1"># SELECT people.id FROM people</span>
</span><span class='line'><span class="c1"># =&gt; [1, 2, 3]</span>
</span><span class='line'>
</span><span class='line'><span class="no">Person</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span>
</span><span class='line'><span class="c1"># SELECT people.id, people.name FROM people</span>
</span><span class='line'><span class="c1"># =&gt; [[1, &#39;David&#39;], [2, &#39;Jeremy&#39;], [3, &#39;Jose&#39;]]</span>
</span><span class='line'>
</span><span class='line'><span class="no">Person</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;DISTINCT role&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># SELECT DISTINCT role FROM people</span>
</span><span class='line'><span class="c1"># =&gt; [&#39;admin&#39;, &#39;member&#39;, &#39;guest&#39;]</span>
</span><span class='line'>
</span><span class='line'><span class="no">Person</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</span><span class='line'><span class="c1"># SELECT people.id FROM people WHERE people.age = 21 LIMIT 5</span>
</span><span class='line'><span class="c1"># =&gt; [2, 3]</span>
</span><span class='line'>
</span><span class='line'><span class="no">Person</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;DATEDIFF(updated_at, created_at)&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># SELECT DATEDIFF(updated_at, created_at) FROM people</span>
</span><span class='line'><span class="c1"># =&gt; [&#39;0&#39;, &#39;27761&#39;, &#39;173&#39;]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>reject</h1>

<p>回傳 block 為 <code>false</code> 的值，成一個新的 <code>array</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Remove even numbers</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Remove years dividable with 4 (this is *not* the full leap years rule)</span>
</span><span class='line'><span class="p">(</span><span class="mi">1950</span><span class="o">.</span><span class="n">.</span><span class="mi">2000</span><span class="p">)</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">y</span><span class="o">|</span> <span class="n">y</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; [1952, 1956, 1960, 1964, 1968, 1972, 1976, 1980, 1984, 1988, 1992, 1996, 2000]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Remove users with karma below arithmetic mean</span>
</span><span class='line'><span class="n">total</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">total</span><span class="p">,</span> <span class="n">user</span><span class="o">|</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">user</span><span class="o">.</span><span class="n">karma</span> <span class="p">}</span>
</span><span class='line'><span class="n">mean</span> <span class="o">=</span> <span class="n">total</span> <span class="o">/</span> <span class="n">users</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="n">good_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span> <span class="n">u</span><span class="o">.</span><span class="n">karma</span> <span class="o">&lt;</span> <span class="n">mean</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>inject</h1>

<p>inject 方法可以先給予初始值(數字，hash，array 都可以)，之後給予指定的元素，不斷的迭代。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">(</span><span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">init</span><span class="p">,</span> <span class="n">n</span><span class="o">|</span> <span class="n">init</span> <span class="o">*</span> <span class="n">n</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; 151200</span>
</span><span class='line'><span class="p">(</span><span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:*</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 151200</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">(</span><span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">inject</span> <span class="p">{</span><span class="o">|</span><span class="n">sum</span><span class="p">,</span> <span class="n">n</span><span class="o">|</span> <span class="n">sum</span> <span class="o">*</span> <span class="n">n</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; 45</span>
</span><span class='line'><span class="p">(</span><span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 45</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以拿來做比較。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">%w{ cat sheep bear }</span><span class="o">.</span><span class="n">inject</span> <span class="k">do</span> <span class="o">|</span><span class="n">memo</span><span class="p">,</span><span class="n">word</span><span class="o">|</span>
</span><span class='line'>   <span class="n">memo</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">word</span><span class="o">.</span><span class="n">length</span> <span class="p">?</span> <span class="n">memo</span> <span class="p">:</span> <span class="n">word</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1"># =&gt; &quot;sheep&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果給予 inject 的參數為一個空區塊，那麼 inject 會將結果整理成 Hash。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">user</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">hash</span><span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>  <span class="nb">hash</span> <span class="c1"># 需要回傳運算結果</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1"># =&gt; {&quot;A&quot;=&gt;1, &quot;B&quot;=&gt;2, &quot;C&quot;=&gt;3}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但要注意的是，由於每跑一次，都會取用最後的回傳值，當做這次的初始值，因此最後必須再加個 <code>hash</code> ，否則會出錯。</p>

<blockquote><p>也可以直接給予有值的 hash 再繼續加上後面的值，取代掉 inject({}) 中的空 hash</p></blockquote>

<p>也可改用 reduce 跟 inject 一模一樣
<a href="http://stackoverflow.com/questions/13813243/is-inject-the-same-thing-as-reduce-in-ruby">Is inject the same thing as reduce in ruby?</a></p>

<h3>額外說明</h3>

<p>也可以用 map 方式，湊成上面的值。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Hash</span><span class="o">[</span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">]</span><span class="p">}</span><span class="o">]</span>
</span><span class='line'><span class="c1"># =&gt; {&quot;A&quot;=&gt;1, &quot;B&quot;=&gt;2, &quot;C&quot;=&gt;3}</span>
</span><span class='line'>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">to_h</span>
</span><span class='line'><span class="c1"># =&gt; {&quot;A&quot;=&gt;1, &quot;B&quot;=&gt;2, &quot;C&quot;=&gt;3}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>each_with_object</h1>

<p>跟 inject 非常類似，，主要差別在於你不用回傳運算結果，還有參數是顛倒過來的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each_with_object</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span> <span class="n">user</span><span class="p">,</span> <span class="nb">hash</span> <span class="o">|</span>
</span><span class='line'>  <span class="nb">hash</span><span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>merge</h1>

<p>可以將另一個 hash 合併在一起</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">200</span> <span class="p">}</span>
</span><span class='line'><span class="n">h2</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">254</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span> <span class="o">=&gt;</span> <span class="mi">300</span> <span class="p">}</span>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;254, &quot;c&quot;=&gt;300}</span>
</span><span class='line'>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">h2</span><span class="p">){</span><span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="o">|</span> <span class="n">newval</span> <span class="o">-</span> <span class="n">oldval</span><span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;54,  &quot;c&quot;=&gt;300}</span>
</span><span class='line'>
</span><span class='line'><span class="n">h1</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;200}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="ss">phone</span><span class="p">:</span> <span class="mi">09</span><span class="n">xxxxx</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>each_with_index</h1>

<p>用來加上索引。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="sx">%w(cat dog wombat)</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span><span class="o">|</span><span class="n">item</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">hash</span><span class="o">[</span><span class="n">item</span><span class="o">]</span> <span class="o">=</span> <span class="n">index</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; [&quot;cat&quot;, &quot;dog&quot;, &quot;wombat&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="nb">hash</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;cat&quot;=&gt;0, &quot;dog&quot;=&gt;1, &quot;wombat&quot;=&gt;2}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://www.bbs-software.com/blog/2013/11/22/rubys-injectreduce-and-each_with_object/">Ruby’s inject/reduce and each_with_object</a></p>

<p>也可以用來將複數的的 position 印出來。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="s2">&quot;Cool&quot;</span><span class="p">,</span> <span class="s2">&quot;chicken!&quot;</span><span class="p">,</span> <span class="s2">&quot;beans!&quot;</span><span class="p">,</span> <span class="s2">&quot;beef!&quot;</span><span class="o">].</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">item</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="k">if</span> <span class="n">index</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="no">Cool</span> <span class="n">beans!</span>  <span class="c1"># =&gt; [&quot;Cool&quot;, &quot;chicken!&quot;, &quot;beans!&quot;, &quot;beef!&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>sum</h1>

<p>可以算出集合的加總</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">payments</span><span class="o">.</span><span class="n">sum</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="nb">p</span><span class="o">.</span><span class="n">tax_rate</span> <span class="p">}</span>
</span><span class='line'><span class="n">payments</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:price</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>數字，字串，陣列都可以，其實就是用 <code>+</code> 的方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="o">].</span><span class="n">sum</span> <span class="c1"># =&gt; 30</span>
</span><span class='line'><span class="o">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="o">].</span><span class="n">sum</span> <span class="c1"># =&gt; &quot;foobar&quot;</span>
</span><span class='line'><span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="o">]].</span><span class="n">sum</span> <span class="c1">#=&gt; [1, 2, 3, 1, 5]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>group_by</h1>

<p>可以依照指定的欄位分組出來。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">latest_transcripts</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:day</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">day</span><span class="p">,</span> <span class="n">transcripts</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">p</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">day</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">#{</span><span class="n">transcripts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:class</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># &quot;2006-03-01 -&gt; Transcript&quot;</span>
</span><span class='line'><span class="c1"># &quot;2006-02-28 -&gt; Transcript&quot;</span>
</span><span class='line'><span class="c1"># &quot;2006-02-27 -&gt; Transcript, Transcript&quot;</span>
</span><span class='line'><span class="c1"># &quot;2006-02-26 -&gt; Transcript, Transcript&quot;</span>
</span><span class='line'><span class="c1"># &quot;2006-02-25 -&gt; Transcript&quot;</span>
</span><span class='line'><span class="c1"># &quot;2006-02-24 -&gt; Transcript, Transcript&quot;</span>
</span><span class='line'><span class="c1"># &quot;2006-02-23 -&gt; Transcript&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">names</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;James&quot;</span><span class="p">,</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="s2">&quot;Joe&quot;</span><span class="p">,</span> <span class="s2">&quot;Mark&quot;</span><span class="p">,</span> <span class="s2">&quot;Jim&quot;</span><span class="o">]</span>
</span><span class='line'><span class="n">names</span><span class="o">.</span><span class="n">group_by</span><span class="p">{</span><span class="o">|</span><span class="nb">name</span><span class="o">|</span> <span class="nb">name</span><span class="o">.</span><span class="n">length</span><span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; {5=&gt;[&quot;James&quot;], 3=&gt;[&quot;Bob&quot;, &quot;Joe&quot;, &quot;Jim&quot;], 4=&gt;[&quot;Mark&quot;]}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>grep</h1>

<p>根據指定的條件塞選</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">names</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;James&quot;</span><span class="p">,</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="s2">&quot;Joe&quot;</span><span class="p">,</span> <span class="s2">&quot;Mark&quot;</span><span class="p">,</span> <span class="s2">&quot;Jim&quot;</span><span class="o">]</span>
</span><span class='line'><span class="n">names</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="sr">/J/</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [&quot;James&quot;, &quot;Joe&quot;, &quot;Jim&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>index_by</h1>

<p>index_by可以指定欄位做為鍵值整理成Hash。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">index_by</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:phone</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; {&#39;0912xxxxxx&#39; =&gt; &lt;User ...&gt;, &#39;0919xxxxxx&#39; =&gt; &lt;User ...&gt;, ...}</span>
</span></code></pre></td></tr></table></div></figure>


<p>鍵值通常必須是唯一的，若不是唯一的話，會以最後出現的元素做為判斷值。</p>

<h1>any?</h1>

<p>只要有任何條件符合，就回傳true</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">%w{ant bear cat}</span><span class="o">.</span><span class="n">any?</span> <span class="p">{</span><span class="o">|</span><span class="n">word</span><span class="o">|</span> <span class="n">word</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span><span class='line'><span class="sx">%w{ant bear cat}</span><span class="o">.</span><span class="n">any?</span> <span class="p">{</span><span class="o">|</span><span class="n">word</span><span class="o">|</span> <span class="n">word</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span><span class='line'><span class="o">[</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="mi">99</span> <span class="o">].</span><span class="n">any?</span>
</span><span class='line'><span class="c1">#=&gt; 只要有一個不是 nil 和 false 就是 true</span>
</span></code></pre></td></tr></table></div></figure>


<p>主要都是集合的方法</p>

<p>可參考之前的
<a href="http://mgleon08.github.io/blog/2015/12/16/ruby-on-rail-nil-empty-blank-present/">.nil? .empty? .blank? .present? 傻傻分不清楚？</a></p>

<h1>&amp;:</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>&amp;:</code> 代表代入一個Proc
 <code>(&amp;:name)</code> = <code>{|name| user.name}</code> 的概念XD。</p>

<h1>Benchmark</h1>

<p>上面其實很多都很類似，主要差異的話就是速度吧
所以可以用以下的方式來測試每種執行出來的速度。</p>

<p><a href="http://ruby-doc.org/stdlib-2.0.0/libdoc/benchmark/rdoc/Benchmark.html">Benchmark</a>
<a href="https://github.com/evanphx/benchmark-ips">benchmark-ips</a></p>

<p>官方文件：
<a href="http://ruby-doc.org/core-2.1.0/Enumerable.html">Enumerable</a>
<a href="http://apidock.com/ruby/Array/map">map/collect</a>
<a href="http://ruby-doc.org/core-2.2.3/Enumerable.html#method-i-reject">reject</a>
<a href="http://apidock.com/ruby/Enumerable/inject">inject</a>
<a href="http://apidock.com/rails/ActiveRecord/QueryMethods/select">select</a>
<a href="http://apidock.com/rails/ActiveRecord/Calculations/pluck">pluck</a>
<a href="http://apidock.com/ruby/Enumerable/reduce">reduce</a>
<a href="http://apidock.com/rails/Enumerable/each_with_object">each_with_object</a>
<a href="http://apidock.com/ruby/v1_9_3_392/Enumerable/each_with_index">each_with_index</a>
<a href="http://ruby-doc.org/core-1.9.3/Hash.html#method-i-merge">merge</a>
<a href="http://apidock.com/rails/Enumerable/sum">sum</a>
<a href="http://apidock.com/rails/Enumerable/group_by">group_by</a>
<a href="http://apidock.com/rails/v4.2.1/Enumerable/index_by">index_by</a>
<a href="http://apidock.com/rails/Enumerable/many%3F">many?</a>
<a href="http://apidock.com/ruby/Enumerable/any%3F">any?</a></p>

<p>參考文件：
<a href="http://rubyinrails.com/2014/06/05/rails-pluck-vs-select-map-collect/">Rails Pluck vs Select and Map/Collect</a>
<a href="http://gavinmiller.io/2013/getting-to-know-pluck-and-select/">Getting to Know Pluck and Select</a>
<a href="http://ohm.sh/2014/02/09/pluck-vs-map-and-select.html">Pluck vs. map and select</a>
<a href="http://www.eriktrautman.com/posts/ruby-explained-map-select-and-other-enumerable-methods">Ruby Explained: Map, Select, and Other Enumerable Methods</a>
<a href="https://gist.github.com/cupakromer/3371003">each_with_object vs inject</a>
<a href="https://ihower.tw/rails4/activesupport.html">ActiveSupport - 工具函式庫</a>
<a href="http://motion-express.com/blog/20141027-ruby-inject-each-with-object-hash">Ruby 用 inject 和 each_with_object 來組 hash
</a>
<a href="http://stackoverflow.com/questions/1217088/what-does-mapname-mean-in-ruby">What does map(&amp;:name) mean in Ruby?</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Backup 來備份資料庫]]></title>
    <link href="http://mgleon08.github.com/blog/2016/01/03/backup/"/>
    <updated>2016-01-03T21:42:46+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/01/03/backup</id>
    <content type="html"><![CDATA[<p>當網站上線之後，經常會提心吊膽的害怕網站資料不見。<br/>
這是很重要的動作就是 <code>備份</code> !</p>

<!-- more -->


<p>這次主要介紹用 <a href="http://backup.github.io/backup/v4/">backup</a>來做備份</p>

<p>先到遠端的 server 上面</p>

<p><code>gem install backup</code></p>

<p>將 backup 安裝起來</p>

<p>接著輸入</p>

<p><code>backup generate:model --trigger my_backup --archives --storages='s3' --compressor='gzip' --notifiers=‘mail'</code></p>

<p>之後會產生一個 <code>config.rb</code> 和一個 <code>my_backup.rb</code> 的檔案。</p>

<p>打開 <code>my_backup.rb</code> 設定</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Model</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:my_backup</span><span class="p">,</span> <span class="s1">&#39;[describe]&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##</span>
</span><span class='line'>  <span class="c1"># MySQL [Database]</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="n">database</span> <span class="no">MySQL</span> <span class="k">do</span> <span class="o">|</span><span class="n">db</span><span class="o">|</span>
</span><span class='line'>    <span class="c1"># To dump all databases, set `db.name = :all` (or leave blank)</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">name</span>               <span class="o">=</span> <span class="s2">&quot;[dbname]&quot;</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">username</span>           <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">password</span>           <span class="o">=</span> <span class="s2">&quot;xxxx&quot;</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">host</span>               <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">port</span>               <span class="o">=</span> <span class="mi">3306</span>
</span><span class='line'>    <span class="c1"># db.socket             = &quot;/tmp/mysql.sock&quot;</span>
</span><span class='line'>    <span class="c1"># Note: when using `skip_tables` with the `db.name = :all` option,</span>
</span><span class='line'>    <span class="c1"># table names should be prefixed with a database name.</span>
</span><span class='line'>    <span class="c1"># e.g. [&quot;db_name.table_to_skip&quot;, ...]</span>
</span><span class='line'>    <span class="c1"># db.skip_tables        = [&quot;skip&quot;, &quot;these&quot;, &quot;tables&quot;]</span>
</span><span class='line'>    <span class="c1"># db.only_tables        = [&quot;only&quot;, &quot;these&quot;, &quot;tables&quot;]</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">additional_options</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;--quick&quot;</span><span class="p">,</span> <span class="s2">&quot;--single-transaction&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##</span>
</span><span class='line'>  <span class="c1"># Amazon Simple Storage Service [Storage]</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>
</span><span class='line'> <span class="c1"># 將備份檔案儲存到S3</span>
</span><span class='line'> <span class="n">store_with</span> <span class="no">S3</span> <span class="k">do</span> <span class="o">|</span><span class="n">s3</span><span class="o">|</span>
</span><span class='line'>    <span class="c1"># AWS Credentials</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">access_key_id</span>     <span class="o">=</span> <span class="s2">&quot;xxxx&quot;</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">secret_access_key</span> <span class="o">=</span> <span class="s2">&quot;xxxx&quot;</span>
</span><span class='line'>    <span class="c1"># Or, to use a IAM Profile:</span>
</span><span class='line'>    <span class="c1"># s3.use_iam_profile = true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">region</span>            <span class="o">=</span> <span class="s2">&quot;ap-northeast-1&quot;</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">bucket</span>            <span class="o">=</span> <span class="s2">&quot;[bucketname]&quot;</span>
</span><span class='line'>    <span class="n">s3</span><span class="o">.</span><span class="n">path</span>              <span class="o">=</span> <span class="s2">&quot;[path]&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 額外的檔案壓縮，例如用戶上傳的圖片，就可以指定路徑</span>
</span><span class='line'>  <span class="c1"># archive.add “/home/deploy/xxxxxxx/shared/public/systems/</span>
</span><span class='line'>  <span class="c1"># archive :my_archive do |archive|</span>
</span><span class='line'>    <span class="c1"># Run the `tar` command using `sudo`</span>
</span><span class='line'>    <span class="c1"># archive.use_sudo</span>
</span><span class='line'>    <span class="c1"># archive.add &quot;/srv&quot;</span>
</span><span class='line'>  <span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##</span>
</span><span class='line'>  <span class="c1"># Gzip [Compressor]</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="n">compress_with</span> <span class="no">Gzip</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##</span>
</span><span class='line'>  <span class="c1"># Mail [Notifier]</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># The default delivery method for Mail Notifiers is &#39;SMTP&#39;.</span>
</span><span class='line'>  <span class="c1"># See the documentation for other delivery options.</span>
</span><span class='line'>  <span class="c1"># 寄信通知，也有很多其他的通知方法，官方文件都有</span>
</span><span class='line'>  <span class="n">notify_by</span> <span class="no">Mail</span> <span class="k">do</span> <span class="o">|</span><span class="n">mail</span><span class="o">|</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">on_success</span>           <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">on_warning</span>           <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">on_failure</span>           <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">from</span>                 <span class="o">=</span> <span class="s2">&quot;mail.from&quot;</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">to</span>                   <span class="o">=</span> <span class="s2">&quot;mail.to&quot;</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">address</span>              <span class="o">=</span> <span class="s2">&quot;smtp.mailgun.org&quot;</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">port</span>                 <span class="o">=</span> <span class="mi">587</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">domain</span>               <span class="o">=</span> <span class="s2">&quot;mail.domain&quot;</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">user_name</span>            <span class="o">=</span> <span class="s2">&quot;mail.user_name&quot;</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">password</span>             <span class="o">=</span> <span class="s2">&quot;mail.password&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">authentication</span>       <span class="o">=</span> <span class="s2">&quot;plain&quot;</span>
</span><span class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">encryption</span>           <span class="o">=</span> <span class="ss">:starttls</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著打</p>

<p><code>backup perform --trigger my_backup</code></p>

<p>就可以做備份了</p>

<h1>排程</h1>

<p>每次都要手動去備份相當麻煩，因此接下來就是要設定固定時間跑指令來做備份拉。</p>

<p>這邊是用 <a href="https://github.com/javan/whenever">whenever</a> 來跑 crontab</p>

<p>先在 Gemfile. 加入</p>

<p><code>gem 'whenever', :require =&gt; false</code></p>

<p>接著打 <code>wheneverize .</code></p>

<p>就會產生檔案 <code>config/schedule.rb</code></p>

<p>打開檔案</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">env</span> <span class="ss">:PATH</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PATH&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:output</span><span class="p">,</span> <span class="s1">&#39;/home/[username]/cron.log&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">every</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="ss">:at</span> <span class="o">=&gt;</span> <span class="s1">&#39;4:30 am&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;/usr/local/bin/backup perform -t my_backup -c /home/[username]/Backup/config.rb&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>切記! 路徑要用絕對路徑啊啊啊!</p></blockquote>

<p>設定就完成囉!</p>

<p>如果有使用 capistrano 的話，可以在 Capfile 加入下面程式：
<code>require "whenever/capistrano"</code></p>

<p>也可以只更新遠端 whenever<br/>
<code>cap production whenever:update_crontab</code></p>

<p>另外要看有沒有進排程可以打</p>

<p><code>crontab -e</code></p>

<p>另外 crontab 會分帳號的，所以要用原本的帳號打才會出現。</p>

<blockquote><p>如果只用 whenever 的 rake “XXX” 的話，crontab -e 裡面會先 cd 到專案目錄下，
這時候 log/cron.log 就沒問題</p>

<p>但是 whenever 的 command “XXXX” 並不會先 cd 到專案目錄下，因此 log/cron.log 會不知道跑去哪裡</p></blockquote>

<h1>匯入資料庫</h1>

<p>有了備份檔案，就能夠直接在本機端匯入檔案<br/>
匯入方式如下</p>

<p><code>mysql -u root -p db_name &lt; backup.sql</code></p>

<p>就會看到資料都匯入進去了，另外圖片都是存在 s3 ，如果希望圖片也顯示，就將 production 的圖片複製一份到 development 就可以了，因為兩邊設定的 bucket 是不一樣的。</p>

<p>官方文件：<br/>
<a href="http://backup.github.io/backup/v4/">backup</a><br/>
<a href="https://github.com/javan/whenever">whenever</a></p>

<p>參考文件：<br/>
<a href="http://blog.eddie.com.tw/2011/05/24/backup-your-website/">用Backup來備份你的網站</a><br/>
<a href="http://lemonup.logdown.com/posts/169422-rails-whenever-use-note">Whenever 使用筆記</a><br/>
<a href="http://programmer.shinchi.tw/2013/12/18/mysql%E5%8C%AF%E5%85%A5%E8%88%87%E5%8C%AF%E5%87%BA%E6%8C%87%E4%BB%A4/">mysql匯入與匯出指令</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Git 指令操作手冊]]></title>
    <link href="http://mgleon08.github.com/blog/2015/12/27/git-command/"/>
    <updated>2015-12-27T20:56:35+08:00</updated>
    <id>http://mgleon08.github.com/blog/2015/12/27/git-command</id>
    <content type="html"><![CDATA[<p>Git 博大精深，必須花很多時間去學習，從做中學會更快
因此這篇主要用來記錄 Git 的指令和操作，增加記憶，也方便後續查詢。</p>

<!-- more -->


<h1>區域</h1>

<ol>
<li>工作目錄 Working tree</li>
<li>暫存準備遞交區 Staging Area (index索引)</li>
<li>儲存庫 Repository</li>
</ol>


<h1>狀態</h1>

<ol>
<li>沒有被追蹤的檔案 Untracked files</li>
<li>有修改、還沒準備要被遞交 Changes not staged for commit</li>
<li>有修改、準備要被遞交的檔案(在Staging Area) Changes to be committed</li>
<li>已經被遞交的檔案 Committed</li>
</ol>


<h1>符號</h1>

<ol>
<li>HEAD

<ul>
<li>永遠會指向「工作目錄」中所設定的「分支」當中的「最新版」。</li>
<li>所以當你在這個分支執行 git commit 後，這個 HEAD 符號參照也會更新成該分支最新版的那個 commit 物件。</li>
</ul>
</li>
<li>ORIG_HEAD

<ul>
<li>簡單來說就是 HEAD 這個 commit 物件的「前一版」，經常用來復原上一次的版本變更。</li>
<li><a href="http://stackoverflow.com/questions/964876/head-and-orig-head-in-git">HEAD and ORIG_HEAD in Git</a></li>
</ul>
</li>
<li>FETCH_HEAD

<ul>
<li>使用遠端儲存庫時，可能會使用 git fetch 指令取回所有遠端儲存庫的物件。這個 FETCH_HEAD 符號參考則會記錄遠端儲存庫中每個分支的 HEAD (最新版) 的「絕對名稱」。</li>
</ul>
</li>
<li>MERGE_HEAD

<ul>
<li>當你執行合併工作時 (關於合併的議題會在日後的文章中會提到)，「合併來源｣的 commit 物件絕對名稱會被記錄在 MERGE_HEAD 這個符號參照中。</li>
</ul>
</li>
</ol>


<h1>基本設定</h1>

<ul>
<li><code>git config --global user.name "&lt;使用者名字&gt;"</code></li>
<li><code>git config --global user.email "&lt;電子信箱&gt;"</code></li>
<li><code>git config --list</code>　看 Git 設定內容</li>
<li><code>git config --global alias.st status</code>　縮短字串（將 git status 縮寫為 git st）</li>
<li><code>git config --global color.ui true</code>　設定輸出顏色</li>
<li><code>git config --global apply.whitespace nowarn</code> 空白對有些語言是有影響的(像是Ruby)，因此我們會希望 Git 去忽略空白的變化</li>
</ul>


<p>以上皆可直接 <code>vi .gitconfig</code> 去做修正</p>

<h1>基本功能</h1>

<h3>basic</h3>

<ul>
<li><code>git --version</code> 查看目前版本。</li>
<li><code>git help [指令]</code> 查詢完整的文件。</li>
<li><code>git init</code> 建立 Repository。</li>
<li><code>git clone [url]</code> 複製遠端專案。</li>
<li><code>git mv [filename] [new filename]</code> 更改檔案名稱。(此更改檔案的動作會列入版本控制中)</li>
<li><code>git show [SHA1]</code> 查出該版本的相關資訊。(可搭配 <code>git log</code> 找出有問題的版本)</li>
</ul>


<h3>add</h3>

<ul>
<li><code>git add .</code> 將當前目錄<code>所有</code>檔案加入到 Staging Area。(雖然方便但很容易會不小心加入一些其他不必要的檔案)</li>
<li><code>git add [filename]</code> 將檔案加入到 Staging Area。</li>
<li><code>git add -p</code>，可以選擇只加入檔案中修改的其中一部分。</li>
<li><code>git add -i</code>，會以互動方式詢問要加入到Staging Area裡的檔案。</li>
<li><code>git add -u</code>，只註冊已提交過的檔案到索引。</li>
</ul>


<h3>rm</h3>

<ul>
<li><code>git rm [filename]</code> 刪除檔案，包括實體檔案。(此刪除檔案的動作會列入版本控制中)</li>
<li><code>git rm --cached a.txt</code> 只想刪除索引檔中的該檔，又要保留工作目錄下的實體檔案。</li>
</ul>


<h3>commit</h3>

<ul>
<li><code>git commit</code> 將 Staging Area 檔案 commit。</li>
<li><code>git commit -m [commit 訊息]</code> 直接寫入 commit 訊息。</li>
<li><code>git commit -am [commit 訊息]</code> 等於 <code>git add .</code> + <code>git commit -m</code>。</li>
<li><code>git commit --amend</code> 修改上一個 commit 訊息。</li>
</ul>


<h3>status</h3>

<ul>
<li><code>git status</code> 檢視檔案的狀態。</li>
<li><code>git status -s</code> 顯示精簡的狀態。</li>
<li><code>git status -b</code> 顯示分支的名稱。</li>
</ul>


<h1>分支</h1>

<h3>branch</h3>

<ul>
<li><code>git branch</code> 列出所有本地端的 branch。</li>
<li><code>git branch -r</code> 列出所有遠端的 branch。</li>
<li><code>git branch -a</code> 列出所有本地及遠端的 branch。</li>
<li><code>git branch [branch]</code> 建立一個新的 branch。</li>
<li><code>git branch -m [oldbranch] [newbranch]</code> 修改分支的名稱， <code>-M</code> 強制。</li>
<li><code>git branch -d [branchname]</code> 刪除 branch，未合併的無法刪除，必須改用 <code>-D</code> 強制刪除。</li>
</ul>


<h3>checkout</h3>

<ul>
<li><code>git checkout [branch]</code> 切換到該 branch。</li>
<li><code>git checkout -b [branch]</code>建立一個新的 branch 並切換到該 branch。</li>
</ul>


<blockquote><p>切換 working tree 的 branch 時,如果有檔案，在 staging area 或是 modified，會無法切換。可以先 commit，只要不 push 出去，再 <code>reset</code> 回來即可。或是用 <code>stash</code> 的方式</p></blockquote>

<h1>合併</h1>

<h3>merge</h3>

<ul>
<li><code>git merge [branch]</code> 將指定 branch 合併到目前的 branch</li>
<li><code>git merge [branch] --no-ff</code> 不使用 fast-forward 合併。可以保留分支合併的紀錄。</li>
</ul>


<h1>修正</h1>

<h3>reset</h3>

<ul>
<li><code>git reset</code> 將所有檔案從 Staging Area 到 Working tree。</li>
<li><code>git reset HEAD [filename]</code> 將檔案從 Staging Area 取消到 Working tree。</li>
<li><code>git reset --hard HEAD</code> 放棄目前所有修改，返回到最新的commit。</li>
<li><code>git reset HEAD^</code> 刪除最近一次的版本紀錄，但保留修改過的檔案。(回到working tree)</li>
<li><code>git reset --soft HEAD^</code> 刪除最近一次的版本紀錄，但保留修改過的檔案。(回到staging area)</li>
<li><code>git reset --hard HEAD^</code> 刪除最近一次的版本紀錄，清除修改過的檔案。(完全消失)</li>
</ul>


<blockquote><p>HEAD 後面可接 <code>^</code> 表示回到上個版本， <code>^^</code> 回到上兩個版本，以此類推
也可以用 <code>~</code>，或是 <code>^2</code> or <code>~2</code>，都不加就是回到目前最新的版本</p></blockquote>

<ul>
<li><code>git reset --hard ORIG_HEAD</code> 刪除最近一次的版本，但保留最後一次的變更。</li>
</ul>


<h3>revert</h3>

<blockquote><p>revert是新增一個commit來做還原，<code>git revert</code> 會用一個新的 commit 來回復所有的變更。(適合已經push出去給別人的情境)</p></blockquote>

<h3>rebase</h3>

<ul>
<li><code>git rebase</code> 重新修改特定分支的「基礎版本」，把另外一個分支的變更，當成這個分支的基礎。(如果接著直接 merge，則是會直接 fast-forward ，若想保留資訊則加上  <code>--no-ff</code>)</li>
<li><a href="https://blog.yorkxin.org/posts/2011/07/29/git-rebase/">Git-rebase 小筆記</a></li>
<li><code>git rebase [SHA1] -i</code> 可以只接更改某個 commit 之後所有的紀錄。</li>
<li><a href="https://github.com/doggy8088/Learn-Git-in-30-days/blob/master/docs/22%20%E4%BF%AE%E6%AD%A3%20commit%20%E9%81%8E%E7%9A%84%E7%89%88%E6%9C%AC%E6%AD%B7%E5%8F%B2%E7%B4%80%E9%8C%84%20Part%204%20(rebase">rebase -i 修正 commit 過的版本歷史紀錄1</a>.markdown)</li>
<li><a href="https://github.com/doggy8088/Learn-Git-in-30-days/blob/master/docs/23%20%E4%BF%AE%E6%AD%A3%20commit%20%E9%81%8E%E7%9A%84%E7%89%88%E6%9C%AC%E6%AD%B7%E5%8F%B2%E7%B4%80%E9%8C%84%20Part%205%20(rebase%202">rebase -i 修正 commit 過的版本歷史紀錄2</a>.markdown)</li>
</ul>


<h3>cherry-pick</h3>

<ul>
<li><code>git cherry-pick</code> 手動挑出其他 branch 中的 commit，合併進來。</li>
<li><code>git cherry-pick [SHA1] -e</code> 建立版本前先編輯訊息。</li>
<li><code>git cherry-pick [SHA1] -n</code> 不建立版本，僅套用其變更。</li>
</ul>


<h3>checkout</h3>

<ul>
<li><code>git checkout [filename]</code> 取消 Working tree 檔案。</li>
<li><code>git checkout master [filename]</code> 把 master 分支中最新版的檔案給還原。</li>
</ul>


<h1>暫存</h1>

<ul>
<li><code>git stash</code> 會將所有已列入追蹤(tracked)的檔案建立暫存版。</li>
<li><code>git stash -u</code>　會包括所有已追蹤或未追蹤的檔案，全部都建立成暫存版。</li>
<li><code>git stash list</code> 顯示出所有的暫存清單。</li>
<li><code>git stash clear</code> 清除所有暫存。</li>
<li><code>git stash pop</code> 復原最新的操作並將他從暫存清單中移除。</li>
<li><code>git stash apply</code> 復原最新的操作，與<code>pop</code>唯一差別則是取回該版本 (其實是執行合併動作) 後，該暫存版還會留在 stash 清單上。</li>
<li><code>git stash drop</code> 刪除最新的暫存操作。</li>
</ul>


<blockquote><p>指定stash ID（如：stash@{1}），則可以復原特定的操作</p></blockquote>

<h1>遠端</h1>

<ul>
<li><code>git remote add origin [url]</code> 註冊遠端儲存庫。</li>
<li><code>git clone [url]</code> 將遠端儲存庫複製到本地，並建立工作目錄與本地儲存庫。</li>
<li><code>git push -u origin master</code> 將本地儲存庫中目前分支的所有相關物件推送到遠端儲存庫中。</li>
<li><code>git fetch</code> 將遠端儲存庫的最新版下載回來，下載的內容包含完整的物件儲存庫(object storage)。 這個命令不包含「合併」分支的動作。</li>
<li><code>git pull -u origin master</code> 將遠端資料庫拉下來，並且合併，相當於 <code>git fetch</code> + <code>git merge</code>。</li>
</ul>


<blockquote><p>加上 <code>-u</code> 後續就只要 <code>git push</code> 和 <code>git pull</code> 即可。</p></blockquote>

<h1>差異</h1>

<ul>
<li><code>git diff</code> 比對「Working tree」與「Staging Area」之間的差異。</li>
<li><code>git diff commit</code> 比對「Working tree」與「指定 commit 物件裡的那個 tree 物件」之間的差異。</li>
<li><code>git diff HEAD</code> 比對「Working tree」與「HEAD」之間的差異。</li>
<li><code>git diff --cached</code>比對「Staging Area」與「HEAD」之間的差異。(可改成 &ndash;staged)</li>
<li><code>git diff commit1(SHA1) commit2(SHA1)</code> 比較兩個 commit 差異。</li>
<li><code>git diff HEAD^ HEAD</code> 比較 HEAD 和 HEAD^ 差異。</li>
</ul>


<h1>記錄</h1>

<h3>log</h3>

<ul>
<li><code>git log</code> 查詢歷史紀錄。</li>
<li><code>git log -10</code> 限定輸出最近幾筆紀錄。</li>
<li><code>git log --oneline --graph --all --decorate</code> 圖像化 log。</li>
</ul>


<h3>reflog</h3>

<ul>
<li><code>git reflog</code> 可列印出所有「歷史紀錄」的版本變化。</li>
<li><code>git log -g</code> 顯示 reflog 的詳細版本記錄。</li>
<li><code>git reflog delete HEAD@{1}</code> 刪除特定幾個版本的歷史紀錄。</li>
</ul>


<h1>標籤</h1>

<ul>
<li><code>git tag</code> 列出所有標籤。</li>
<li><code>git tag -n</code> 顯示標籤的列表和註解。</li>
<li><code>git tag [tagname]</code> 建立輕量標籤。</li>
<li><code>git tag [tagname] -d</code> 刪除輕量標籤。</li>
<li><code>git tag [tagname] -am [版本訊息]</code> 建立標示標籤</li>
</ul>


<blockquote><ol>
<li>輕量標籤 (lightweight tag)

<ul>
<li>不可變更的暫時標籤</li>
<li>可以添加名稱</li>
</ul>
</li>
<li>標示標籤 (annotated tag)

<ul>
<li>可以添加打標簽者的名稱、email及日期</li>
<li>可以添加名稱</li>
<li>可以添加註解</li>
<li>可以添加簽名</li>
</ul>
</li>
</ol>
</blockquote>

<h1>其他</h1>

<ul>
<li><code>.gitkeep</code> 空目錄不會被 commit，必要時在目錄裡放 <code>.gitkeep</code>。</li>
<li><code>vi .gitignore</code> 編輯不要 commit 的檔案 此檔案也要 commit，通常是比較敏感的檔案，像是密碼之類的。</li>
<li><a href="https://github.com/github/gitignore">.gitignore ⼤集合</a></li>
</ul>


<h1>alias</h1>

<p>自己設定的一些 alias</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>alias g='git'
</span><span class='line'>
</span><span class='line'>alias grs='git reset'
</span><span class='line'>alias gci='git commit'
</span><span class='line'>alias gcim='git commit -m'
</span><span class='line'>alias gcim!='git commit --amend -m'
</span><span class='line'>alias gst='git status'
</span><span class='line'>alias gpl='git pull'
</span><span class='line'>alias gplo='git pull origin'
</span><span class='line'>alias gm='git merge'
</span><span class='line'>alias gmo='git merge origin'
</span><span class='line'>
</span><span class='line'>#git add
</span><span class='line'>alias ga='git add'
</span><span class='line'>alias gaa='git add --all'
</span><span class='line'>alias gapa='git add --patch'
</span><span class='line'>
</span><span class='line'>#branch
</span><span class='line'>alias gb='git branch'
</span><span class='line'>alias gbd='git branch -d'
</span><span class='line'>alias gbr='git branch --remote'
</span><span class='line'>alias gba='git branch -a'
</span><span class='line'>
</span><span class='line'>#git push
</span><span class='line'>alias gp='git push'
</span><span class='line'>alias gpo='git push origin'
</span><span class='line'>alias gcp='git cherry-pick'
</span><span class='line'>alias gpd='git push --dry-run'
</span><span class='line'>alias gpoat='git push origin --all && git push origin --tags'
</span><span class='line'>compdef _git gpoat=git-push
</span><span class='line'>alias gpu='git push upstream'
</span><span class='line'>alias gpv='git push -v'
</span><span class='line'>
</span><span class='line'>#git checkout
</span><span class='line'>alias gco='git checkout'
</span><span class='line'>alias gcob='git checkout -b'
</span><span class='line'>alias gcom='git checkout master'
</span><span class='line'>
</span><span class='line'>#git rebase
</span><span class='line'>alias grb='git rebase'
</span><span class='line'>alias grba='git rebase --abort'
</span><span class='line'>alias grbc='git rebase --continue'
</span><span class='line'>alias grbi='git rebase -i'
</span><span class='line'>alias grbm='git rebase master'
</span><span class='line'>alias grbs='git rebase --skip'
</span><span class='line'>
</span><span class='line'>#git stash
</span><span class='line'>alias gsta='git stash'
</span><span class='line'>alias gstd='git stash drop'
</span><span class='line'>alias gstl='git stash list'
</span><span class='line'>alias gstp='git stash pop'
</span><span class='line'>alias gsts='git stash show --text'
</span><span class='line'>
</span><span class='line'>#git log
</span><span class='line'>alias glg='git log --stat --color'
</span><span class='line'>alias glgp='git log --stat --color -p'
</span><span class='line'>alias glgg='git log --graph --color'
</span><span class='line'>alias glgga='git log --graph --decorate --all'
</span><span class='line'>alias glgm='git log --graph --max-count=10'
</span><span class='line'>alias glo='git log --oneline --decorate --color'
</span><span class='line'>alias glol="git log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --abbrev-commit"
</span><span class='line'>alias glola="git log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --abbrev-commit --all"
</span><span class='line'>alias glog='git log --oneline --decorate --color --graph'</span></code></pre></td></tr></table></div></figure>


<p>官方文件：
<a href="http://git-scm.com/book/zh-tw/v1">Git Pro</a></p>

<p>參考資料：
<a href="https://ihower.tw/git/">Git 版本控制系統</a>
<a href="https://github.com/doggy8088/Learn-Git-in-30-days">30 天精通 Git 版本控管</a>
<a href="https://backlogtool.com/git-guide/tw/reference/">連猴子都能懂的git入門</a>
<a href="http://blog.gogojimmy.net/2012/01/17/how-to-use-git-1-git-basic/">好麻煩部落格</a></p>

<p>練習：
<a href="https://try.github.io/levels/1/challenges/1">codeschool</a>
<a href="http://dylandy.github.io/Easy-Git-Tutorial/">Easy-Git-Tutorial</a>
<a href="http://pcottle.github.io/learnGitBranching/">learnGitBranching</a></p>
]]></content>
  </entry>
  
</feed>

<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Leon's Blogging]]></title>
  <link href="http://mgleon08.github.com/atom.xml" rel="self"/>
  <link href="http://mgleon08.github.com/"/>
  <updated>2016-08-28T14:56:31+08:00</updated>
  <id>http://mgleon08.github.com/</id>
  <author>
    <name><![CDATA[LeonJi]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rake 任務管理工具]]></title>
    <link href="http://mgleon08.github.com/blog/2016/08/11/rake/"/>
    <updated>2016-08-11T20:53:30+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/08/11/rake</id>
    <content type="html"><![CDATA[<p>rake 是個任務管理工具，可以將許多任務，寫成一個 rake，之後只要執行指令，就會將所有任務都完成，例如 rake db:create 中的 db:create 就是 Rails 提供的任務。</p>

<!-- more -->


<p>Rakefile</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/core/rake_task&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;Run specs&quot;</span>
</span><span class='line'><span class="no">RSpec</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:spec</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;spec/**/*_spec.rb&quot;</span> <span class="c1">#所有測試文件的位置</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kp">true</span> <span class="c1">#輸出 Rake::TestTask 執行的具體Ruby命令</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">ruby_opts</span> <span class="o">=</span> <span class="s2">&quot;-rtesthelper&quot;</span> <span class="c1">#避免每個測試文件重複 require &quot;test_helper&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Cucumber</span><span class="o">::</span><span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:features</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">cucumber_opts</span> <span class="o">=</span> <span class="s2">&quot;features --format progress&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:spec</span><span class="p">,</span> <span class="ss">:features</span><span class="o">]</span>
</span><span class='line'><span class="c1">#設定 default 要跑的 task，之後只要執行 rake or rake default 就會去執行，spec 和 feature 的 task</span>
</span></code></pre></td></tr></table></div></figure>


<p>之前文章：<br/>
<a href="http://mgleon08.github.io/blog/2016/03/10/custom-tasks/">自己定義 Rake Tasks</a></p>

<p>官方文件：<br/>
<a href="http://rake.rubyforge.org/">RAKE – Ruby Make</a><br/>
<a href="https://relishapp.com/rspec/rspec-core/v/3-4/docs/command-line/rake-task">Rake task rspec</a><br/>
<a href="http://rake.rubyforge.org/classes/Rake/TestTask.html">Class Rake::TestTask</a></p>

<p>參考文件：<br/>
<a href="http://kaochenlong.com/2016/04/30/rake/">Ruby 語法放大鏡之「常在終端機裡下 rake db:migrate 指令，這個 rake 是什麼，後面那個 db:migrate 又是怎麼回事?」</a><br/>
<a href="http://code.oneapm.com/ruby/2015/05/28/ruby-rake-testtask/">Rake::TestTask 介绍</a><br/>
<a href="http://stackoverflow.com/questions/19200734/how-to-convert-array-of-activerecord-models-to-csv">How to convert array of ActiveRecord models to CSV?</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[更改 Rails 命名規則 Inflector]]></title>
    <link href="http://mgleon08.github.com/blog/2016/08/11/inflector/"/>
    <updated>2016-08-11T20:49:39+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/08/11/inflector</id>
    <content type="html"><![CDATA[<p>在 rails 當中，有許多命名的慣例</p>

<!-- more -->


<ul>
<li>像是 <code>hello_controller</code> 檔案，裡面慣例對應到的 Class 就是 <code>Hello_Controller</code></li>
<li>但若是像 <code>api_controller</code>，就會是 <code>Api_Controller</code></li>
</ul>


<p>雖然不是不行，但 API 本來就是縮寫，硬要改成 Api 可能會讓人覺得怪怪的</p>

<p>因此 rails 有提供解決辦法，就能夠將 <code>api_Controller</code> 改成 <code>API_Controller</code></p>

<p>rails 內建有 <code>Inflector</code> 就是用來處理命名規則用的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">/</span><span class="n">initializers</span><span class="o">/</span><span class="n">inflections</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'>
</span><span class='line'><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Inflector</span><span class="o">.</span><span class="n">inflections</span><span class="p">(</span><span class="ss">:en</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">inflect</span><span class="o">|</span>
</span><span class='line'>  <span class="n">inflect</span><span class="o">.</span><span class="n">acronym</span> <span class="s1">&#39;API&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>或是 Rails 轉單複數單字，有錯誤時，可以定義</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#錯誤</span>
</span><span class='line'><span class="s2">&quot;Business&quot;</span><span class="o">.</span><span class="n">singularize</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Busines&quot;</span>
</span><span class='line'><span class="s2">&quot;moose&quot;</span><span class="o">.</span><span class="n">pluralize</span> <span class="o">=&gt;</span> <span class="s2">&quot;mooses&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">/</span><span class="n">initializers</span><span class="o">/</span><span class="n">inflections</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'>
</span><span class='line'><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Inflector</span><span class="o">.</span><span class="n">inflections</span><span class="p">(</span><span class="ss">:en</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">inflect</span><span class="o">|</span>
</span><span class='line'>  <span class="n">inflect</span><span class="o">.</span><span class="n">irregular</span> <span class="s1">&#39;tooth&#39;</span><span class="p">,</span> <span class="s1">&#39;teeth&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>other</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Be sure to restart your server when you modify this file.</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Add new inflection rules using the following format. Inflections</span>
</span><span class='line'><span class="c1"># are locale specific, and you may define rules for as many different</span>
</span><span class='line'><span class="c1"># locales as you wish. All of these examples are active by default:</span>
</span><span class='line'><span class="c1"># ActiveSupport::Inflector.inflections(:en) do |inflect|</span>
</span><span class='line'><span class="c1">#   inflect.plural /^(ox)$/i, &#39;\1en&#39;</span>
</span><span class='line'><span class="c1">#   inflect.singular /^(ox)en/i, &#39;\1&#39;</span>
</span><span class='line'><span class="c1">#   inflect.irregular &#39;person&#39;, &#39;people&#39;</span>
</span><span class='line'><span class="c1">#   inflect.uncountable %w( fish sheep )</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># These inflection rules are supported but not enabled by default:</span>
</span><span class='line'><span class="c1"># ActiveSupport::Inflector.inflections(:en) do |inflect|</span>
</span><span class='line'><span class="c1">#   inflect.acronym &#39;RESTful&#39;</span>
</span><span class='line'><span class="c1"># end</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：</p>

<ul>
<li><a href="http://api.rubyonrails.org/classes/ActiveSupport/Inflector.html">Inflector</a></li>
</ul>


<p>參考文件：</p>

<ul>
<li><a href="https://ruby-china.org/topics/19242">&lsquo;APIController&rsquo; is not a supported controller name</a></li>
<li><a href="https://ihower.tw/rails4/environments-and-bundler.html">環境設定與Bundler</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby on Rails 裝機趴 (Only Mac)]]></title>
    <link href="http://mgleon08.github.com/blog/2016/07/22/install-ruby-on-rails/"/>
    <updated>2016-07-22T19:58:37+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/07/22/install-ruby-on-rails</id>
    <content type="html"><![CDATA[<p>最近剛好新來了一台電腦，所有東西都要重新安裝，就順手把需要的東西都紀錄了一下，以便之後可以快速的安裝起來!</p>

<!-- more -->


<h3>目錄</h3>

<ul>
<li><a href="#iterm2">iTerm2</a></li>
<li><a href="#homebrew">Homebrew</a></li>
<li><a href="#git">Git</a></li>
<li><a href="#github">GitHub</a></li>
<li><a href="#zsh">zsh &amp; oh-my-zsh</a></li>
<li><a href="#rvmorrbenv">rvm or rbenv</a></li>
<li><a href="#rubygems">RubyGems</a></li>
<li><a href="#rails">Rails</a></li>
<li><a href="#bundle">Bundle</a></li>
<li><a href="#nvm">NVM</a></li>
<li><a href="#npm">NPM</a></li>
<li><a href="#sublime">Sublime Text</a></li>
<li><a href="#vim">Vim</a></li>
<li><a href="#linux">Linux</a></li>
<li><a href="#other">Other</a></li>
</ul>


<h1><span id="iterm2">iTerm2</span></h1>

<blockquote><p>Terminal 終端機</p></blockquote>

<ul>
<li><a href="https://www.iterm2.com/">iTerm2</a></li>
</ul>


<h3>tmux</h3>

<ul>
<li><a href="http://blog.chh.tw/posts/tmux-terminal-multiplexer/">終端機必備的多工良伴：tmux</a></li>
</ul>


<h1><span id="homebrew">Homebrew</span></h1>

<blockquote><p>Mac OS X 上的套件管理程式</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#安裝</span>
</span><span class='line'><span class="sr">/usr/</span><span class="n">bin</span><span class="o">/</span><span class="n">ruby</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#homebrew檢查 </span>
</span><span class='line'><span class="n">brew</span> <span class="n">doctor</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#已經裝了哪些套件</span>
</span><span class='line'><span class="n">brew</span> <span class="n">list</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#homebrew更新</span>
</span><span class='line'><span class="n">brew</span> <span class="n">update</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#搜尋套件</span>
</span><span class='line'><span class="n">brew</span> <span class="n">search</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#查詢套件資訊</span>
</span><span class='line'><span class="n">brew</span> <span class="n">info</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#module會裝到/usr/local/opt/xxx</span>
</span><span class='line'><span class="c1">#安裝xxx模組 </span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">xxx</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#更新xxx模組 </span>
</span><span class='line'><span class="n">brew</span> <span class="n">upgrade</span> <span class="n">xxx</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="http://brew.sh/">Homebrew</a></li>
</ul>


<p>推薦套件</p>

<p><a href="http://searchbrew.com/">searchbrew</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#postgresql</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">postgresql</span>
</span><span class='line'><span class="n">gem</span> <span class="n">install</span> <span class="n">pg</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#mysql</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">mysql</span>
</span><span class='line'><span class="n">gem</span> <span class="n">install</span> <span class="n">mysql2</span>
</span><span class='line'><span class="n">mysql</span><span class="o">.</span><span class="n">server</span> <span class="n">start</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#redis</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">redis</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#背景啟動</span>
</span><span class='line'><span class="n">redis</span><span class="o">-</span><span class="n">server</span> <span class="o">--</span><span class="n">daemonize</span> <span class="n">yes</span>
</span><span class='line'><span class="n">redis</span><span class="o">-</span><span class="n">server</span><span class="o">&amp;&amp;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#imagemagick</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">imagemagick</span>
</span><span class='line'><span class="n">gem</span> <span class="n">install</span> <span class="n">rmagick</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#ffmpeg</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">ffmpeg</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#MediaInfo</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">mediainfo</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#wget</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">wget</span>
</span></code></pre></td></tr></table></div></figure>


<h1><span id="git">Git</span></h1>

<blockquote><p>版本控制</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#安裝 git</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">git</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#設定輸出顏色</span>
</span><span class='line'><span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="n">global</span> <span class="n">color</span><span class="o">.</span><span class="n">ui</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#設定 git 的 user 和 email</span>
</span><span class='line'><span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="n">global</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="s2">&quot;YOUR NAME&quot;</span>
</span><span class='line'><span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="n">global</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="s2">&quot;YOUR@EMAIL.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#空白對有些語言是有影響的(像是Ruby)，因此我們會希望 Git 去忽略空白的變化</span>
</span><span class='line'><span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="n">global</span> <span class="n">apply</span><span class="o">.</span><span class="n">whitespace</span> <span class="n">nowarn</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#讓 git 記住你，不需每次上傳 code 都要打帳號密碼</span>
</span><span class='line'><span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="n">global</span> <span class="n">credential</span><span class="o">.</span><span class="n">helper</span> <span class="n">store</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Git GUI</h3>

<ul>
<li><a href="https://www.sourcetreeapp.com/">SourceTree</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#建立 command line 快捷</span>
</span><span class='line'><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/Applications/</span><span class="no">SourceTree</span><span class="o">.</span><span class="n">app</span><span class="o">/</span><span class="no">Contents</span><span class="o">/</span><span class="no">Resources</span><span class="o">/</span><span class="n">stree</span> <span class="sr">/usr/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="http://gitx.frim.nl/">GitX</a></li>
<li><a href="http://jonas.nitro.dk/tig/manual.html#view-scrolling">tig</a></li>
</ul>


<h3>Git 指令</h3>

<ul>
<li><a href="http://mgleon08.github.io/blog/2015/12/27/git-command/">Git 指令操作手冊</a></li>
</ul>


<h1><span id="github">GitHub</span></h1>

<p>設定SSH連接</p>

<blockquote><p>若要沿用舊電腦的 key ， 將舊電腦的 id_rsa &amp; public key 複製過來即可，但因為新電腦第一次登入，會要求輸入就電腦的 key 的密碼</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#本機產生 ssh key (id_rsa（private key）id_rsa.pub（public key）) ~/.ssh/</span>
</span><span class='line'><span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">t</span> <span class="n">rsa</span> <span class="o">-</span><span class="n">C</span> <span class="o">[</span><span class="n">email</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#設定權限(預設應該就有設好，若是自己新開檔案就要設定)</span>
</span><span class='line'><span class="n">chmod</span> <span class="mi">600</span> <span class="n">id_rsa</span>
</span><span class='line'><span class="n">chmod</span> <span class="mi">644</span> <span class="n">id_rsa</span><span class="o">.</span><span class="n">pub</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#在 github 上新增新的 ssh</span>
</span><span class='line'><span class="err">將</span> <span class="n">id_rsa</span><span class="o">.</span><span class="n">pub</span> <span class="err">內容複製過去</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#測試是否能連上 github</span>
</span><span class='line'><span class="n">ssh</span> <span class="o">-</span><span class="n">T</span> <span class="n">git</span><span class="vi">@github</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#查看 ssh 功能</span>
</span><span class='line'><span class="n">man</span> <span class="n">ssh</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#將 key 加入 ssh-agent memory</span>
</span><span class='line'><span class="n">ssh</span><span class="o">-</span><span class="n">add</span> <span class="o">~</span><span class="sr">/.ssh/i</span><span class="n">d_dsa</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#檢查目前的 key</span>
</span><span class='line'><span class="n">ssh</span><span class="o">-</span><span class="n">add</span> <span class="o">-</span><span class="n">l</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#刪除 ssh-agent key</span>
</span><span class='line'><span class="n">ssh</span><span class="o">-</span><span class="n">add</span> <span class="o">-</span><span class="n">d</span> <span class="o">~</span><span class="sr">/.ssh/i</span><span class="n">d_dsa</span><span class="o">.</span><span class="n">pub</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#刪除所有 ssh-agent key</span>
</span><span class='line'><span class="n">ssh</span><span class="o">-</span><span class="n">add</span> <span class="o">-</span><span class="n">D</span> <span class="o">~</span><span class="sr">/.ssh/i</span><span class="n">d_dsa</span><span class="o">.</span><span class="n">pub</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#將 key 永久紀錄</span>
</span><span class='line'><span class="n">ssh</span><span class="o">-</span><span class="n">add</span> <span class="o">-</span><span class="n">K</span> <span class="o">[</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">your</span><span class="o">/</span><span class="n">ssh</span><span class="o">-</span><span class="n">key</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://developer.github.com/guides/using-ssh-agent-forwarding/">Using SSH agent forwarding</a></li>
<li><a href="https://ihower.tw/blog/archives/7837">SSH agent forwarding 的應用</a></li>
<li><a href="http://man.linuxde.net/ssh">ssh命令</a></li>
<li><a href="http://linux.vbird.org/linux_basic/0210filepermission.php#chmod">鳥哥的私房菜 - 權限指令</a></li>
</ul>


<h1><span id="zsh">zsh &amp; oh-my-zsh</span></h1>

<blockquote><p>shell &amp; zsh 的 framework 套件</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#安裝 zsh</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">zsh</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#將 shell 預設改成 zsh，改完記得重開 iterm or source ~/.zshrc</span>
</span><span class='line'><span class="n">chsh</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/bin/</span><span class="n">zsh</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#查看目前使用是哪個 shell</span>
</span><span class='line'><span class="n">echo</span> <span class="vg">$SHELL</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#下載 oh-my-zsh</span>
</span><span class='line'><span class="n">git</span> <span class="nb">clone</span> <span class="ss">git</span><span class="p">:</span><span class="sr">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">robbyrussell</span><span class="o">/</span><span class="n">oh</span><span class="o">-</span><span class="n">my</span><span class="o">-</span><span class="n">zsh</span><span class="o">.</span><span class="n">git</span> <span class="o">~</span><span class="sr">/.oh-my-zsh</span>
</span><span class='line'>
</span><span class='line'><span class="sr">#將 oh-my-zsh 預設的設定複製到 ./</span><span class="o">.</span><span class="n">zshrc</span> <span class="p">(</span><span class="o">.</span><span class="n">zshrc</span> <span class="err">需要自行產生</span><span class="p">)</span>
</span><span class='line'><span class="n">cp</span> <span class="o">~</span><span class="sr">/.oh-my-zsh/</span><span class="n">templates</span><span class="o">/</span><span class="n">zshrc</span><span class="o">.</span><span class="n">zsh</span><span class="o">-</span><span class="n">template</span> <span class="o">~</span><span class="sr">/.zshrc</span>
</span><span class='line'>
</span><span class='line'><span class="sr">#安裝 zsh-completions</span>
</span><span class='line'><span class="sr">brew install zsh-completions</span>
</span><span class='line'>
</span><span class='line'><span class="sr">#加入以下兩行來啟動 zsh-completions</span>
</span><span class='line'><span class="sr">#zsh-completions</span>
</span><span class='line'><span class="sr">fpath=(/us</span><span class="n">r</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">zsh</span><span class="o">-</span><span class="n">completions</span> <span class="vg">$fpath</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#同時還需要 rebuild zsh 的 .zcompdump</span>
</span><span class='line'><span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">~</span><span class="sr">/.zcompdump; compinit</span>
</span><span class='line'>
</span><span class='line'><span class="sr">#更改 theme ( 到 .zshrc 更改 ZSH_THEME 參數 )</span>
</span><span class='line'><span class="sr">ZSH_THEME=&quot;edvardm&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">#啟動 oh-my-zsh 內建的套件，要看有哪些套件可以去 ~/</span><span class="o">.</span><span class="n">oh</span><span class="o">-</span><span class="n">my</span><span class="o">-</span><span class="n">zsh</span> <span class="err">裡面的</span> <span class="n">plugins</span> <span class="err">看裡面的設定</span><span class="p">(</span> <span class="err">到</span> <span class="o">.</span><span class="n">zshrc</span> <span class="err">更改</span> <span class="n">plugins</span> <span class="err">參數</span> <span class="p">)</span>
</span><span class='line'><span class="n">plugins</span><span class="o">=</span><span class="p">(</span><span class="n">git</span> <span class="n">ruby</span> <span class="n">rbenv</span> <span class="n">github</span> <span class="n">gitignore</span> <span class="n">rails</span> <span class="n">rake</span> <span class="n">python</span> <span class="n">z</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://github.com/robbyrussell/oh-my-zsh">oh-my-zsh</a></li>
<li><a href="http://icarus4.logdown.com/posts/177661-from-bash-to-zsh-setup-tips">bash 轉移 zsh (oh-my-zsh) 設定心得</a></li>
</ul>


<h1><span id="rvmorrbenv">rvm or rbenv</span></h1>

<blockquote><p>管理 ruby &amp; gem 工具</p></blockquote>

<h3>rvm</h3>

<ul>
<li><a href="http://mgleon08.github.io/blog/2016/02/15/rvm-and-gemsets/">RVM and Gemsets Ruby版本控制</a></li>
<li><a href="https://ruby-china.org/wiki/rvm-guide">rvm 使用指南</a></li>
</ul>


<h3>rbenv</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#安裝</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">rbenv</span> <span class="n">ruby</span><span class="o">-</span><span class="n">build</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#將指令放到 ~/.zshrc or ~/.bashrc</span>
</span><span class='line'><span class="n">export</span> <span class="no">PATH</span><span class="o">=</span><span class="s2">&quot;$HOME/.rbenv/bin:$PATH&quot;</span>
</span><span class='line'><span class="nb">eval</span> <span class="s2">&quot;$(rbenv init -)&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#列出所有 ruby 版本</span>
</span><span class='line'><span class="n">rbenv</span> <span class="n">install</span> <span class="o">--</span><span class="n">list</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#列出安装的版本</span>
</span><span class='line'><span class="n">rbenv</span> <span class="n">versions</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#列出正在使用的版本</span>
</span><span class='line'><span class="n">rbenv</span> <span class="n">version</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#安裝 ruby (請依照當下最新的版本)</span>
</span><span class='line'><span class="n">rbenv</span> <span class="n">install</span> <span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#設定預設版本</span>
</span><span class='line'><span class="n">rbenv</span> <span class="n">global</span> <span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#確定目前使用的 ruby 是透過 rbenv 而不是內建的(記得重開視窗)</span>
</span><span class='line'><span class="n">which</span> <span class="n">ruby</span>
</span><span class='line'><span class="c1">#=&gt; 確保有 .rbenv/shims/ruby</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#project 加上 .ruby-version 檔案裡面寫 ruby 版本 才能加入控管</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#rbenv 指令</span>
</span><span class='line'><span class="no">Some</span> <span class="n">useful</span> <span class="n">rbenv</span> <span class="n">commands</span> <span class="ss">are</span><span class="p">:</span>
</span><span class='line'>   <span class="n">commands</span>    <span class="no">List</span> <span class="n">all</span> <span class="n">available</span> <span class="n">rbenv</span> <span class="n">commands</span>
</span><span class='line'>   <span class="n">local</span>       <span class="no">Set</span> <span class="ow">or</span> <span class="n">show</span> <span class="n">the</span> <span class="n">local</span> <span class="n">application</span><span class="o">-</span><span class="n">specific</span> <span class="no">Ruby</span> <span class="n">version</span>
</span><span class='line'>   <span class="n">global</span>      <span class="no">Set</span> <span class="ow">or</span> <span class="n">show</span> <span class="n">the</span> <span class="n">global</span> <span class="no">Ruby</span> <span class="n">version</span>
</span><span class='line'>   <span class="n">shell</span>       <span class="no">Set</span> <span class="ow">or</span> <span class="n">show</span> <span class="n">the</span> <span class="n">shell</span><span class="o">-</span><span class="n">specific</span> <span class="no">Ruby</span> <span class="n">version</span>
</span><span class='line'>   <span class="n">install</span>     <span class="no">Install</span> <span class="n">a</span> <span class="no">Ruby</span> <span class="n">version</span> <span class="n">using</span> <span class="n">ruby</span><span class="o">-</span><span class="n">build</span>
</span><span class='line'>   <span class="n">uninstall</span>   <span class="no">Uninstall</span> <span class="n">a</span> <span class="n">specific</span> <span class="no">Ruby</span> <span class="n">version</span>
</span><span class='line'>   <span class="n">rehash</span>      <span class="no">Rehash</span> <span class="n">rbenv</span> <span class="n">shims</span> <span class="p">(</span><span class="n">run</span> <span class="n">this</span> <span class="n">after</span> <span class="n">installing</span> <span class="n">executables</span><span class="p">)</span>
</span><span class='line'>   <span class="n">version</span>     <span class="no">Show</span> <span class="n">the</span> <span class="n">current</span> <span class="no">Ruby</span> <span class="n">version</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">origin</span>
</span><span class='line'>   <span class="n">versions</span>    <span class="no">List</span> <span class="n">all</span> <span class="no">Ruby</span> <span class="n">versions</span> <span class="n">available</span> <span class="n">to</span> <span class="n">rbenv</span>
</span><span class='line'>   <span class="n">which</span>       <span class="no">Display</span> <span class="n">the</span> <span class="n">full</span> <span class="n">path</span> <span class="n">to</span> <span class="n">an</span> <span class="n">executable</span>
</span><span class='line'>   <span class="n">whence</span>      <span class="no">List</span> <span class="n">all</span> <span class="no">Ruby</span> <span class="n">versions</span> <span class="n">that</span> <span class="n">contain</span> <span class="n">the</span> <span class="n">given</span> <span class="n">executable</span>
</span></code></pre></td></tr></table></div></figure>


<p>rbenv-gemset</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#安裝 rbenv-gemset</span>
</span><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">rbenv</span><span class="o">-</span><span class="n">gemset</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#rbenv gemset 指令</span>
</span><span class='line'><span class="n">possible</span> <span class="n">commands</span> <span class="ss">are</span><span class="p">:</span>
</span><span class='line'>  <span class="n">active</span>
</span><span class='line'>  <span class="n">create</span> <span class="o">[</span><span class="n">version</span><span class="o">]</span> <span class="o">[</span><span class="n">gemset</span><span class="o">]</span>
</span><span class='line'>  <span class="n">delete</span> <span class="o">[</span><span class="n">version</span><span class="o">]</span> <span class="o">[</span><span class="n">gemset</span><span class="o">]</span>
</span><span class='line'>  <span class="n">file</span>
</span><span class='line'>  <span class="n">init</span> <span class="o">[</span><span class="n">gemset</span><span class="o">]</span>
</span><span class='line'>  <span class="n">list</span>
</span><span class='line'>  <span class="n">version</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#使用方法</span>
</span><span class='line'><span class="err">將想要使用的</span> <span class="n">gemset</span> <span class="err">名稱，放到</span> <span class="o">.</span><span class="n">rbenv</span><span class="o">-</span><span class="n">gemsets</span> <span class="err">檔案即可，在該專案執行</span> <span class="n">bundle</span> <span class="err">就會對設定好的</span> <span class="n">gemset</span> <span class="err">進行操作</span>
</span><span class='line'><span class="err">若是沒有設定該檔案就會是</span> <span class="n">global</span> <span class="err">的</span> <span class="n">bundle</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://ruby-china.org/wiki/rbenv-guide">rbenv 使用指南</a></li>
</ul>


<h1><span id="rubygems">RubyGems</span></h1>

<blockquote><p>RubyGems 是 Ruby 的套件管理系統，讓你輕易安裝及管理 Ruby 函式庫。</p></blockquote>

<p><a href="https://rubygems.org/">RubyGems.org</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#RubyGems 的版本</span>
</span><span class='line'><span class="n">gem</span> <span class="o">-</span><span class="n">v</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#升級RubyGems的版本</span>
</span><span class='line'><span class="n">gem</span> <span class="n">update</span> <span class="o">--</span><span class="nb">system</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#安裝某個套件(加上 --no-ri --no-rdoc 可以不要產生預設的 RDoc和ri文件)</span>
</span><span class='line'><span class="n">gem</span> <span class="n">install</span> <span class="n">gem_name</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">ri</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">rdoc</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#列出安裝的套件</span>
</span><span class='line'><span class="n">gem</span> <span class="n">list</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#更新最新版本</span>
</span><span class='line'><span class="n">gem</span> <span class="n">update</span> <span class="n">gem_name</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#更新所有你安裝的Gems</span>
</span><span class='line'><span class="n">gem</span> <span class="n">update</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#安裝特定版本</span>
</span><span class='line'><span class="n">gem</span> <span class="n">install</span> <span class="o">-</span><span class="n">v</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span> <span class="n">gemname</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#反安裝</span>
</span><span class='line'><span class="n">gem</span> <span class="n">uninstall</span> <span class="n">gem_name</span>
</span></code></pre></td></tr></table></div></figure>


<h1><span id="rails">Rails</span></h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#後面的參數是不下載文件，可以省很多安裝時間</span>
</span><span class='line'><span class="n">gem</span> <span class="n">install</span> <span class="n">rails</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">ri</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">rdoc</span>
</span></code></pre></td></tr></table></div></figure>


<h1><span id="bundle">Bundle</span></h1>

<blockquote><p>管理應用程式 Gem 依存性(dependencies)管理工具，它會根據 Gemfile 的設定自動下載及安裝 Gem 套件</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="n">install</span> <span class="n">bundler</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="http://bundler.io/">bundle</a></li>
</ul>


<h1><span id="nvm">NVM</span></h1>

<blockquote><p>管理 npm 工具，類似 rvm</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#根據當下最新版本</span>
</span><span class='line'><span class="n">curl</span> <span class="o">-</span><span class="n">o</span><span class="o">-</span> <span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">creationix</span><span class="o">/</span><span class="n">nvm</span><span class="o">/</span><span class="n">v0</span><span class="o">.</span><span class="mi">31</span><span class="o">.</span><span class="mi">4</span><span class="o">/</span><span class="n">install</span><span class="o">.</span><span class="n">sh</span> <span class="o">|</span> <span class="n">bash</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#將以下放到自己的 ~/.zshrc or ~/.bashrc or .bash_profile 下面（預設會自動放好，但還是去確定一下）</span>
</span><span class='line'><span class="n">export</span> <span class="no">NVM_DIR</span><span class="o">=</span><span class="s2">&quot;/Users/leon/.nvm&quot;</span>
</span><span class='line'><span class="o">[</span> <span class="o">-</span><span class="n">s</span> <span class="s2">&quot;$NVM_DIR/nvm.sh&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">.</span> <span class="s2">&quot;$NVM_DIR/nvm.sh&quot;</span>  <span class="c1"># This loads nvm%</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#重新載入 Shell</span>
</span><span class='line'><span class="o">.</span> <span class="o">~</span><span class="sr">/.nvm/n</span><span class="n">vm</span><span class="o">.</span><span class="n">sh</span> <span class="ow">or</span> <span class="n">source</span> <span class="o">~</span><span class="sr">/.zshrc</span>
</span><span class='line'>
</span><span class='line'><span class="sr"># 安裝穩定版本的 NodeJS</span>
</span><span class='line'><span class="sr">nvm install stable </span>
</span><span class='line'>
</span><span class='line'><span class="sr">#顯示目前可以安裝的版本</span>
</span><span class='line'><span class="sr">nvm ls-remote</span>
</span><span class='line'>
</span><span class='line'><span class="sr">#安裝 NodeJS</span>
</span><span class='line'><span class="sr">nvm install &lt;version&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">#安裝穩定版本的 NodeJS</span>
</span><span class='line'><span class="sr">nvm install stable </span>
</span><span class='line'><span class="sr"> </span>
</span><span class='line'><span class="sr">#使用版本，只有在當下，重新開新tab就會消失</span>
</span><span class='line'><span class="sr">nvm use stable </span>
</span><span class='line'><span class="sr"> </span>
</span><span class='line'><span class="sr">#設定預設版本，永久</span>
</span><span class='line'><span class="sr">nvm alias default stable</span>
</span><span class='line'>
</span><span class='line'><span class="sr">#看目前安裝所有版本</span>
</span><span class='line'><span class="sr">ls -a ~/</span><span class="o">.</span><span class="n">nvm</span><span class="o">/</span><span class="n">versions</span><span class="o">/</span><span class="n">node</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://segmentfault.com/a/1190000004404505">node版本管理工具nvm-Mac下安装及使用</a></li>
<li><a href="https://tenten.co/blog/install-gulp-grunt-bower-sass-susy-on-mac-with-nvm-rvm/">在 Mac 上裝 NVM, RVM 等跑 Gulp, Grunt, Bower 環境</a></li>
<li><a href="http://icarus4.logdown.com/posts/175092-nodejs-installation-guide">Node.js 安裝與版本切換教學 (for MAC)</a></li>
</ul>


<h1><span id="npm">NPM</span></h1>

<blockquote><p>套件管理</p></blockquote>

<p><a href="https://www.npmjs.com/">npm</a></p>

<p>資料夾一定會有 package.json</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#搜尋 npm 套件，但建議去網站上比較快</span>
</span><span class='line'><span class="n">npm</span> <span class="n">search</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#本地安裝，會安裝在當前專案的 node_modules 目錄下</span>
</span><span class='line'><span class="n">npm</span> <span class="n">install</span> <span class="o">&lt;</span><span class="n">package</span> <span class="nb">name</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#全域安裝，會將套件安裝在統一的 npm 目錄底下</span>
</span><span class='line'><span class="n">npm</span> <span class="n">install</span> <span class="o">-</span><span class="n">g</span> <span class="o">&lt;</span><span class="n">package</span> <span class="nb">name</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#列出專案使用套件</span>
</span><span class='line'><span class="n">npm</span> <span class="n">ls</span> <span class="p">(</span><span class="o">-</span><span class="n">g</span> <span class="err">全域套件</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#更新專案套件</span>
</span><span class='line'><span class="n">npm</span> <span class="n">update</span> <span class="p">(</span><span class="o">-</span><span class="n">g</span> <span class="err">全域套件</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#移除專案套件</span>
</span><span class='line'><span class="n">npm</span> <span class="n">uninstall</span> <span class="o">&lt;</span><span class="n">package</span> <span class="nb">name</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">-</span><span class="n">g</span> <span class="err">全域套件</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#清快取</span>
</span><span class='line'><span class="n">npm</span> <span class="n">cache</span> <span class="n">clean</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#查詢 npm 儲存路徑</span>
</span><span class='line'><span class="n">npm</span> <span class="n">config</span> <span class="n">get</span> <span class="n">prefix</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#自動安裝 package.json 套件定義檔中定義的所有套件</span>
</span><span class='line'><span class="n">npm</span> <span class="n">install</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#安裝套件並儲存在 package.json 中</span>
</span><span class='line'><span class="n">npm</span> <span class="n">install</span> <span class="o">&lt;</span><span class="n">package</span> <span class="nb">name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">save</span> <span class="c1">#套件發行時宣告的相依套件</span>
</span><span class='line'><span class="n">npm</span> <span class="n">install</span> <span class="o">&lt;</span><span class="n">package</span> <span class="nb">name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="n">dev</span> <span class="c1">#開發環境開發時需要的套件</span>
</span></code></pre></td></tr></table></div></figure>


<h3>package.json</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#自動產生 package.json</span>
</span><span class='line'><span class="n">npm</span> <span class="n">init</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="err"> </span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;leon&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="err"> </span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="err"> </span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="err"> </span><span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;index.js&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="err"> </span><span class="s2">&quot;scripts&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'> <span class="err"> </span> <span class="err"> </span><span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;echo </span><span class="se">\&quot;</span><span class="s2">Error: no test specified</span><span class="se">\&quot;</span><span class="s2"> &amp;&amp; exit 1&quot;</span>
</span><span class='line'> <span class="err"> </span><span class="p">},</span>
</span><span class='line'> <span class="err"> </span><span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="err"> </span><span class="s2">&quot;license&quot;</span><span class="p">:</span> <span class="s2">&quot;ISC&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="err"> </span><span class="s2">&quot;dependencies&quot;</span><span class="p">:{</span><span class="c1">#套件相依</span>
</span><span class='line'> <span class="err"> </span><span class="p">},</span>
</span><span class='line'> <span class="err"> </span><span class="s2">&quot;devDependencies&quot;</span><span class="p">:</span> <span class="p">{</span><span class="c1">#開發套件相依</span>
</span><span class='line'><span class="err">    </span><span class="s2">&quot;lodash&quot;</span><span class="p">:</span> <span class="s2">&quot;^4.15.0&quot;</span> <span class="c1">#示範加上去的</span>
</span><span class='line'> <span class="err"> </span><span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="http://www.slideshare.net/wantingj/npm-46801372">Npm 套件管理 &amp; 常用開發工具介紹</a></li>
</ul>


<h1><span id="sublime">Sublime Text</span></h1>

<blockquote><p>編輯器</p></blockquote>

<p>安裝好用的套件管理 <a href="https://packagecontrol.io/installation">package control</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">All</span> <span class="no">Autocomplete</span>
</span><span class='line'><span class="no">AutoFileName</span>
</span><span class='line'><span class="no">Alignment</span>
</span><span class='line'><span class="no">Color</span> <span class="no">Highlighter</span>
</span><span class='line'><span class="no">CovertToUTF8</span>
</span><span class='line'><span class="no">Emmet</span>
</span><span class='line'><span class="no">GitGutter</span>
</span><span class='line'><span class="no">SideBarEnhancement</span>
</span><span class='line'><span class="no">BracketHighlighter</span>
</span><span class='line'><span class="no">SublimeCodeIntel</span>
</span><span class='line'><span class="no">PrettyRuby</span>
</span><span class='line'><span class="no">PrettyJson</span>
</span><span class='line'><span class="no">PrettyYaml</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#theme</span>
</span><span class='line'><span class="no">Spacegray</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/kkga/spacegray">Spacegray</a></p>

<p>Prefrences > Setting-User</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;font_size&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;hightlight_line&quot;</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;tab_size&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;translate_tabs_to_spaces&quot;</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;trim_trailing_white_space_on_save&quot;</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;ignored_packages&quot;</span><span class="p">:</span>
</span><span class='line'>  <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;Vintage&quot;</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>建立快速鍵</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span> <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="o">[</span><span class="s2">&quot;super+shift+h&quot;</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;pretty_ruby_format&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>設定快速command <code>subl .</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#建立 bin 資料夾，建立軟連結到指定的檔案</span>
</span><span class='line'><span class="n">mkdir</span> <span class="o">~</span><span class="sr">/bin </span>
</span><span class='line'><span class="sr">ln -s &quot;/</span><span class="no">Applications</span><span class="o">/</span><span class="no">Sublime</span> <span class="no">Text</span><span class="o">.</span><span class="n">app</span><span class="o">/</span><span class="no">Contents</span><span class="o">/</span><span class="no">SharedSupport</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">subl</span><span class="s2">&quot; ~/bin/subl</span>
</span><span class='line'>
</span><span class='line'><span class="s2">#若是 echo $PATH 沒有相對應的路徑，可以在 .zshrc 加上</span>
</span><span class='line'><span class="s2">export PATH=&quot;</span><span class="vg">$HOME</span><span class="o">/</span><span class="ss">bin</span><span class="p">:</span><span class="vg">$PATH</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://packagecontrol.io/installation">package control</a></li>
<li><a href="https://www.sublimetext.com/">Sublime Text</a></li>
</ul>


<h1><span id="vim">Vim</span></h1>

<p>介面優化，新增 <code>.vimrc</code> 檔案</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#顯示行號：對於 debug 相當有幫助! (加上 run 數字會跟著跑)</span>
</span><span class='line'><span class="ss">:set</span> <span class="n">nu</span> <span class="n">rnu</span>
</span><span class='line'><span class="c1">#自動對齊縮排：如果上一行有兩個 tab 的寬度，按 enter 繼續編輯下一行時會自動保留兩個 tab 鍵的寬度。</span>
</span><span class='line'><span class="ss">:set</span> <span class="n">ai</span>
</span><span class='line'><span class="c1">#光標底線：光標所在的那一行會有底線，幫助尋找光標位置</span>
</span><span class='line'><span class="ss">:set</span> <span class="n">cursorline</span>
</span><span class='line'><span class="c1">#上色模式-針對亮背景上色，預設為亮背景(白色等)上色，但是終端機的初始背景色為深紫色，會出現文字失蹤 ( 例如註解為深藍色 ) 的情況。將這一行換成 :set bg=dark 即可。</span>
</span><span class='line'><span class="ss">:set</span> <span class="n">bg</span><span class="o">=</span><span class="n">light</span>
</span><span class='line'><span class="c1">#縮排間隔數 ( 預設為 8 個空白對齊 )，也就是說按一次 tab 鍵，游標會自動跳 4 格空白字元的寬度。雖有多個空格但實際上只有一個 tab 字元。注意：也就是說，在其他環境下，看到 tab 字元，依舊是 8 個空白寬</span>
</span><span class='line'><span class="ss">:set</span> <span class="n">tabstop</span><span class="o">=</span><span class="mi">4</span>
</span><span class='line'><span class="c1">#自動縮排對齊間隔數：向右或向左一個縮排的寬度</span>
</span><span class='line'><span class="ss">:set</span> <span class="n">shiftwidth</span><span class="o">=</span><span class="mi">4</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="http://wiki.csie.ncku.edu.tw/vim/vimrc">vimrc設定教學</a></li>
<li><a href="http://www2.nsysu.edu.tw/csmlab/unix/vi_command.htm">vi指令說明(完整版)</a></li>
</ul>


<h1><span id="linux">Linux 常用指令</span></h1>

<ul>
<li><a href="http://jdev.tw/blog/3599/linux-terminal-commands-and-shortcuts">Linux常用Terminal命令與快捷鍵參考</a></li>
</ul>


<h1><span id="other">other</span></h1>

<ul>
<li><a href="http://macdown.uranusjr.com/">MacDown</a></li>
<li><a href="http://www.sequelpro.com/">Sequel Pro</a></li>
<li><a href="https://eggerapps.at/postico/">Postico</a></li>
<li><a href="https://www.getpostman.com/app/postman-osx">PostMan</a></li>
</ul>


<p>參考文件：</p>

<ul>
<li><a href="https://github.com/yuyueugene84/ntu_ror_training_course/blob/master/installation_mac.md">Ruby on Rails Mac 安裝教學</a></li>
<li><a href="https://ihower.tw/rails4/installation.html">安裝 Rails 開發環境</a></li>
<li><a href="https://tenten.co/blog/install-gulp-grunt-bower-sass-susy-on-mac-with-nvm-rvm/">在 Mac 上裝 NVM, RVM 等跑 Gulp, Grunt, Bower 環境</a></li>
<li><a href="https://segmentfault.com/a/1190000004404505">node版本管理工具nvm-Mac下安装及使用</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Custom Seed File]]></title>
    <link href="http://mgleon08.github.com/blog/2016/07/04/custom-seed-file/"/>
    <updated>2016-07-04T22:27:18+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/07/04/custom-seed-file</id>
    <content type="html"><![CDATA[<p>在 <code>db</code> 下有個 seed.rb，可以寫一些假資料 or 要匯入的資料，在執行 <code>rake db:seed</code> 就會執行了<br/>
但是當有多個檔案，就可以自己寫個 <code>task</code> 來覆蓋原本的 <code>rake db:seed</code></p>

<!-- more -->


<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#檔案可以放在 db/seeds 資料夾底下</span>
</span><span class='line'><span class="c1">#db/seeds/hello.rb</span>
</span><span class='line'><span class="nb">puts</span> <span class="s1">&#39;hello&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#lib/tasks/custom_seed.rake</span>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">namespace</span> <span class="ss">:seed</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">[</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;seeds&#39;</span><span class="p">,</span> <span class="s1">&#39;*.rb&#39;</span><span class="p">)</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
</span><span class='line'>      <span class="n">task_name</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;.rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">intern</span>
</span><span class='line'>      <span class="n">task</span> <span class="n">task_name</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>        <span class="nb">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著執行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">seed</span><span class="p">:</span><span class="n">hello</span>
</span><span class='line'><span class="c1">#=&gt;hello</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件： <br/>
<a href="http://stackoverflow.com/questions/19872271/adding-a-custom-seed-file">Adding a custom seed file</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[好用的 Hash Method]]></title>
    <link href="http://mgleon08.github.com/blog/2016/07/04/rails-hash/"/>
    <updated>2016-07-04T21:58:11+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/07/04/rails-hash</id>
    <content type="html"><![CDATA[<p>在 rails 當中經常會使用 hash，rails 也提供很多方便的 methods</p>

<!--more-->


<h1>Hash</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Hash</span><span class="o">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="o">]</span>             <span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;200}</span>
</span><span class='line'><span class="no">Hash</span><span class="o">[</span> <span class="o">[</span> <span class="o">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="o">]</span> <span class="o">]</span> <span class="o">]</span>   <span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;200}</span>
</span><span class='line'><span class="no">Hash</span><span class="o">[</span><span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="o">]</span>         <span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;200}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>merge &amp; merge!</h1>

<p>回傳新的 hash，後面一樣的 key 則會覆蓋前面的</p>

<blockquote><p>以後面的為優先</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">200</span> <span class="p">}</span>
</span><span class='line'><span class="n">h2</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">254</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span> <span class="o">=&gt;</span> <span class="mi">300</span> <span class="p">}</span>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>   <span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;254, &quot;c&quot;=&gt;300}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#將重複的做其他處理</span>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">h2</span><span class="p">){</span><span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="o">|</span> <span class="n">newval</span> <span class="o">-</span> <span class="n">oldval</span><span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;54,  &quot;c&quot;=&gt;300}</span>
</span><span class='line'><span class="n">h1</span>             <span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;200}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>merge!</code> 直接改變原先的 hash</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;254, &quot;c&quot;=&gt;300}</span>
</span><span class='line'><span class="n">h1</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;254, &quot;c&quot;=&gt;300}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>reverse_merge &amp; reverse_merge!</h1>

<p>回傳新的 hash，前面一樣的 key 則會覆蓋後面的</p>

<p>通常用在指定hash的預設值</p>

<blockquote><p>以前面的為優先</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">200</span> <span class="p">}</span>
</span><span class='line'><span class="n">h2</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">254</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span> <span class="o">=&gt;</span> <span class="mi">300</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;254, &quot;c&quot;=&gt;300}</span>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">reverse_merge</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;b&quot;=&gt;200, &quot;c&quot;=&gt;300, &quot;a&quot;=&gt;100}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>deep_merge &amp; deep_merge!</h1>

<p>在兩個hash的鍵值相同，而值也是個hash的情況下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:a</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:b</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">}}</span>
</span><span class='line'><span class="n">h2</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:a</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:c</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">}}</span>
</span><span class='line'>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {:a=&gt;{:c=&gt;2}} error</span>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">deep_merge</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {:a=&gt;{:b=&gt;1, :c=&gt;2}}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>fetch</h1>

<p>即使是 nil, false 也會回傳，只有在空值的時候回傳預設值</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">,</span> <span class="s1">&#39;c&#39;</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;false, &quot;c&quot;=&gt;nil}</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 100</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; false</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; nil</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 8</span>
</span></code></pre></td></tr></table></div></figure>


<p>在處理應該存在的哈希鍵時，使用 fetch。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">heroes</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">batman</span><span class="p">:</span> <span class="s1">&#39;Bruce Wayne&#39;</span><span class="p">,</span> <span class="ss">superman</span><span class="p">:</span> <span class="s1">&#39;Clark Kent&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># bad - if we make a mistake we might not spot it right away</span>
</span><span class='line'><span class="n">heroes</span><span class="o">[</span><span class="ss">:batman</span><span class="o">]</span> <span class="c1"># =&gt; &quot;Bruce Wayne&quot;</span>
</span><span class='line'><span class="n">heroes</span><span class="o">[</span><span class="ss">:supermann</span><span class="o">]</span> <span class="c1"># =&gt; nil</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># good - fetch raises a KeyError making the problem obvious</span>
</span><span class='line'><span class="n">heroes</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:supermann</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>在使用 fetch 時，使用第二個參數設置默認值而不是使用自定義的邏輯。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">batman</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Bruce Wayne&#39;</span><span class="p">,</span> <span class="ss">is_evil</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># bad - if we just use || operator with falsy value we won&#39;t get the expected result</span>
</span><span class='line'><span class="n">batman</span><span class="o">[</span><span class="ss">:is_evil</span><span class="o">]</span> <span class="o">||</span> <span class="kp">true</span> <span class="c1"># =&gt; true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># good - fetch work correctly with falsy values</span>
</span><span class='line'><span class="n">batman</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:is_evil</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span> <span class="c1"># =&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<p>盡量用 fetch 加區塊而不是直接設定默認值。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">batman</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Bruce Wayne&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># bad - if we use the default value, we eager evaluate it</span>
</span><span class='line'><span class="c1"># so it can slow the program down if done multiple times</span>
</span><span class='line'><span class="n">batman</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:powers</span><span class="p">,</span> <span class="n">get_batman_powers</span><span class="p">)</span> <span class="c1"># get_batman_powers is an expensive call</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># good - blocks are lazy evaluated, so only triggered in case of KeyError exception</span>
</span><span class='line'><span class="n">batman</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:powers</span><span class="p">)</span> <span class="p">{</span> <span class="n">get_batman_powers</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>except &amp; except!</h1>

<p>通常用在確保某些欄位不要被傳進來的參數修改到</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">a</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span><span class="mi">200</span> <span class="p">}</span>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">except</span><span class="p">(</span><span class="ss">:a</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>symbolize_keys &amp; symbolize_keys!</h1>

<p>回傳新的 hash，key 值轉成 symbol</p>

<blockquote><p>通常用在確保 key 的一致性</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Rob&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;28&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">hash</span><span class="o">.</span><span class="n">symbolize_keys</span>
</span><span class='line'><span class="c1"># =&gt; {:name=&gt;&quot;Rob&quot;, :age=&gt;&quot;28&quot;}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>stringify_keys &amp; stringify_keys!</h1>

<p>回傳新的 hash，key 值轉成 string</p>

<p>alias <code>to_options</code> &amp; <code>to_options!</code></p>

<blockquote><p>通常用在確保 key 的一致性</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Rob&#39;</span><span class="p">,</span> <span class="ss">age</span><span class="p">:</span> <span class="s1">&#39;28&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">hash</span><span class="o">.</span><span class="n">stringify_keys</span>
</span><span class='line'><span class="c1">#=&gt; { &quot;name&quot; =&gt; &quot;Rob&quot;, &quot;age&quot; =&gt; &quot;28&quot; }</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#若有衝突已後面為優先</span>
</span><span class='line'><span class="p">{</span><span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:a</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">}</span><span class="o">.</span><span class="n">stringify_keys</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;2}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>slice &amp; slice!</h1>

<p>有 <code>!</code> 行為會不太一樣，要注意</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">200</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100}</span>
</span><span class='line'><span class="n">h1</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;200}</span>
</span><span class='line'>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">slice!</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;b&quot;=&gt;200}</span>
</span><span class='line'><span class="n">h1</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>extract!</h1>

<p>將需要的值提取出來，成為新的 hash</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="mi">200</span> <span class="p">}</span>
</span><span class='line'><span class="n">h1</span><span class="o">.</span><span class="n">extract!</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100}</span>
</span><span class='line'><span class="n">h1</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;b&quot;=&gt;200}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>to_query</h1>

<p>Alias for Hash#to_query</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;David&#39;</span><span class="p">,</span> <span class="ss">nationality</span><span class="p">:</span> <span class="s1">&#39;Danish&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">to_query</span>
</span><span class='line'><span class="c1">#=&gt; &quot;name=David&amp;nationality=Danish&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;David&#39;</span><span class="p">,</span> <span class="ss">nationality</span><span class="p">:</span> <span class="s1">&#39;Danish&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">to_query</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; &quot;user%5Bname%5D=David&amp;user%5Bnationality%5D=Danish&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>values_at</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># bad</span>
</span><span class='line'><span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;email&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">nickname</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;nickname&#39;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># good</span>
</span><span class='line'><span class="n">email</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;nickname&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>other</h1>

<h3>attributes</h3>

<p>將物件轉成 hash</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">foo</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="c1">#=&gt; #&lt;Book id: 22, name: &quot;book&quot;, desc: &quot;desc&quot;, created_at: &quot;xxx&quot;, updated_at: &quot;xxx&quot;&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">foo</span><span class="o">.</span><span class="n">attributes</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;id&quot;=&gt;22, &quot;name&quot;=&gt;&quot;book&quot;, &quot;desc&quot;=&gt;&quot;desc&quot;, &quot;star&quot;=&gt;1, &quot;created_at&quot;=&gt;xxx, &quot;updated_at&quot;=&gt;xxx}</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://ruby-doc.org/core-2.1.5/Hash.html">Ruby Doc Hash</a><br/>
<a href="http://apidock.com/rails/v4.2.1/Hash">Hash apidock</a></p>

<p>參考文件：<br/>
<a href="https://ihower.tw/rails4/activesupport.html">ActiveSupport - 工具函式庫</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Class << Self]]></title>
    <link href="http://mgleon08.github.com/blog/2016/07/04/class-self/"/>
    <updated>2016-07-04T00:01:37+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/07/04/class-self</id>
    <content type="html"><![CDATA[<p>有時會看到這種特別的寫法 <code>class &lt;&lt; self</code>，有兩種不同的用法</p>

<!-- more -->


<h1>class method</h1>

<p>將所以需要 <code>self.</code> 全部包在裡面，就不用一個一個 <code>self.</code><br/>
不過這比較看是個人偏好，有些人會覺得 <code>self.</code> 可讀性較高</p>

<p><a href="http://stackoverflow.com/questions/10964081/class-self-vs-self-method-with-ruby-whats-better">class &lt;&lt; self vs self.method with Ruby: what&rsquo;s better?</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Foo</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">bar</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s1">&#39;bar&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">bar2</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s1">&#39;bar2&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="no">Foo</span><span class="o">.</span><span class="n">bar</span>
</span><span class='line'><span class="c1">#bar</span>
</span><span class='line'><span class="nb">puts</span> <span class="no">Foo</span><span class="o">.</span><span class="n">bar2</span>
</span><span class='line'><span class="c1">#bar2</span>
</span></code></pre></td></tr></table></div></figure>


<p>上下相等</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Foo</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">bar</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s1">&#39;bar&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">bar2</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s1">&#39;bar2&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="no">Foo</span><span class="o">.</span><span class="n">bar</span>
</span><span class='line'><span class="c1">#bar</span>
</span><span class='line'><span class="nb">puts</span> <span class="no">Foo</span><span class="o">.</span><span class="n">bar2</span>
</span><span class='line'><span class="c1">#bar2</span>
</span></code></pre></td></tr></table></div></figure>


<h1>對單一物件，宣告出一個類別</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Foo</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;foo&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">f1</span> <span class="o">=</span> <span class="no">Foo</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">f2</span> <span class="o">=</span> <span class="no">Foo</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">f1</span><span class="o">.</span><span class="n">foo</span> <span class="c1"># foo</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">f2</span><span class="o">.</span><span class="n">foo</span> <span class="c1"># foo</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 只對f1 修改方法</span>
</span><span class='line'><span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">f1</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;Edit foo&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">f1</span><span class="o">.</span><span class="n">foo</span> <span class="c1"># Edit foo</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">f2</span><span class="o">.</span><span class="n">foo</span> <span class="c1"># foo</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 只對f1 新增方法</span>
</span><span class='line'><span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">f1</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">bar</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;bar&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">f1</span><span class="o">.</span><span class="n">bar</span> <span class="c1"># bar</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">f2</span><span class="o">.</span><span class="n">bar</span> <span class="c1"># undefined method `bar&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：<br/>
<a href="http://wemee.blogspot.tw/2014/07/ruby-class.html">Ruby: class &lt;&lt; self</a><br/>
<a href="http://stackoverflow.com/questions/10964081/class-self-vs-self-method-with-ruby-whats-better">class &lt;&lt; self vs self.method with Ruby: what&rsquo;s better?</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Retrieving Multiple Objects in Batches 批次取出多筆記錄]]></title>
    <link href="http://mgleon08.github.com/blog/2016/06/22/retrieving-multiple-objects-in-batches/"/>
    <updated>2016-06-22T00:32:45+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/06/22/retrieving-multiple-objects-in-batches</id>
    <content type="html"><![CDATA[<p>當要處理多筆資料時，一般都會用 User.all 去取資料</p>

<!-- more -->


<p>但是當資料相當龐大，一次取出那麼多會非常佔用記憶體<br/>
因此有以下解決方式，一次拿一部分（預設為1000）</p>

<h1>find_each</h1>

<ul>
<li>一筆一筆放入區塊。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">find_each</span><span class="p">(</span><span class="ss">start</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="ss">batch_size</span><span class="p">:</span> <span class="mi">5000</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
</span><span class='line'>  <span class="no">NewsMailer</span><span class="o">.</span><span class="n">weekly</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">deliver_now</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#:start 選項可以設定批次的起始 ID。</span>
</span><span class='line'><span class="c1">#:batch_size 選項允許你在將各筆記錄傳進區塊前，指定一批要取多少筆記錄。</span>
</span></code></pre></td></tr></table></div></figure>


<h1>find_in_batches</h1>

<ul>
<li>取出記錄放入陣列傳至區塊</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Invoice</span><span class="o">.</span><span class="n">find_in_batches</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoices</span><span class="o">|</span>
</span><span class='line'>  <span class="n">export</span><span class="o">.</span><span class="n">add_invoices</span><span class="p">(</span><span class="n">invoices</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#和 find_each 一樣的選項 :batch_size 與 :start。</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方資料：<br/>
<a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a><br/>
<a href="http://rails.ruby.tw/active_record_querying.html">Active Record 查詢</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Cache Etag Memcache]]></title>
    <link href="http://mgleon08.github.com/blog/2016/06/13/cache-etag-memcache/"/>
    <updated>2016-06-13T23:22:01+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/06/13/cache-etag-memcache</id>
    <content type="html"><![CDATA[<p>當有資料不常去做更動，就能夠用 cache 去讀取增加速度!</p>

<!-- more -->


<ul>
<li>cache 處太多，程式會變複雜，增加維護的難度</li>
<li>cache 會增加除錯難度，資料不再只有唯一的資料庫版本</li>
<li>cache 如果沒寫好，可能會產生資料不一致的Bug、時間顯示相關的Bug(例如顯示資料的時間雖然時間不會變，但是如果是要顯示多少小時以前，就會變動了)等等</li>
<li>cache 增加了寫程式的難度，像是Expire過期資料、資料的安全性(放在cache 層的資料也需要被保護注意安全)</li>
<li>會增加撰寫UI的難度，因為 cache 相關的程式可能會混在樣本中</li>
</ul>


<h1>Cache Store</h1>

<ul>
<li>預設的 memory_store 只適合單機開發，重啟 Rails cache 資料就不見了。</li>
<li>正式上線的網站會推薦使用 <code>Memcached</code></li>
<li>它是一套Name-Value Pair(NVP)分散式記憶體快取系統，當你有多個Rails伺服器的時候，也可以很方便的共用快取資料。</li>
</ul>


<h1>Etag</h1>

<p>ETag 是用來辨識當前的頁面是否有所改變（Rails 預設就有使用了）</p>

<p>第一次</p>

<ol>
<li>Client 發 Request</li>
<li>Rails 流程

<ul>
<li><ol>
<li>Render body</li>
</ol>
</li>
<li><ol>
<li>Create ETag</li>
</ol>
</li>
<li><ol>
<li>Body &amp; ETag included in response(<code>headers['ETag'] = Digest::MD5.hexdigest(body)</code>)</li>
</ol>
</li>
</ul>
</li>
<li>Rails 發 Response

<ul>
<li>200 Success Head 裡包含 ￼headers[&lsquo;ETag&rsquo;]</li>
</ul>
</li>
<li>Client 接收並 caches response</li>
</ol>


<p>第二次</p>

<ol>
<li>Client 發 Request 並帶著 <code>headers['If-None-Match']</code> 就是 Etag 但不知道為什麼要叫這名字</li>
<li>Rails 流程

<ul>
<li><ol>
<li>Render body</li>
</ol>
</li>
<li><ol>
<li>Create ETag</li>
</ol>
</li>
<li><ol>
<li>Compare ETag</li>
</ol>
</li>
<li><ol>
<li>If ETags match then body not included in response</li>
</ol>
</li>
</ul>
</li>
<li>Rails 發 Response

<ul>
<li>304 Not Modified</li>
</ul>
</li>
<li>Client 接收並 reads response from cache</li>
</ol>


<p>以上雖然就不需要再重新 response body，但是每次 request 都必須再把整個 body 去 generate 一次 ETag 這是相當沒有效率的事</p>

<p>所以可以透過 Customer Etag 來改善</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ItemsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">etag</span> <span class="p">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@item</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="err">￼</span>    <span class="n">fresh_when</span><span class="p">(</span><span class="vi">@item</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">#headers[&#39;ETag&#39;] = Digest::MD5.hexdigest(@item.cache_key)</span>
</span><span class='line'>  <span class="c1">#加上面的 etag {current_user.id} 等於 fresh_when([@item, current_user.id])，可以有更多參數去判斷是否有改變</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣一來就只要 id 和 update_at 兩個就可以知道到底整個頁面有沒有東西變動過</p>

<h1>memcache store uses dalli</h1>

<p>Dalli is a high performance pure Ruby client for accessing memcached servers</p>

<ol>
<li>Approximately 20% faster than memcache-client.</li>
<li>Provides proper failover with recovery and adjustable timeouts.</li>
<li>Easier to integrate with monitoring tools like NewRelic RPM in order to track usage. 4. ThreadSafe.</li>
<li><p>Backwards compatible with the previous memcache-client API.</p></li>
<li><p>安裝Memcached</p></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">brew</span> <span class="n">install</span> <span class="n">memcached</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>加上memcached的函式庫</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;dalli&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>編輯<code>config/environments/development.rb</code>和<code>production.rb</code>加上</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">cache_store</span> <span class="o">=</span> <span class="ss">:dalli_store</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 存入</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="no">Post</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'><span class="c1"># 取出</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># 删除</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># 查看</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># fetch: 檢查 key 是否存在, 不存在, 把 block 里的结果作為 value, 并返回结果. 如果存在, 就不去執行 block 的内容</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;last_post&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="no">Post</span><span class="o">.</span><span class="n">last</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># =&gt; blah</span>
</span><span class='line'><span class="c1"># 还可以设定过期时间</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="ss">expires_in</span><span class="p">:</span> <span class="mi">4</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span> <span class="p">{</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>使用時機</h3>

<p>資料庫裡不常變動的資料，ex:所有國家</p>

<p>使用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">cached_skills</span>
</span><span class='line'>  <span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="ss">:skills</span><span class="o">]</span><span class="p">,</span> <span class="ss">expires_in</span><span class="p">:</span> <span class="mi">240</span><span class="o">.</span><span class="n">hours</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">skills</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>[self.class.name, id, :skills]這是存儲的關鍵</li>
<li>cache 將會在240小時後過期</li>
<li>如果不轉 array (to_a)直接將 active-record 的 relations 儲存到 cache 的話，每次訪問 cache 這個 relations 還是會查詢資料庫的</li>
</ul>


<p>gem：<br/>
<a href="https://github.com/petergoldstein/dalli">dalli</a></p>

<p>官方文件：<br/>
<a href="http://guides.ruby-china.org/caching_with_rails.html">Rails 缓存简介</a><br/>
<a href="http://guides.rubyonrails.org/caching_with_rails.html">Caching with Rails: An overview</a><br/>
<a href="https://memcached.org/">memcached</a></p>

<p>參考文件：<br/>
<a href="https://ihower.tw/rails4/caching.html">快取</a><br/>
<a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching">Google Developers: HTTP 快取</a><br/>
<a href="http://grantcss.com/blog/2014/12/04/introduce-dalli/">數據緩存提升性能gem - Dalli介紹</a><br/>
<a href="https://ihower.tw/blog/archives/1768">如何使用 memcached 做快取</a><br/>
<a href="https://danielzhangqinglong.github.io/2015/03/19/rails-caching/">Rails中使用memcached內存緩存技術</a><br/>
<a href="https://danielzhangqinglong.github.io/2015/04/03/intro-http-caching-with-rails/">译 ~ 介绍Rails中的条件HTTP缓存</a><br/>
<a href="https://ruby-china.org/topics/24996">Rails 3 和 Rails 4 中 ETags 工作原理</a><br/>
<a href="http://enginechang.logdown.com/posts/249025-discussion-on-memory-cache">淺談memory cache</a><br/>
<a href="https://ruby-china.org/topics/19389">总结 Web 应用中常用的各种 Cache</a><br/>
<a href="http://rails-everyday.group.iteye.com/group/wiki/1160">Rails Cache</a><br/>
<a href="https://www.nateberkopec.com/2015/07/15/the-complete-guide-to-rails-caching.html">Speed Up Your Rails App by 66% - The Complete Guide to Rails Caching</a><br/>
<a href="https://www.fastly.com/blog/accelerating-rails-part-1-built-caching">Accelerating Rails, Part 1: Built-in Caching</a><br/>
<a href="https://www.fastly.com/blog/accelerating-rails-part-2-dynamic-http-caching">Accelerating Rails, Part 2: Dynamic HTTP Caching</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Cookie & Session]]></title>
    <link href="http://mgleon08.github.com/blog/2016/06/12/cookie-and-session/"/>
    <updated>2016-06-12T20:34:20+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/06/12/cookie-and-session</id>
    <content type="html"><![CDATA[<p>用於讓 server 記住 client 的行為與資料。</p>

<!-- more -->


<h1>Cookie</h1>

<p>由於 HTTP 協定是無狀態((Stateless)的，server 端無法得知使用者在前端的操作內容，阻礙了前端與後端對話，因此 cookie 就是被設計來解決這個問題的機制。</p>

<ul>
<li>當 server 想要儲存使用者的某些狀態時，就可以發送 cookie 給 client</li>
<li>http header 裡面其中一個欄位</li>
<li>key / value 的形式儲</li>
<li>檔案大小最多 4Kb</li>
<li>以明文的方式在網際網路上傳輸及在 Client 端電腦儲存，所以不建議儲存敏感資料</li>
<li>儲存在 client 的瀏覽器</li>
<li>儲存位置

<ul>
<li>記憶體 cookie：由瀏覽器維護，當瀏覽器關閉，cookie也隨之消失，為非持久性的</li>
<li>硬碟 cookie：存在用戶端硬碟中，有一個過期時間，除非使用者手動清理cookie或是超過過期時間，否則cookie不會消失，為持久性的</li>
</ul>
</li>
</ul>


<h1>Session</h1>

<ul>
<li>儲存在 server 端</li>
<li>session 需要 cookie 的輔助才能產生運作</li>
<li>server 會傳送帶有 session id 的 cookie 給 client，當下一個 request 及cookie 再被送至 server 端時，會用 cookie 中的 session id 來辨認每個使用者所儲存的狀態與 data。</li>
<li>相對於 cookies，session 多用來儲存敏感的資料，也常常成為攻擊的目標 <a href="http://guides.rubyonrails.org/security.html#session-hijacking">Session Hijacking</a></li>
</ul>


<h1>rails 裡的 Session &amp; Cookie</h1>

<h3>session</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#設定</span>
</span><span class='line'><span class="n">session</span><span class="o">[</span><span class="ss">:current_user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'><span class="c1">#移除</span>
</span><span class='line'><span class="n">session</span><span class="o">[</span><span class="ss">:current_user_id</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(:</span> <span class="n">current_user_id</span><span class="p">)</span>
</span><span class='line'><span class="c1">#整個 session 清掉</span>
</span><span class='line'><span class="n">reset_session</span>
</span></code></pre></td></tr></table></div></figure>


<h3>session store</h3>

<p><code>config/initializers/session_store.rb</code> 裡面可以設定</p>

<ul>
<li><code>:cookie_store</code>（預設）</li>
<li><code>:active_record_store</code> 使用資料庫來儲存（安全性較高）

<ul>
<li>需搭配 activerecord-session_store gem，產生sessions資料表</li>
</ul>
</li>
<li><code>:mem_cache_store</code> 使用Memcached快取系統來儲存，適合逾須兼顧效能的高流量網站</li>
</ul>


<blockquote><p>Rails預設採用 Cookies session storage 來儲存 Session 資料，它是將 Session 資料透過 config/secrets.yml 的 secret_key_base 編碼後放到瀏覽器的 Cookie 之中</p></blockquote>

<h3>cookie</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#設定</span>
</span><span class='line'><span class="n">cookies</span><span class="o">[</span><span class="ss">:commenter_name</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@comment</span><span class="o">.</span><span class="n">author</span>
</span><span class='line'><span class="c1">#移除</span>
</span><span class='line'><span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:commenter_name</span><span class="p">)</span>
</span><span class='line'><span class="c1">#保護不能讓使用者亂改 signed</span>
</span><span class='line'><span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:user_preference</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@current_user</span><span class="o">.</span><span class="n">preferences</span>
</span><span class='line'><span class="c1">#盡可能永遠留在使用者瀏覽器的資料 permanent</span>
</span><span class='line'><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value</span><span class="p">:</span>   <span class="n">remember_token</span><span class="p">,</span>
</span><span class='line'>                             <span class="ss">expires</span><span class="p">:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</span><span class='line'><span class="c1">#上下相等</span>
</span><span class='line'><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="n">salt</span><span class="o">]</span>
</span><span class='line'><span class="c1">#permanent 預設為 20 年後過期 = 20.years.from_now</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#可一起用</span>
</span><span class='line'><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:remember_me</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="n">salt</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#Rails 3 是 digitally signed cookie 可以用這方法 decode</span>
</span><span class='line'><span class="c1">#Rails 4 則改為 Encrypted cookies 就無法</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rack&#39;</span>
</span><span class='line'><span class="n">cookie</span> <span class="o">=</span> <span class="s2">&quot;BAh7CUkiD3Nlc3Npb25faWQGOgZFRkkiJ(...)&quot;</span>
</span><span class='line'><span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Cookie</span><span class="o">::</span><span class="no">Base64</span><span class="o">::</span><span class="no">Marshal</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://rails.ruby.tw/action_controller_overview.html#session">session</a><br/>
<a href="http://rails.ruby.tw/action_controller_overview.html#cookies">cookie</a><br/>
<a href="http://guides.rubyonrails.org/security.html#sessions">RailsGuide</a></p>

<p>參考文件：<br/>
<a href="http://blog.andikan.me/2012/10/03/cookie-and-session/">Cookie 和 Session 的神秘關係</a><br/>
<a href="https://ihower.tw/rails4/actioncontroller.html">Action Controller - 控制 HTTP 流程</a><br/>
<a href="http://fred-zone.blogspot.tw/2014/01/web-session.html">Web 技術中的 Session 是什麼？</a><br/>
<a href="http://railsfun.tw/t/session-cookie/380">session / cookie 解釋</a><br/>
<a href="http://lucaswu.logdown.com/posts/735841-rails-sessions-cookies-and-flash">Rails - Sessions, Cookies and Flash</a>
<a href="http://grantcss.com/blog/2015/03/23/how-rails-sessions-work/">[译] Rails Sessions 是如何工作的？</a><br/>
<a href="http://www.rails365.net/articles/cookie-yuan-li-yu-shi-xian-rails-pian">cookie原理与实现(rails篇)</a><br/>
<a href="http://www.rails365.net/articles/session-yuan-li-yu-shi-xian-rails-pian">session原理与实现(rails篇)</a><br/>
<a href="https://read01.com/NyARK.html">COOKIE與SESSION比較</a><br/>
<a href="http://railstutorial-china.org/rails42/chapter8.html#logging-in">第 8 章 登录和退出</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Garbage Collection (GC)]]></title>
    <link href="http://mgleon08.github.com/blog/2016/06/10/garbage-collection/"/>
    <updated>2016-06-10T12:18:42+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/06/10/garbage-collection</id>
    <content type="html"><![CDATA[<p>在 ruby 當中，經常會看到 : 的符號，代表 symbol</p>

<!-- more -->


<p>跟一般 string 的差異在於</p>

<ul>
<li>同樣的 string，會產生不同的 記憶體</li>
<li>同樣的 symbol，一樣的記憶體</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;foo&quot;</span><span class="o">.</span><span class="n">object_id</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1">#=&gt;70302331020060</span>
</span><span class='line'><span class="c1">#=&gt;70302331019980</span>
</span><span class='line'><span class="c1">#=&gt;70302331019920</span>
</span><span class='line'>
</span><span class='line'><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="ss">:foo</span><span class="o">.</span><span class="n">object_id</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1">#=&gt;1091868</span>
</span><span class='line'><span class="c1">#=&gt;1091868</span>
</span><span class='line'><span class="c1">#=&gt;1091868</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#將字串 freeze 起來，object_id 也會是一樣</span>
</span><span class='line'><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;foo&quot;</span><span class="o">.</span><span class="n">freeze</span><span class="o">.</span><span class="n">object_id</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1">#=&gt;70172682147320</span>
</span><span class='line'><span class="c1">#=&gt;70172682147320</span>
</span><span class='line'><span class="c1">#=&gt;70172682147320</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Garbage Collection</h1>

<ul>
<li><p>在 ruby 2.2 之前，symbol 所佔用的記憶體沒辦法被自動回收，要釋放就必須重啟動程式，因此會造成 memory leak 的問題</p></li>
<li><p>但在 2.2 之後，Symbol GC(Garbage Collection) ，那些動態用 to_sym 或 intern 長出來的 Symbol 就可以跟一般物件一樣被回收了。</p></li>
</ul>


<h3>ruby2.1</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Ruby 2.1</span>
</span><span class='line'><span class="n">before</span> <span class="o">=</span> <span class="no">Symbol</span><span class="o">.</span><span class="n">all_symbols</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="mi">100_000</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="s2">&quot;sym</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">to_sym</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="no">GC</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'><span class="n">after</span> <span class="o">=</span> <span class="no">Symbol</span><span class="o">.</span><span class="n">all_symbols</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">after</span> <span class="o">-</span> <span class="n">before</span>
</span><span class='line'><span class="c1"># =&gt; 100001</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ruby 2.2</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Ruby 2.2</span>
</span><span class='line'><span class="n">before</span> <span class="o">=</span> <span class="no">Symbol</span><span class="o">.</span><span class="n">all_symbols</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="mi">100_000</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="s2">&quot;sym</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">to_sym</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="no">GC</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'><span class="n">after</span> <span class="o">=</span> <span class="no">Symbol</span><span class="o">.</span><span class="n">all_symbols</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">after</span> <span class="o">-</span> <span class="n">before</span>
</span><span class='line'><span class="c1"># =&gt; 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：<br/>
<a href="http://kaochenlong.com/2016/04/25/string-and-symbol/">Ruby 語法放大鏡之「有的變數變前面有一個冒號(例如 :name)，是什麼意思?」</a><br/>
<a href="https://www.sitepoint.com/symbol-gc-ruby-2-2/">Symbol GC in Ruby 2.2</a><br/>
<a href="http://grantcss.com/blog/2015/01/26/symbol-gc-in-ruby-2-dot-2/">[译] 在 Ruby 2.2 中的 Symbol GC</a><br/>
<a href="https://ruby-china.org/topics/21498">Ruby 2.2 的 可回收 symbol</a><br/>
<a href="https://ruby-china.org/topics/17575">升级 Ruby 2.1 以及 GC 调整</a><br/>
<a href="https://ruby-china.org/topics/13740">Ruby 的 GC 不释放内存给回系统的？</a><br/>
<a href="https://ruby-china.org/topics/28127">画说 Ruby 与 Python 垃圾回收</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Override Default Primary Key Id]]></title>
    <link href="http://mgleon08.github.com/blog/2016/06/09/override-default-primary-key-id/"/>
    <updated>2016-06-09T22:37:33+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/06/09/override-default-primary-key-id</id>
    <content type="html"><![CDATA[<p>有時候在處理一些 table 時，會不希望 Primary Key 是一開始預設的 id 流水號</p>

<!-- more -->


<p>像是當 table 會不斷清空又重建，若是流水號，就會一直不斷的壘加上去，這時我們就會希望 table 的 Primary Key 可以自己設定</p>

<p>migration 可以很方便做到這件事，也可以改成複合健(兩個 primary key，預設是無法，可以靠 composite_primary_keys  gem 來達成)</p>

<!-- more -->


<p>先將原本 id 移除</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>  <span class="n">remove_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:id</span> <span class="c1"># remove existing primary key</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>  <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:primary_key</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>加上新的 primary key id</p>

<ul>
<li>ex1:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:sku</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>ex2:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:sku</span><span class="p">,</span> <span class="ss">primary_key</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>ex3:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>  <span class="n">create_table</span> <span class="ss">:products</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:sku</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:sku</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">execute</span> <span class="sx">%Q{ ALTER TABLE &quot;products&quot; ADD PRIMARY KEY (&quot;sku&quot;); }</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：<br/>
<a href="http://ruby-journal.com/how-to-override-default-primary-key-id-in-rails/">How to Override Default Primary Key Id in Rails</a><br/>
<a href="https://github.com/composite-primary-keys/composite_primary_keys">composite_primary_keys</a><br/>
<a href="http://stackoverflow.com/questions/23848388/change-primary-key-issue-rails-4-0">Change Primary Key Issue Rails 4.0</a><br/>
<a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-create_table">create_table</a><br/>
<a href="http://rails.ruby.tw/active_record_migrations.html">Active Record 遷移</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Class Macro (Ruby’s Declarative Style)]]></title>
    <link href="http://mgleon08.github.com/blog/2016/06/09/class-macro/"/>
    <updated>2016-06-09T20:14:09+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/06/09/class-macro</id>
    <content type="html"><![CDATA[<p>Class Macro 就是在 rails 的 ActiveRecord 中，經常會看到，<code>validates</code> <code>belongs_to</code> <code>hsa_manay</code> 等等的宣告</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">validates</span>  <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:group</span>
</span><span class='line'>  <span class="n">has_many</span>   <span class="ss">:posts</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>範例:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActiveRecord</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Base</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">has_many</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">self</span><span class="si">}</span><span class="s2"> has many </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  
</span><span class='line'>      <span class="c1">#定義 Dynamic method</span>
</span><span class='line'>      <span class="n">define_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;Select * From </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> Where..&quot;</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;Return </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="o">[]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Movie</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="c1">#self.has_many(:reviews)</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:reviews</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:genres</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Project</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:tasks</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">movie</span> <span class="o">=</span> <span class="no">Movie</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">movie</span><span class="o">.</span><span class="n">reviews</span>
</span><span class='line'><span class="n">project</span> <span class="o">=</span> <span class="no">Project</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">project</span><span class="o">.</span><span class="n">tasks</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#=&gt;Movie has many reviews</span>
</span><span class='line'><span class="c1">#=&gt;Movie has many genres</span>
</span><span class='line'><span class="c1">#=&gt;Project has many tasks</span>
</span><span class='line'><span class="c1">#=&gt;Select * From reviews Where..</span>
</span><span class='line'><span class="c1">#=&gt;Return reviews</span>
</span><span class='line'><span class="c1">#=&gt;Select * From tasks Where..</span>
</span><span class='line'><span class="c1">#=&gt;Return tasks</span>
</span></code></pre></td></tr></table></div></figure>


<p>之前有寫過
<a href="http://mgleon08.github.io/blog/2016/04/19/dynamic-classes-and-methods/">Dynamic Classes &amp; Methods</a></p>

<p>另一個範例，可以動態的將取出來的值做改變</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Precentage</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="o">*</span><span class="n">columns</span><span class="p">,</span> <span class="ss">precentage</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="n">columns</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">column</span><span class="o">|</span>
</span><span class='line'>      <span class="c1">#這裡做了 alias_method 主要是希望，如果想知道原本的價錢，還可以呼叫 xx_origin</span>
</span><span class='line'>      <span class="n">alias_method</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">column</span><span class="si">}</span><span class="s2">_origin&quot;</span><span class="p">,</span> <span class="n">column</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">precentage</span>
</span><span class='line'>        <span class="c1">#動態產生新的 method 去取代原本</span>
</span><span class='line'>        <span class="n">define_method</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>          <span class="nb">send</span><span class="p">(</span><span class="n">precentage</span><span class="p">)</span> <span class="o">*</span> <span class="nb">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">column</span><span class="si">}</span><span class="s2">_origin&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Book</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">Precentage</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:precentage</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@price</span>      <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:price</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@precentage</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:precentage</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">transform</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">precentage</span><span class="p">:</span> <span class="ss">:precentage</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">price</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="ss">precentage</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">book</span><span class="o">.</span><span class="n">precentage</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">book</span><span class="o">.</span><span class="n">price</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">book</span><span class="o">.</span><span class="n">price_origin</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#=&gt; 0.8</span>
</span><span class='line'><span class="c1">#=&gt; 80.0</span>
</span><span class='line'><span class="c1">#=&gt; 100</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：<br/>
<a href="https://pragmaticstudio.com/blog/2015/4/14/ruby-macros">How To Write &ldquo;Macros&rdquo; in Ruby</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby Range]]></title>
    <link href="http://mgleon08.github.com/blog/2016/06/09/ruby-range/"/>
    <updated>2016-06-09T20:13:54+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/06/09/ruby-range</id>
    <content type="html"><![CDATA[<p>經常會使用 range 去判斷某個值，是否在某個區間<br/>
ruby 也提供很多好用的方法去判斷，cover?, include? 等等</p>

<!-- more -->


<h1>Range</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#... 不包含結尾</span>
</span><span class='line'><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>      <span class="c1">#=&gt; []</span>
</span><span class='line'><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>      <span class="c1">#=&gt; [-5, -4, -3, -2, -1]</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;e&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>    <span class="c1">#=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="s1">&#39;e&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>   <span class="c1">#=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="no">Range</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>    <span class="c1">#=&gt; true</span>
</span><span class='line'><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="mi">2</span><span class="p">)</span>           <span class="c1">#=&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<h1>begin/end first/last</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">r1</span> <span class="o">=</span> <span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">6</span>
</span><span class='line'><span class="n">r2</span> <span class="o">=</span> <span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="mi">6</span>
</span><span class='line'><span class="n">r1a</span><span class="p">,</span> <span class="n">r1b</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">first</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">last</span>    <span class="c1">#=&gt; 3, 6</span>
</span><span class='line'><span class="n">r1c</span><span class="p">,</span> <span class="n">r1d</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">end</span>     <span class="c1">#=&gt; 3, 6</span>
</span><span class='line'><span class="n">r2a</span><span class="p">,</span> <span class="n">r2b</span> <span class="o">=</span> <span class="n">r2</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">r2</span><span class="o">.</span><span class="n">end</span>     <span class="c1">#=&gt; 3, 6 (注意：不是3和5)</span>
</span><span class='line'><span class="n">r1</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                     <span class="c1">#=&gt; [3, 4]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>step</h1>

<p>從 0..20 中取出 0，5，10，20</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">20</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'><span class="c1">#=&gt; [0, 5, 10, 15, 20]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>include?/cover?</h1>

<p>判斷值，是否在 range 當中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">r</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">.</span><span class="n">.</span> <span class="mi">5</span>
</span><span class='line'><span class="n">r</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>     <span class="c1">#=&gt; true</span>
</span><span class='line'><span class="n">r</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>     <span class="c1">#=&gt; false</span>
</span><span class='line'><span class="n">r</span><span class="o">.</span><span class="n">cover?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>       <span class="c1">#=&gt; true</span>
</span><span class='line'><span class="n">r</span><span class="o">.</span><span class="n">cover?</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1">#=&gt; false</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="o">.</span><span class="n">.</span><span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;ab&quot;</span><span class="p">)</span>     <span class="c1"># =&gt; false </span>
</span><span class='line'><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="o">.</span><span class="n">.</span><span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cover?</span><span class="p">(</span><span class="s2">&quot;ab&quot;</span><span class="p">)</span>       <span class="c1"># =&gt; true </span>
</span></code></pre></td></tr></table></div></figure>


<p>主要差異是</p>

<ul>
<li>include? 會將所有值一一拿出來做比對，因此效率較差</li>
<li>cover?   只會取出開頭和結尾，去比對，值 > 開頭 &amp;&amp; 值 &lt;= 結尾，效能比較好</li>
</ul>


<p>官方文件：<br/>
<a href="http://ruby-doc.org/core-1.9.3/Range.html">ruby-doc Range</a></p>

<p>參考文件：<br/>
<a href="http://stackoverflow.com/questions/21608935/what-is-the-difference-between-rangeinclude-and-rangecover">What is the difference between Range#include? and Range#cover? ?</a>  <br/>
<a href="https://blog.8thlight.com/makis-otman/2014/09/03/setting-date-ranges-in-ruby.html">Apprentice Blog of the Week: Setting Date Ranges in Ruby</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Coding Principle 程式設計原則 SOLID]]></title>
    <link href="http://mgleon08.github.com/blog/2016/05/29/coding-principle/"/>
    <updated>2016-05-29T20:27:06+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/05/29/coding-principle</id>
    <content type="html"><![CDATA[<p>在 Coding 的世界中，有許多重要的 Principle 值得我們去遵循</p>

<!-- more -->


<h1>SOLID</h1>

<h1>Single Responsibility Principle(單一責任原則SRP)</h1>

<h3>定義：</h3>

<ul>
<li>對一個類別而言，應該僅有一個引起它變化的原因（職責）</li>
<li>降低單一類別被「改變」所影響的機會</li>
<li>只有一個理由需要更改這個class，如果有一個以上的理由就表示：這個class負責超過一個以上的責任</li>
</ul>


<h3>說明：</h3>

<ul>
<li>若一個類別有多重職責，職責之間會互相耦合，一個職責的變化可能會影響該類別完成其他職責的能力。</li>
</ul>


<p><a href="http://ithelp.ithome.com.tw/articles/10100557">軟體路上不孤單Day10-物件導向原則介紹3[SRP]</a></p>

<h1>Open/Close Principle (開放關閉原則OCP)</h1>

<h3>定義：</h3>

<ul>
<li>軟體模組（class, method, module）應該對擴展開放，對修改關閉</li>
<li>讓模組容易增加(擴展)功能，而不必去修改原有程式碼</li>
<li>讓主要類別不會因為新增需求而改變</li>
</ul>


<h3>說明：</h3>

<ul>
<li>對有相似行為類別的建立抽象層，如 abstract class, 或是 interface。</li>
<li>將公共屬性或方法提取到抽象層中，當需要擴展行為（新增）時只需要建立新的子類別並繼承抽象層，不必修改原有的行為。</li>
</ul>


<blockquote><p>注意：實作 OCP 抽象層需要花費時間和精力，也可能會造成複雜度的上升，OCP 應該只運用在程序中頻繁發生的變化上。</p></blockquote>

<p><a href="http://ithelp.ithome.com.tw/articles/10100008">軟體路上不孤單Day08-物件導向原則介紹1[OCP]</a></p>

<h1>Liskov Substitution Principle (Liskov替換原則LSP)</h1>

<h3>定義：</h3>

<ul>
<li>子類別(Sub Type)必須能夠替換成他們的基本類別(Base Type)</li>
<li>子類別應該可以替換任何基本類別出現的位置，且程序還能正常工作</li>
<li>避免繼承時子類別所造成的「行為改變」</li>
</ul>


<h3>說明：</h3>

<ol>
<li>不能僅用 is-a 的關係就建立繼承，必須考慮是否在基本類別中有些方法對子類別而言是不需要或是無意義的。</li>
</ol>


<p>這些沒有意義的方法會造成不可預期的結果。</p>

<ol>
<li>建立一個抽象層並提取公共方法，並讓子類別派生抽象層。</li>
</ol>


<blockquote><p>注意：必須要有繼承關係才需要考慮 LSP ，而 LSP 是讓設計達到 OCP 的規則之一 。</p></blockquote>

<p><a href="http://ithelp.ithome.com.tw/articles/10100827">軟體路上不孤單Day11-物件導向原則介紹4[LSP]</a></p>

<h1>Law of Demeter(迪米特原則LOD, LKD)</h1>

<h3>定義：</h3>

<ul>
<li>也稱最少知識原則(Principle of Least Knowledge)</li>
<li>避免曝露過多資訊造成用戶端因流程調整而改變</li>
<li>模組應該儘可能的減少其他模組交互，目的在於降低彼此之間的依賴。</li>
</ul>


<h3>說明：</h3>

<p>以下為必須遵循 LOD 的條件</p>

<p>類別 O 的任何方法 m 只能呼叫屬於以下情況的方法</p>

<ol>
<li>類別 O 本身的方法</li>
<li>傳入 m 的參數的方法</li>
<li>在 m 中建立對象的方法</li>
<li>任何直接持有的對象方法</li>
</ol>


<p><a href="http://ithelp.ithome.com.tw/articles/10101265">軟體路上不孤單Day13-物件導向原則介紹6[LoD]</a></p>

<h1>Interface Segregation Principle(介面隔離ISP)</h1>

<h3>定義：</h3>

<ul>
<li>使用單純簡單的 interface , 比使用一個複雜過大的 interface 來的好。</li>
<li>用戶不應該被迫相依於他們用不到的函示</li>
<li>降低用戶端因為不相關介面而被改變</li>
</ul>


<h3>說明：</h3>

<p>一個過大的 interface ，通常代表其中有某些功能是客戶端不需要的，如果客戶端實作了不需要的功能 ，這些功能會造成不必要的耦合。</p>

<p>我們可以把過大的 interface 分離，將其中某些功能拆離到另一個 interface 中。</p>

<p><a href="http://ithelp.ithome.com.tw/articles/10101106">軟體路上不孤單Day12-物件導向原則介紹5[ISP]</a></p>

<h1>Dependency Inversion Principle (相依性反轉DIP)</h1>

<h3>定義：</h3>

<ul>
<li>高層模組不應該相依於低層模組，兩者都應該相依於抽象</li>
<li>避免高階程式因為低階程式改變而被迫改變</li>
<li>抽象不應該相依於具體，具體應該相依於抽象。</li>
</ul>


<h3>說明：</h3>

<p>對象的引用盡量是抽象型態而不是具體型態。</p>

<blockquote><p>注意：若是具體型態已經相當穩定，不太會變化，依賴於該具體類別也是無妨。</p></blockquote>

<p><a href="http://ithelp.ithome.com.tw/articles/10101486">軟體路上不孤單Day14-物件導向原則介紹7[DIP]</a></p>

<hr />

<h1>Do not repeat yourself(DRY)</h1>

<h3>定義：</h3>

<ul>
<li>當有相同的 code 時，應該整合成一個，不該重複出現</li>
</ul>


<p><a href="http://ithelp.ithome.com.tw/articles/10100309">軟體路上不孤單Day09-物件導向原則介紹2[DRY]</a></p>

<h1>duck type(鴨子類型)</h1>

<h3>定義：</h3>

<ul>
<li>當我看到一隻鳥，它走路像鴨子，游泳像鴨子，叫聲像鴨子，我就稱其為鴨子</li>
</ul>


<h3>說明：</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>    <span class="n">x</span><span class="o">.</span><span class="n">hi</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>因此只要 x 將帶有 <code>hi</code> 的方法都可以使用，不管是人或是動物</p>

<p><a href="http://www.ithome.com.tw/voice/88063">進一步思考Duck typing</a></p>

<p>參考文件：<br/>
<a href="http://rockssdlog.blogspot.tw/2012/03/oo-solid.html">白話- OO設計原則 (SOLID原則) - 附生活實例</a> <br/>
<a href="http://ithelp.ithome.com.tw/search?tab=article&amp;search=%E8%BB%9F%E9%AB%94%E8%B7%AF%E4%B8%8A%E4%B8%8D%E5%AD%A4%E5%96%AE&amp;page=1">軟體路上不孤單</a><br/>
<a href="http://122.146.238.121/wordpress/?cat=95">Design Principle</a><br/>
<a href="http://slides.com/jaceju/design-patterns-by-examples/#/">從實例學設計模式</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Default Args]]></title>
    <link href="http://mgleon08.github.com/blog/2016/05/29/default-args/"/>
    <updated>2016-05-29T20:22:19+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/05/29/default-args</id>
    <content type="html"><![CDATA[<p>很常時候，需要給變數一個預設值，因此有以下方法，都可以設定預設值</p>

<!-- more -->


<h1>||</h1>

<p>只要是空值，或是 false, nil 就會回傳後面的預設值</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">,</span> <span class="s1">&#39;c&#39;</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;false, &quot;c&quot;=&gt;nil}</span>
</span><span class='line'><span class="n">h</span><span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">8</span>
</span><span class='line'><span class="c1">#=&gt; 100</span>
</span><span class='line'><span class="n">h</span><span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">8</span>
</span><span class='line'><span class="c1">#=&gt; 8</span>
</span><span class='line'><span class="n">h</span><span class="o">[</span><span class="s1">&#39;c&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">8</span>
</span><span class='line'><span class="c1">#=&gt; 8</span>
</span><span class='line'><span class="n">h</span><span class="o">[</span><span class="s1">&#39;d&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">8</span>
</span><span class='line'><span class="c1">#=&gt; 8</span>
</span></code></pre></td></tr></table></div></figure>


<h1>fetch</h1>

<p>即使是 nil, false 也會回傳，只有在空值的時候回傳預設值</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">,</span> <span class="s1">&#39;c&#39;</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;100, &quot;b&quot;=&gt;false, &quot;c&quot;=&gt;nil}</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 100</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; false</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; nil</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 8</span>
</span></code></pre></td></tr></table></div></figure>


<p>在處理應該存在的哈希鍵時，使用 fetch。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">heroes</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">batman</span><span class="p">:</span> <span class="s1">&#39;Bruce Wayne&#39;</span><span class="p">,</span> <span class="ss">superman</span><span class="p">:</span> <span class="s1">&#39;Clark Kent&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="c1"># bad - if we make a mistake we might not spot it right away</span>
</span><span class='line'><span class="n">heroes</span><span class="o">[</span><span class="ss">:batman</span><span class="o">]</span> <span class="c1"># =&gt; &quot;Bruce Wayne&quot;</span>
</span><span class='line'><span class="n">heroes</span><span class="o">[</span><span class="ss">:supermann</span><span class="o">]</span> <span class="c1"># =&gt; nil</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># good - fetch raises a KeyError making the problem obvious</span>
</span><span class='line'><span class="n">heroes</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:supermann</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>在使用 fetch 時，使用第二個參數設置默認值而不是使用自定義的邏輯。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">batman</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Bruce Wayne&#39;</span><span class="p">,</span> <span class="ss">is_evil</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># bad - if we just use || operator with falsy value we won&#39;t get the expected result</span>
</span><span class='line'><span class="n">batman</span><span class="o">[</span><span class="ss">:is_evil</span><span class="o">]</span> <span class="o">||</span> <span class="kp">true</span> <span class="c1"># =&gt; true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># good - fetch work correctly with falsy values</span>
</span><span class='line'><span class="n">batman</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:is_evil</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span> <span class="c1"># =&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<p>盡量用 fetch 加區塊而不是直接設定默認值。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">batman</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Bruce Wayne&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># bad - if we use the default value, we eager evaluate it</span>
</span><span class='line'><span class="c1"># so it can slow the program down if done multiple times</span>
</span><span class='line'><span class="n">batman</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:powers</span><span class="p">,</span> <span class="n">get_batman_powers</span><span class="p">)</span> <span class="c1"># get_batman_powers is an expensive call</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># good - blocks are lazy evaluated, so only triggered in case of KeyError exception</span>
</span><span class='line'><span class="n">batman</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:powers</span><span class="p">)</span> <span class="p">{</span> <span class="n">get_batman_powers</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>merge</h1>

<p>只有在 merge 的參數裡有同樣的值，才會覆蓋掉 default 的值</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">default</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">,</span> <span class="s1">&#39;c&#39;</span> <span class="o">=&gt;</span> <span class="kp">nil</span> <span class="p">}</span>
</span><span class='line'><span class="n">args</span>    <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;a&quot;</span> <span class="o">=&gt;</span> <span class="mi">8</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">default</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;a&quot;=&gt;8, &quot;b&quot;=&gt;false, &quot;c&quot;=&gt;nil}</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://apidock.com/ruby/Hash/fetch">fetch</a><br/>
<a href="http://apidock.com/ruby/Hash/merge">merge</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Struct vs OpenStruct]]></title>
    <link href="http://mgleon08.github.com/blog/2016/05/29/struct-vs-openstruct/"/>
    <updated>2016-05-29T20:18:53+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/05/29/struct-vs-openstruct</id>
    <content type="html"><![CDATA[<p>在 ruby 當中，經常會要定義一個新的類別，如果覺得每次都要寫 <code>class xxx</code> 太麻煩，就可以用 struct &amp; OpenStruct 快速的產生出來!</p>

<!-- more -->


<h1>Class</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">People</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:phone</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">phone</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@name</span>  <span class="o">=</span> <span class="nb">name</span>
</span><span class='line'>    <span class="vi">@phone</span> <span class="o">=</span> <span class="n">phone</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_ary</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">name</span><span class="p">,</span> <span class="n">phone</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="no">People</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; #&lt;People:0x007fcaabcf5328 @name=&quot;foo&quot;, @phone=1234&gt;</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="c1">#=&gt; &quot;foo&quot;</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">phone</span>
</span><span class='line'><span class="c1">#=&gt; 1234</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">to_ary</span>
</span><span class='line'><span class="c1">#=&gt; [&quot;foo&quot;, 1234]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Struct</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#method 要用 block 來傳遞，Attribute 一開始就固定了</span>
</span><span class='line'><span class="no">People</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:phone</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_ary</span>
</span><span class='line'>    <span class="o">[</span><span class="nb">name</span><span class="p">,</span> <span class="n">phone</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1"># =&gt; People</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="no">People</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; #&lt;struct People name=&quot;foo&quot;, phone=1234&gt;</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="c1">#=&gt; &quot;foo&quot;</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">phone</span>
</span><span class='line'><span class="c1">#=&gt; 1234</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">to_ary</span>
</span><span class='line'><span class="c1">#=&gt; [&quot;foo&quot;, 1234]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>也可以直接用繼承的方式</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">People</span> <span class="o">&lt;</span> <span class="n">struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:phone</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>其他取 Attribute Value 的方法</h3>

<p>Class則無法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
</span><span class='line'><span class="c1">#=&gt; &quot;foo&quot;</span>
</span><span class='line'><span class="n">a</span><span class="o">[</span><span class="s2">&quot;name&quot;</span><span class="o">]</span>
</span><span class='line'><span class="c1">#=&gt; &quot;foo&quot;</span>
</span><span class='line'><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'><span class="c1">#=&gt; &quot;foo&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>other</h3>

<p>不要去 extend 一個 Struct.new - 它已經是一個新的 class。擴展它會產生一個多餘的 class 層級
並且可能會產生怪異的錯誤如果文件被加載多次。</p>

<h1>OpenStruct</h1>

<p>主要差異點是在於，比 Struct 更有彈性, 因為它可以任意增加 Attribute , 不像 Struct 要先限制好有哪些 Attribute</p>

<p>但比較可惜的是，無法定義 method</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#在 console 記得先 require</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;ostruct&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">People</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="c1">#=&gt; #&lt;OpenStruct&gt;</span>
</span><span class='line'><span class="ow">or</span>
</span><span class='line'><span class="no">People</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="ss">phone</span><span class="p">:</span> <span class="mi">1234</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; #&lt;OpenStruct name=&quot;foo&quot;, phone=1234&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">可以自由新增</span>
</span><span class='line'><span class="no">People</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
</span><span class='line'><span class="c1">#=&gt; &quot;foo&quot;</span>
</span><span class='line'><span class="no">People</span><span class="o">.</span><span class="n">phone</span> <span class="o">=</span> <span class="mi">1234</span>
</span><span class='line'><span class="c1">#=&gt; 1234</span>
</span><span class='line'><span class="no">People</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">18</span>
</span><span class='line'><span class="c1">#=&gt; 18</span>
</span><span class='line'><span class="no">People</span>
</span><span class='line'><span class="c1">#=&gt; #&lt;OpenStruct name=&quot;foo&quot;, phone=1234, age=18&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">也可以直接用繼承的方式</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Test</span> <span class="o">&lt;</span> <span class="no">OpenStruct</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Struct: 接受的是按順序排列的初始化參數</li>
<li>Openstruct: 接受的則是散列表的參數</li>
</ul>


<h3>WHEN TO USE?</h3>

<ul>
<li>As a temporary data structure 暫時的 data 結構</li>
<li>As internal class data 內部的 class data</li>
</ul>


<blockquote><p>也許另一個 class 還不至於明確到可以獨立成一個 class，因此先暫存在別的 class 裡，直到有明確的行為，足夠讓它獨立出去</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="no">Address</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:street_1</span><span class="p">,</span> <span class="ss">:street_2</span><span class="p">,</span> <span class="ss">:city</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:address</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class='line'>    <span class="vi">@address</span> <span class="o">=</span> <span class="no">Address</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">opts</span><span class="o">[</span><span class="ss">:street_1</span><span class="o">]</span><span class="p">,</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:street_2</span><span class="o">]</span><span class="p">,</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:city</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">leigh</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Leigh Halliday&quot;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">street_1</span><span class="p">:</span> <span class="s2">&quot;123 Road&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">city</span><span class="p">:</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">leigh</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">inspect</span>
</span><span class='line'><span class="c1"># &lt;struct Person::Address street_1=&quot;123 Road&quot;, street_2=nil, city=&quot;Toronto&quot;, province=&quot;Ontario&quot;, country=&quot;Canada&quot;, postal_code=&quot;M5E 0A3&quot;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>As a testing stub</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">KCup</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:size</span><span class="p">,</span> <span class="ss">:brewing_time</span><span class="p">,</span> <span class="ss">:brewing_temp</span><span class="p">)</span>
</span><span class='line'><span class="n">colombian</span> <span class="o">=</span> <span class="no">KCup</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:small</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">85</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">brewer</span> <span class="o">=</span> <span class="no">Brewer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">colombian</span><span class="p">)</span>
</span><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">brewer</span><span class="o">.</span><span class="n">brew</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://ruby-doc.org/core-2.2.0/Struct.html">Struct</a><br/>
<a href="http://ruby-doc.org/stdlib-2.0.0/libdoc/ostruct/rdoc/OpenStruct.html">OpenStruct</a></p>

<p>參考文件：<br/>
<a href="http://stackoverflow.com/questions/1177594/when-should-i-use-struct-vs-openstruct#answer-4459132">When should I use Struct vs. OpenStruct?</a><br/>
<a href="https://www.leighhalliday.com/ruby-struct">The simple but powerful Ruby Struct</a><br/>
<a href="http://motion-express.com/blog/20150406-ruby-struct-and-ostruct">模擬class物件：Ruby當中Struct及OpenStruct的使用</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Forwardable 轉發 & Delegate 委派]]></title>
    <link href="http://mgleon08.github.com/blog/2016/05/29/forwardable-and-delegate/"/>
    <updated>2016-05-29T20:15:26+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/05/29/forwardable-and-delegate</id>
    <content type="html"><![CDATA[<p>在 OO 的世界裡，經常會去用到不同 class 的 method，因此透過這個方法，可以將不同 class 的 method <code>轉發</code> 過來!</p>

<!-- more -->


<h1>Forwardable</h1>

<p>顧名思義，將訊息 <code>轉發</code> 給別的物件。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Account</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:account</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@account</span> <span class="o">=</span> <span class="n">account</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">first_name</span>
</span><span class='line'>    <span class="n">account</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">last_name</span>
</span><span class='line'>    <span class="n">account</span><span class="o">.</span><span class="n">last_name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">full_name</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Account</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">last_name</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">full_name</span>
</span><span class='line'><span class="c1">#=&gt;foo</span>
</span><span class='line'><span class="c1">#=&gt;bar</span>
</span><span class='line'><span class="c1">#=&gt;foo bar</span>
</span></code></pre></td></tr></table></div></figure>


<p>上述有許多重複的 account，此時就可以使用 Forwardable 來簡化：<br/>
將 first_name、last_name <code>轉發</code> 給 account。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;forwardable&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Account</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:account</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">Forwardable</span>
</span><span class='line'>  <span class="n">def_delegators</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">#若 User 不想對外開放，attr_reader :account，可以改成實例變數，如以下</span>
</span><span class='line'>  <span class="c1">#extend Forwardable</span>
</span><span class='line'>  <span class="c1">#def_delegators :@account, :first_name, :last_name</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@account</span> <span class="o">=</span> <span class="n">account</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">full_name</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Account</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">last_name</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">user</span><span class="o">.</span><span class="n">full_name</span>
</span><span class='line'><span class="c1">#=&gt;foo</span>
</span><span class='line'><span class="c1">#=&gt;bar</span>
</span><span class='line'><span class="c1">#=&gt;foo bar</span>
</span></code></pre></td></tr></table></div></figure>


<h3>def_delegator(accessor, method, ali = method)</h3>

<p> 一次只能 &lsquo;轉發&rsquo; 一個方法，第三個參數是（可選的）別名。</p>

<pre><code class="`ruby">class MyQueue
  extend Forwardable
  attr_reader :queue
  def initialize
    @queue = []
  end

  def_delegator :@queue, :push, :mypush
end

q = MyQueue.new
q.mypush 42
q.queue    #=&gt; [42]
q.push 23  #=&gt; NoMethodError
</code></pre>

<h3>def_delegators(accessor, *methods)</h3>

<p>一次可以 &lsquo;轉發&rsquo; 多個方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">def_delegators</span> <span class="ss">:@account</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span>
</span></code></pre></td></tr></table></div></figure>


<h3>delegate [method, method, &hellip;] => accessor</h3>

<p>接受Hash</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">delegate</span> <span class="o">[</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="ss">:account</span>
</span></code></pre></td></tr></table></div></figure>


<p>看是如何 work</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Forwardable</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">hash</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="nb">methods</span><span class="p">,</span> <span class="n">accessor</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">methods</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">instance_eval</span> <span class="sx">%{</span>
</span><span class='line'><span class="sx">          def </span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="sx">(*args, &amp;block)</span>
</span><span class='line'><span class="sx">            </span><span class="si">#{</span><span class="n">accessor</span><span class="si">}</span><span class="sx">.__send__(:</span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="sx">, *args, &amp;block)</span>
</span><span class='line'><span class="sx">          end</span>
</span><span class='line'><span class="sx">        }</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>example</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;forwardable&#39;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Bicycle</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:parts</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>    <span class="vi">@size</span>  <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@parts</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:parts</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">spares</span>
</span><span class='line'>    <span class="n">parts</span><span class="o">.</span><span class="n">spares</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Parts</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">Forwardable</span>
</span><span class='line'>  <span class="c1">#@parts 是一個 Array，因此將 size 和 each 委派給 Parts 實例物件 </span>
</span><span class='line'>  <span class="n">def_delegators</span> <span class="ss">:@parts</span><span class="p">,</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:each</span>
</span><span class='line'>  <span class="c1">#為了要讓實例可以直接用 select，select 又會用到 each 所以上面要委派</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Enumerable</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@parts</span> <span class="o">=</span> <span class="n">parts</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">spares</span>
</span><span class='line'>       <span class="c1">#所以這裡才可以直接用 select，不用 @parts.select</span>
</span><span class='line'>    <span class="nb">select</span><span class="p">{</span> <span class="o">|</span><span class="n">part</span><span class="o">|</span> <span class="n">part</span><span class="o">.</span><span class="n">needs_spare</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Part</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:needs_spare</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@name</span>        <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@description</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:description</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@needs_spare</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:needs_spare</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">chain</span>     <span class="o">=</span> <span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span>     <span class="ss">description</span><span class="p">:</span> <span class="s1">&#39;10-speed&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">tire_size</span> <span class="o">=</span> <span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;tire_size&#39;</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="s1">&#39;23&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">tap_color</span> <span class="o">=</span> <span class="no">Part</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;tap_color&#39;</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">road_bike</span> <span class="o">=</span> <span class="no">Bicycle</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>              <span class="ss">size</span><span class="p">:</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="ss">parts</span><span class="p">:</span> <span class="no">Parts</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="n">chain</span><span class="p">,</span> <span class="n">tire_size</span><span class="p">,</span> <span class="n">tap_color</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>              <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">road_bike</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="nb">puts</span> <span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">10</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">road_bike</span><span class="o">.</span><span class="n">spares</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="nb">puts</span> <span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">10</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Other</h1>

<ul>
<li><code>instance_delegate</code> alias <code>delegate</code></li>
<li><code>def_instance_delegator</code> alias <code>def_delegator</code></li>
<li><p><code>def_instance_delegators</code> alias <code>def_delegators</code></p></li>
<li><p><a href="http://mgleon08.github.io/blog/2015/12/13/ruby-on-rails-delegate/">rails-delegate</a> 之前就有寫到，可以參考!</p></li>
</ul>


<p>官方文件：<br/>
<a href="http://apidock.com/ruby/Forwardable/instance_delegate">instance_delegate</a><br/>
<a href="http://apidock.com/ruby/Forwardable/def_instance_delegator">def_instance_delegator</a><br/>
<a href="http://apidock.com/ruby/Forwardable/def_instance_delegators">def_instance_delegators</a><br/>
<a href="http://apidock.com/ruby/Forwardable">Forwardable</a><br/>
<a href="http://ruby-doc.org/stdlib-2.0.0/libdoc/forwardable/rdoc/Forwardable.html">Forwardable</a></p>

<p>參考文件：<br/>
<a href="http://juanitofatas.com/2014/06/30/ruby-stdlib-forwardable/">Ruby 標準函式庫 Forwardable</a><br/>
<a href="http://qiita.com/xiangzhuyuan/items/409c87da8cc4a882419b">深入理解和学习Ruby的Forwardable</a><br/>
<a href="http://vaidehijoshi.github.io/blog/2015/03/31/delegating-all-of-the-things-with-ruby-forwardable/">Delegating All of the Things With Ruby Forwardable</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby 中的數字 & BigDecimal]]></title>
    <link href="http://mgleon08.github.com/blog/2016/05/07/ruby-math/"/>
    <updated>2016-05-07T10:42:25+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/05/07/ruby-math</id>
    <content type="html"><![CDATA[<p>在程式中的運算可能跟我們平常接觸的會不一樣，ruby 也是!因此來瞭解一下吧!</p>

<!-- more -->


<p><img src="http://ithelp.ithome.com.tw/upload/images/20141005/20141005190053543124e558797_resize_600.png" alt="" /></p>

<h1>integer</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="o">.</span><span class="n">class</span>
</span><span class='line'><span class="c1">#=&gt; Fixnum</span>
</span><span class='line'><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">class</span>
</span><span class='line'><span class="c1">#=&gt; Fixnum</span>
</span><span class='line'><span class="c1">#20 位數會開始變成 Bignum</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="o">+</span><span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span><span class="o">.</span><span class="n">class</span>
</span><span class='line'><span class="c1">#=&gt; Fixnum</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="o">+</span><span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="mi">19</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span><span class="o">.</span><span class="n">class</span>
</span><span class='line'><span class="c1">#=&gt; Bignum</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'><span class="c1">#=&gt; 1</span>
</span></code></pre></td></tr></table></div></figure>


<h1>float</h1>

<p>只要分子或分母出現浮點數，結果才會是 float</p>

<blockquote><p>兩個運算元皆為整數，則會進行截尾整數除法(truncating integer division)運算</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">3</span><span class="o">.</span><span class="mi">14</span><span class="o">.</span><span class="n">class</span>
</span><span class='line'><span class="c1">#=&gt; Float</span>
</span><span class='line'><span class="mi">1</span><span class="o">/</span><span class="mi">2</span>
</span><span class='line'><span class="c1">#=&gt; 0</span>
</span><span class='line'><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="c1">#=&gt; 0.5</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">2</span>
</span><span class='line'><span class="c1">#=&gt; 0.5</span>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="n">to_f</span>
</span><span class='line'><span class="c1">#=&gt; 1.0</span>
</span></code></pre></td></tr></table></div></figure>


<h1>運算</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">餘數</span>
</span><span class='line'><span class="mi">10</span><span class="o">%</span><span class="mi">3</span>
</span><span class='line'><span class="c1">#=&gt; 1</span>
</span><span class='line'>
</span><span class='line'><span class="err">次方</span>
</span><span class='line'><span class="mi">2</span><span class="o">**</span><span class="mi">10</span>
</span><span class='line'><span class="c1">#=&gt; 1024</span>
</span><span class='line'><span class="mi">2</span><span class="o">**-</span><span class="mi">1</span>
</span><span class='line'><span class="c1">#=&gt; (1/2)</span>
</span><span class='line'>
</span><span class='line'><span class="err">絕對值</span>
</span><span class='line'><span class="o">-</span><span class="mi">1234</span><span class="o">.</span><span class="n">abs</span>
</span><span class='line'><span class="c1">#=&gt; 1234</span>
</span><span class='line'>
</span><span class='line'><span class="err">四捨五入</span>
</span><span class='line'><span class="p">(</span><span class="mi">3</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">round</span>
</span><span class='line'><span class="c1">#=&gt; 3</span>
</span><span class='line'><span class="p">(</span><span class="mi">4</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">round</span>
</span><span class='line'><span class="c1">#=&gt; 5</span>
</span><span class='line'>
</span><span class='line'><span class="err">回傳小於該數學的最大整數</span>
</span><span class='line'><span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span>
</span><span class='line'><span class="c1">#=&gt; 2</span>
</span><span class='line'><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span>
</span><span class='line'><span class="c1">#=&gt; -3</span>
</span><span class='line'>
</span><span class='line'><span class="err">回傳大於該數學的最小整數</span>
</span><span class='line'><span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ceil</span>
</span><span class='line'><span class="c1">#=&gt; 3</span>
</span><span class='line'><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ceil</span>
</span><span class='line'><span class="c1">#=&gt; -2</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#只適用於Fixnum</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'><span class="c1">#=&gt; false</span>
</span><span class='line'><span class="mi">0</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span><span class="o">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">0</span>    <span class="c1"># Infinity</span>
</span><span class='line'><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">0</span>   <span class="c1"># -Infinity</span>
</span><span class='line'><span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span>  <span class="c1"># NaN</span>
</span></code></pre></td></tr></table></div></figure>


<h1>BigDecimal</h1>

<p>主要是用來做精確的數字</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10000</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">+</span> <span class="mi">0</span><span class="o">.</span><span class="mo">0001</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">print</span> <span class="n">sum</span>
</span><span class='line'><span class="c1">#=&gt; 0.9999999999999062</span>
</span><span class='line'><span class="c1">#因為在電腦中的浮點數其實只是近似值，浮點數中的整數可能只是精確度到達一定程度而已</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;bigdecimal&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">sum</span> <span class="o">=</span> <span class="no">BigDecimal</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10000</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">+</span> <span class="no">BigDecimal</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;0.0001&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">print</span> <span class="n">sum</span>
</span><span class='line'><span class="c1">#=&gt; 0.1E1</span>
</span><span class='line'>
</span><span class='line'><span class="n">E</span><span class="err">代表後面有幾個</span><span class="mi">10</span><span class="err">的次方</span>
</span><span class='line'><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="no">E1</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 1.0</span>
</span><span class='line'><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="no">E1</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 2.0</span>
</span><span class='line'><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="no">E2</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 20.0</span>
</span><span class='line'><span class="mi">2</span><span class="no">E3</span>   <span class="o">=</span>   <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; 2000.0</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://ruby-doc.org/stdlib-1.9.3/libdoc/bigdecimal/rdoc/BigDecimal.html">BigDecimal</a></p>

<p>參考文件：<br/>
<a href="http://blog.annideas.com/2014/10/05/ruby-girl-5-ruby-math-intro/">Ruby的數學跟老師教的數學都不一樣？</a><br/>
<a href="https://gradyli.wordpress.com/2007/11/16/numeric-class/">[Ruby教學]Numeric Class</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Includes Preload Joins Eager_load References]]></title>
    <link href="http://mgleon08.github.com/blog/2016/04/21/includes-preload-joins-eager-load-references/"/>
    <updated>2016-04-21T00:41:09+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/04/21/includes-preload-joins-eager-load-references</id>
    <content type="html"><![CDATA[<p>rails 當中有很多方便可以做資料查詢的功能，可以好好研究一下。</p>

<!-- more -->


<h1>modle</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Blog</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:posts</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># t.string   &quot;name&quot;</span>
</span><span class='line'>  <span class="c1"># t.string   &quot;author&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:blog</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># t.string   &quot;title&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>includes</h1>

<ul>
<li><code>includes</code> 主要用於可以直接將相關連的資料，在同一筆查詢，一起撈出來</li>
<li>two separate queries</li>
<li>跟 preload 類似，加上 <code>reference</code> 則和 <code>eager_load</code> 類似</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
</span><span class='line'><span class="no">Blog</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span>
</span><span class='line'><span class="no">Post</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;posts&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 2, name: &quot;Blog 2&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 3, name: &quot;Blog 3&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;]&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 回傳所有 User 和 關聯的 posts</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到後面有 <code>IN (1, 2, 3)</code>，就是將上面一筆一筆查詢，變成這種方式一次撈出來。這樣在 <code>view</code> 中執行 <code>user.posts</code> 就不會再去資料庫查詢，因為已經都先撈出來了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#也可以一次 includes 多個關聯</span>
</span><span class='line'>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">posts</span><span class="p">:</span> <span class="ss">:profile</span><span class="p">)</span>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">posts</span><span class="p">:</span> <span class="o">[</span><span class="ss">:foo</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="c1">#blog 關聯到 posts，posts 關聯到 foo, bar</span>
</span><span class='line'>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">comments</span><span class="p">:</span> <span class="o">[</span><span class="ss">:user</span><span class="p">,</span> <span class="p">{</span> <span class="ss">replies</span><span class="p">:</span> <span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="p">}</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="c1">#更複雜的關聯</span>
</span></code></pre></td></tr></table></div></figure>


<h1>preload</h1>

<ul>
<li>跟 includes 類似，主要差別在於無法用 where 條件去查關聯到的 table 欄位</li>
<li>two separate queries</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">preload</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Blog</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span>
</span><span class='line'>  <span class="no">Post</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;posts&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 2, name: &quot;Blog 2&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 3, name: &quot;Blog 3&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;]&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#無法透過關聯的欄位做搜尋</span>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">preload</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">posts</span><span class="p">:</span> <span class="p">{</span> <span class="ss">title</span><span class="p">:</span><span class="s2">&quot;Post 1-1&quot;</span> <span class="p">}</span> <span class="p">)</span>
</span><span class='line'>  <span class="no">Blog</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="o">=</span> <span class="p">?</span>  <span class="o">[[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Post 1-1&quot;</span><span class="o">]]</span>
</span><span class='line'><span class="o">=&gt;</span><span class="c1"># ActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: posts.title: SELECT &quot;blogs&quot;.* FROM &quot;blogs&quot; WHERE &quot;posts&quot;.&quot;title&quot; = ?</span>
</span><span class='line'>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">preload</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;posts.title = &#39;Post 1-1&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="ss">:post</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Blog</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">WHERE</span> <span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Post 1-1&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span><span class="c1"># ActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: posts.title: SELECT &quot;blogs&quot;.* FROM &quot;blogs&quot; WHERE (posts.title = &#39;Post 1-1&#39;)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#用 includes 就沒問題，不過這就是 eager_load</span>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">posts</span><span class="p">:</span> <span class="p">{</span> <span class="ss">title</span><span class="p">:</span><span class="s2">&quot;Post 1-1&quot;</span> <span class="p">}</span> <span class="p">)</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="no">AS</span> <span class="n">t0_r1</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;author&quot;</span> <span class="no">AS</span> <span class="n">t0_r2</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r3</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t1_r0</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="no">AS</span> <span class="n">t1_r1</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r2</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;user_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r3</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r5</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="o">=</span> <span class="p">?</span>  <span class="o">[[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Post 1-1&quot;</span><span class="o">]]</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;]&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#另一種寫法 </span>
</span><span class='line'> <span class="no">Blog</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;posts.title = &#39;Post 1-1&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="ss">:post</span><span class="p">)</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="no">AS</span> <span class="n">t0_r1</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;author&quot;</span> <span class="no">AS</span> <span class="n">t0_r2</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r3</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t1_r0</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="no">AS</span> <span class="n">t1_r1</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r2</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;user_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r3</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r5</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">WHERE</span> <span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Post 1-1&#39;</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;]&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>joins (inner join)</h1>

<p><code>joins</code> 則是關聯其他資料庫，可以進行查詢，但並不會將關聯的資料拉出來。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Blog</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">INNER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 2, name: &quot;Blog 2&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 2, name: &quot;Blog 2&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 2, name: &quot;Blog 2&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 2, name: &quot;Blog 2&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 2, name: &quot;Blog 2&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, ...]&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="no">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">INNER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">15</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#因為資料庫裡面總共有四個，但只有三個室有關聯到 posts，因此 joins 會回傳有關聯的，blog</span>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">uniq</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="no">DISTINCT</span> <span class="no">COUNT</span><span class="p">(</span><span class="no">DISTINCT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">INNER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">3</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#回傳所有，有 post 的 blog</span>
</span><span class='line'><span class="c1">#因為同一個 blog 可能有多個 post ，這樣就會撈出重複的 blog 出來 ， 一個 post 一個 blog，因此可以用 .uniq 來去除重複的資料。</span>
</span><span class='line'><span class="c1">#如果是一對一就不會有這個問題了</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#eager_load 則是透過 rails filter 後的</span>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">eager_load</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="no">AS</span> <span class="n">t0_r1</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;author&quot;</span> <span class="no">AS</span> <span class="n">t0_r2</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r3</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t1_r0</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="no">AS</span> <span class="n">t1_r1</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r2</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;user_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r3</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r5</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 2, name: &quot;Blog 2&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 3, name: &quot;Blog 3&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 4, name: &quot;Blog 2&quot;, author: nil, created_at: &quot;2016-04-20 16:01:54&quot;, updated_at: &quot;2016-04-20 16:01:54&quot;&gt;]&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#因為是 LEFT OUTER JOINed 所以沒有關聯的也會抓進來</span>
</span><span class='line'> <span class="no">Blog</span><span class="o">.</span><span class="n">eager_load</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>   <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="no">COUNT</span><span class="p">(</span><span class="no">DISTINCT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">4</span>
</span></code></pre></td></tr></table></div></figure>


<p>回傳的是所有有 <code>post</code> 的 <code>blog</code>，但並不會將 <code>post</code> 資料撈出來，只是去做比對，因此再用 <code>blog.posts</code> ，一樣會去資料庫中撈出資料。</p>

<h1>joins 範例</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Category</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:articles</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:category</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:comments</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:tags</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:article</span>
</span><span class='line'>  <span class="n">has_one</span> <span class="ss">:guest</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Guest</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:comment</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Tag</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:article</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:articles</span><span class="p">)</span>
</span><span class='line'><span class="c1">#“依文章分類來回傳分類物件”。注意到如果有 article 是相同類別，會看到重複的分類物件。若要去掉重複結果，可以使用 Category.joins(:articles).uniq。</span>
</span><span class='line'><span class="c1">#SELECT categories.* FROM categories</span>
</span><span class='line'>  <span class="c1">#INNER JOIN articles ON articles.category_id = categories.id</span>
</span><span class='line'>
</span><span class='line'><span class="no">Article</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:category</span><span class="p">,</span> <span class="ss">:comments</span><span class="p">)</span>
</span><span class='line'><span class="c1">#“依分類來回傳文章物件，且文章至少有一則評論”。有多則評論的文章將會出現很多次</span>
</span><span class='line'><span class="c1">#SELECT articles.* FROM articles</span>
</span><span class='line'>  <span class="c1">#INNER JOIN categories ON articles.category_id = categories.id</span>
</span><span class='line'>  <span class="c1">#INNER JOIN comments ON comments.article_id = articles.id</span>
</span><span class='line'>
</span><span class='line'><span class="no">Article</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">comments</span><span class="p">:</span> <span class="ss">:guest</span><span class="p">)</span>
</span><span class='line'><span class="c1">#“回傳所有有訪客評論的文章”</span>
</span><span class='line'><span class="c1">#SELECT articles.* FROM articles</span>
</span><span class='line'>  <span class="c1">#INNER JOIN comments ON comments.article_id = articles.id</span>
</span><span class='line'>  <span class="c1">#INNER JOIN guests ON guests.comment_id = comments.id</span>
</span><span class='line'>
</span><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">articles</span><span class="p">:</span> <span class="o">[</span><span class="p">{</span><span class="ss">comments</span><span class="p">:</span> <span class="ss">:guest</span><span class="p">},</span> <span class="ss">:tags</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="c1">#SELECT categories.* FROM categories</span>
</span><span class='line'>  <span class="c1">#INNER JOIN articles ON articles.category_id = categories.id</span>
</span><span class='line'>  <span class="c1">#INNER JOIN comments ON comments.article_id = articles.id</span>
</span><span class='line'>  <span class="c1">#INNER JOIN guests ON guests.comment_id = comments.id</span>
</span><span class='line'>  <span class="c1">#INNER JOIN tags ON tags.article_id = articles.id</span>
</span></code></pre></td></tr></table></div></figure>


<h1>joins和include的區別</h1>

<ul>
<li>include 主要是將其他關聯的 table 一起拉進來，後續查詢時，就不會再去查</li>
<li>joins 則是將兩張表合成一張（必須id有對到），再透過欄位去做塞選</li>
<li>joins 為 inner join ， include 為 left outer join</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
</span><span class='line'><span class="c1">#回傳所有的 Blog，並將相關聯的 post 一併做查詢</span>
</span><span class='line'><span class="c1">#後續再去關聯的話就不會去 query</span>
</span><span class='line'>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
</span><span class='line'><span class="c1">#查詢所有包含 user_id 的 posts ，並回傳該 post 所屬的 blog</span>
</span><span class='line'><span class="c1">#因此 has_many 若有很多 posts 屬於同一個 blog 就會回傳很多次重複的( 或是用 `distinct` User.joins(:posts).select(&#39;distinct users.*&#39;))，可用 uniq 去掉，belong_to &amp; has_one 則不會</span>
</span><span class='line'><span class="c1">#後續再去關聯的話，還是會去 query</span>
</span></code></pre></td></tr></table></div></figure>


<h1>eager_loading</h1>

<ul>
<li>One query, LEFT OUTER JOINed in any query rather than loaded separately.</li>
<li>Works just the same as <code>includes</code> + <code>references</code></li>
<li>因此要小心，includers 後在接上 references 就會變成 eager_load</li>
<li>Eager loading 是載入由 Model.find 回傳的物件關聯記錄的機制，將查詢數降到最低。</li>
<li>Active Record 透過使用 Model.find 搭配 includes 方法，可預先指定所有會載入的關聯。有了 includes，Active Record 確保所有指定的關聯，加載的查詢減到最少。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">eager_load</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="no">AS</span> <span class="n">t0_r1</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;author&quot;</span> <span class="no">AS</span> <span class="n">t0_r2</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r3</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t1_r0</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="no">AS</span> <span class="n">t1_r1</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r2</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;user_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r3</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r5</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 2, name: &quot;Blog 2&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 3, name: &quot;Blog 3&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;, #&lt;Blog id: 4, name: &quot;Blog 2&quot;, author: nil, created_at: &quot;2016-04-20 16:01:54&quot;, updated_at: &quot;2016-04-20 16:01:54&quot;&gt;]&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">eager_load</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Blog 1&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="no">AS</span> <span class="n">t0_r1</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;author&quot;</span> <span class="no">AS</span> <span class="n">t0_r2</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r3</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t1_r0</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="no">AS</span> <span class="n">t1_r1</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r2</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;user_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r3</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r5</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="p">?</span>  <span class="o">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Blog 1&quot;</span><span class="o">]]</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;]&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">eager_load</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Blog 1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">posts</span><span class="p">:</span> <span class="p">{</span><span class="ss">title</span><span class="p">:</span> <span class="s1">&#39;Post 1-1&#39;</span><span class="p">})</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="no">AS</span> <span class="n">t0_r1</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;author&quot;</span> <span class="no">AS</span> <span class="n">t0_r2</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r3</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t1_r0</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="no">AS</span> <span class="n">t1_r1</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r2</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;user_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r3</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r5</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="p">?</span> <span class="no">AND</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="o">=</span> <span class="p">?</span>  <span class="o">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Blog 1&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Post 1-1&quot;</span><span class="o">]]</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;]&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># includes + references </span>
</span><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Blog 1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">posts</span><span class="p">:</span> <span class="p">{</span><span class="ss">title</span><span class="p">:</span> <span class="s1">&#39;Post 1-1&#39;</span><span class="p">})</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="no">AS</span> <span class="n">t0_r1</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;author&quot;</span> <span class="no">AS</span> <span class="n">t0_r2</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r3</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t1_r0</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="no">AS</span> <span class="n">t1_r1</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r2</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;user_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r3</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r5</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="p">?</span> <span class="no">AND</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="o">=</span> <span class="p">?</span>  <span class="o">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Blog 1&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Post 1-1&quot;</span><span class="o">]]</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;]&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>references</h1>

<ul>
<li>只有在 includes 可以使用，主要是讓 includes 像 eager_load</li>
<li>where 的這種用法只對參數是 Hash 有效。傳入參數是 SQL 片段，要使用 references 來強制連接資料表。</li>
</ul>


<p><a href="http://rails.ruby.tw/active_record_querying.html#eager-loading-%E9%97%9C%E8%81%AF">#eager-loading</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Blog</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Blog 1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
</span><span class='line'>  <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="no">AS</span> <span class="n">t0_r1</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;author&quot;</span> <span class="no">AS</span> <span class="n">t0_r2</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r3</span><span class="p">,</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t0_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">AS</span> <span class="n">t1_r0</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;title&quot;</span> <span class="no">AS</span> <span class="n">t1_r1</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r2</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;user_id&quot;</span> <span class="no">AS</span> <span class="n">t1_r3</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;created_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r4</span><span class="p">,</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;updated_at&quot;</span> <span class="no">AS</span> <span class="n">t1_r5</span> <span class="no">FROM</span> <span class="s2">&quot;blogs&quot;</span> <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">&quot;posts&quot;</span> <span class="no">ON</span> <span class="s2">&quot;posts&quot;</span><span class="o">.</span><span class="s2">&quot;blog_id&quot;</span> <span class="o">=</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;blogs&quot;</span><span class="o">.</span><span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="p">?</span>  <span class="o">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Blog 1&quot;</span><span class="o">]]</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation [#&lt;Blog id: 1, name: &quot;Blog 1&quot;, author: &quot;someone&quot;, created_at: &quot;2016-04-20 14:26:01&quot;, updated_at: &quot;2016-04-20 14:26:01&quot;&gt;]&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://www.codeproject.com/KB/database/Visual_SQL_Joins/Visual_SQL_JOINS_orig.jpg" alt="" /></p>

<p>官方資料：<br/>
<a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a><br/>
<a href="http://rails.ruby.tw/active_record_querying.html">Active Record 查詢</a></p>

<p>參考資料：<br/>
<a href="https://ihower.tw/rails4/performance.html">網站效能</a><br/>
<a href="https://ihower.tw/rails4/activerecord-relationships.html">ActiveRecord - 資料表關聯</a><br/>
<a href="http://motion-express.com/blog/20141028-rails-include-join-avoid-n-1-query">Rails使用 include 和 join 避免 N+1 query</a><br/>
<a href="http://blog.ifyouseewendy.com/blog/2015/11/11/preload-eager_load-includes-references-joins/">preload, eager_load, includes, references, and joins in Rails</a><br/>
<a href="http://blog.bigbinary.com/2013/07/01/preload-vs-eager-load-vs-joins-vs-includes.html">Preload, Eagerload, Includes and Joins</a><br/>
<a href="http://blog.arkency.com/2013/12/rails4-preloading/">3 ways to do eager loading (preloading) in Rails 3 &amp; 4</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[淺談 Backend 課程筆記 3]]></title>
    <link href="http://mgleon08.github.com/blog/2016/04/19/backend-lesson-notes-3/"/>
    <updated>2016-04-19T22:29:24+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/04/19/backend-lesson-notes-3</id>
    <content type="html"><![CDATA[<p>課程筆記3</p>

<!-- more -->


<h1>理想的 Backend 系統</h1>

<h3>越少模組越好</h3>

<ul>
<li>需要監控和管理的模組變越少</li>
<li>團隊要掌握的語言/技術變越少</li>
</ul>


<h3>通用 vs 專精</h3>

<p>ex : 是否使用ElasticSearch?</p>

<ul>
<li>需要 tokenization 嗎？(和民居食屋，若打民居是否要顯示出來?)</li>
<li>能不能先在 RDBMS 做 search?</li>
</ul>


<h3>安全 vs 快速開發</h3>

<p>ex : 應該把呼叫 GCM 放到獨立的 worker?</p>

<ul>
<li>多一個 worker，多一個 worker 要管，也要建立 MQ server</li>
</ul>


<h3>沒有 Single Point of Failure</h3>

<p>所謂「SPOF」是指當某個零件故障會造成整個系統無法正當運作，那麼這個零件就是整個系統中
的 Single Points Of Failure。</p>

<ul>
<li>每一系統模組(System Component)，都應該要有 standby instance (備用實例)

<ul>
<li>但 standby instance 只能保護單一隨機性的災難</li>
</ul>
</li>
<li>一旦監控系統發現某一模組當掉，就把它停掉，並用 standby instance 取代</li>
<li>一旦某模組當掉，你的設計應該讓系統停在 Consistent 狀態

<ul>
<li>除非為了效能，而故意犧牲 Consistency</li>
</ul>
</li>
</ul>


<p>/ping/ 回傳的是 204 無法發現有什麼問題，正確是回傳 200</p>

<h3>對 Surge 有抵抗性</h3>

<ul>
<li>動態加開 AS 會有幫助，但加開的速度不一定能追上流量</li>
<li>READ 可以用 Cache 支撐，但 Write 不行</li>
<li>吃大量資源的 end point 可以考慮轉用 async 模式</li>
<li>別再 AS 上執行 async API 的工作，會害 AS 當掉</li>
</ul>


<h3>不需要即時人員支援</h3>

<ul>
<li>停用 Load Balancer 下，一台 AS 當掉便自動停用，只讓系統損失 1/n 的運算能力</li>
<li>監察系統發現 Master RDBMS 當掉後，應該懂得自動把 Slave DB 提升成 Master 並進行運算</li>
<li>交給 Job Farm 的工作，在本來的 Worker Instance 當掉後，會自動由其他 Worker 重做</li>
</ul>


<h1>Backend 架構</h1>

<h3>DNS</h3>

<ul>
<li>對大型網站，會有多個 data center 的，DNS 會回答該地區最近的 data center 的 IP</li>
<li>對大型網站，一個 domain name 可能對應多個 IP

<ul>
<li>單一 load balancer 有其物理極限的(頻寬/CPU)，因此要多個 load balancer</li>
</ul>
</li>
</ul>


<h3>Load Balancer</h3>

<ul>
<li>通常 LB 會把 HTTPS 轉成 HTTP ，然後才把 Request 轉給 AS</li>
<li>高階的 LB 能根據 url(甚至是 Request body) 做 routing

<ul>
<li> AWS 沒有(陽春的LoadBalance)，HAproxy 有，所以可以在 EC2 上架 HAproxy，就能依 url、request body 做 routing，但是AWS ELB的網路流量比EC2好很多</li>
</ul>
</li>
<li>AS 架構沒問題的話，round robin （輪詢） 跟 least conn （最少連線數） 沒什麼差別</li>
<li>如果 AS 不是 Stateless

<ul>
<li>source 只能在非流動用戶上(手機ip會改)</li>
<li>sticky 需要 LB 解讀 Request 並抽取像 SessionId 的變數，然後根據之前歷史派到特定 AS 上。對 LB 有極高性能要求。</li>
</ul>
</li>
</ul>


<blockquote><p>Stateless（Client與Server的溝通不需依賴狀態，每一個 Request 必須包含所有需要的資訊，而不需依賴其他 Request 的狀態。）</p></blockquote>

<p>參考文件：<br/>
<a href="https://dotblogs.com.tw/jimmyyu/2010/10/16/difference-between-stateful-and-stateless">Stateful與Stateless</a><br/>
<a href="http://caryhsu.blogspot.tw/2011/03/sql-server-load-balancing.htmll">SQL Server 負載平衡架構介紹(Load Balancing)</a></p>

<h3>Application Server</h3>

<ul>
<li>好的 AS 應該是 Stateless

<ul>
<li> 這樣可以是流量加開 AS</li>
<li> LB 便不用昂貴的 sticky mode 了</li>
</ul>
</li>
<li>AS中 ，不應跑會吃大量資源的工作

<ul>
<li> LB才能使用 round robin / random 模式</li>
<li> AS 才不會凍結掉</li>
</ul>
</li>
</ul>


<h3>Long Polling Server (LPS)</h3>

<ul>
<li>如果要將 message 推送到手機，請使用 GCM/APNS ，別自行架 Server</li>
<li>除非系統流量很大，用 AS 來處理 Long Polling 變好</li>
<li>使用獨立 LPS 的好處

<ul>
<li>你能專精負責 long polling 語言</li>
<li>不用擔心 AS execution worker pool 被用光</li>
</ul>
</li>
</ul>


<p>參考文件：<br/>
<a href="http://blogger.gtwang.org/2014/01/websocket-protocol.html">WebSocket 通訊協定簡介：比較 Polling、Long-Polling 與 Streaming 的運作原理</a></p>

<h3>Main DB</h3>

<ul>
<li>別輕易使用 noSQL （noSQL 沒有 transation）</li>
<li>RAID 只能保護單一 SSD 故障</li>
<li>Master/Slave Replication 保護不了壞人刪除數據</li>
<li>只有離線儲存的備份數據，才真正安全</li>
<li>效能，數據安全性，低成本 三者最多只能要兩種</li>
</ul>


<h3>Cache cluster</h3>

<ul>
<li>對小型系統，單獨一台大記憶體的機器做 Caching 也許比較方便</li>
<li>對大型系統，單獨一台機器做 Caching 不合成本效益，所以要用多台機器</li>
<li>要知道物件放在哪台機器上，最簡單方法 MD5(key) mod n</li>
<li>為 Cache cluster 增加/刪減機器時，小心別引發 total cache miss</li>
</ul>


<h3>Hot Data DB</h3>

<ul>
<li>跟 cache 是不同的</li>
<li>暫時性的，丟失了也死不了的數據</li>
<li>在為了效能犧牲 Consistency 的情況下，要延後寫入 main DB 的數據</li>
<li>一般來說 Hot Data 數據量不會太多，所以不需要 Clustering</li>
<li>建議做 Replication 去保護資料</li>
</ul>


<h3>Search DB</h3>

<ul>
<li>沒錢別額外架 Search DB</li>
<li>數據儲存結構有特別為搜尋做特化</li>
<li>有 tokenization 和 auto correction 等等幫助搜尋的重要功能</li>
<li>很多時候 Search DB 的數據和 Main DB 的數據會有時間差</li>
</ul>


<h3>Report DB</h3>

<ul>
<li>專門的 Report DB，很可能採用 denormalized schema

<ul>
<li>需要高度專業性</li>
<li>需要很多很多的錢</li>
</ul>
</li>
<li>Random Sampling 是否能解決問題</li>
</ul>


<h3>File DB</h3>

<ul>
<li>有人說 File 應該以 BLOB 物件被放到 Main DB，但是..

<ul>
<li>一般建立後極少被改動</li>
<li>RDBMS 一般用上系統中最高級的 SSD，而 File 一般不需要這種效能</li>
</ul>
</li>
<li>延伸思考，在檔案名字中額外加上 MD5，能解決很多 File caching 問題</li>
</ul>


<h3>Message Queue</h3>

<ul>
<li>Message

<ul>
<li>會裝有 Json/XML 格式的工作內容</li>
<li>會有 MessageId</li>
</ul>
</li>
<li>Producer

<ul>
<li>訊息生產者，一般來說是 AS 要建立工作</li>
<li>一個 Queue 能有多於一個 Producer</li>
</ul>
</li>
<li>Consumer

<ul>
<li>訊息消耗者，一般來說是 Worker 要執行工作</li>
<li>Queue 中沒有 Message 時，Consumer 會被 blocking，不佔用 CPU</li>
<li>一個 Queue 能有多於一個 Consumer</li>
<li>一份訊息，在同一時間內只會讓一個 Consumer 收到</li>
</ul>
</li>
<li>有些 MQ 不保證絕對性的 FIFO 和 no-duplicate，使用上請注意(ex:Amazon SQS)</li>
<li>如果應用較簡單，Redia 某程度上也能當做 MQ 使用</li>
<li>沒有人和 message 佔用 CPU 為 0，因為 worker 都被 blocked</li>
</ul>


<h3>Worker Farm</h3>

<ul>
<li>一個 Message 同一時間只會一個 worker 收到</li>
<li>可以視 Queue 中的剩餘 Message 量，動態決定增減 Worker Server</li>
</ul>


<h3>Cron job worker</h3>

<ul>
<li>跟async task worker 有點不同，只在預定時間睡醒，把工作做完便死亡</li>
<li>為了不要深夜撲火，應該在多於一台機器上執行

<ul>
<li>為了一份工作不被多個 worker 執行，需要 execution control 機制</li>
<li>Database-as-IPC 是很嚴重的 anti-pattren，但如果有很少量的 data exchange 還算可以接受</li>
</ul>
</li>
<li>理想的 Cron job 即使當掉，也無需 data cleanup，單純重跑即可</li>
<li>同時間多個 Worker 執行時，也懂的自動分工，不會出錯</li>
</ul>


<p>簡報：<br/>
<a href="https://github.com/TritonHo/slides">TritonHo/slides</a></p>
]]></content>
  </entry>
  
</feed>

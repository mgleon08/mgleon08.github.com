<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Leon's Blogging]]></title>
  <link href="http://mgleon08.github.com/atom.xml" rel="self"/>
  <link href="http://mgleon08.github.com/"/>
  <updated>2016-04-01T10:34:55+08:00</updated>
  <id>http://mgleon08.github.com/</id>
  <author>
    <name><![CDATA[LeonJi]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[RSpec & Capybara 整合測試(Selenium and Poltergeist Driver)]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/30/rspec-capybara-selenium-poltergeist-driver/"/>
    <updated>2016-03-30T00:04:46+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/30/rspec-capybara-selenium-poltergeist-driver</id>
    <content type="html"><![CDATA[<p>capybara 是一個可以模擬瀏覽器行為的測試，還蠻好玩的~<br/>
搭配不同 driver，用不同的方式來跑</p>

<!-- more -->


<p>因為是要模擬人真正在使用網頁的狀態，因次每一動，都要定義出來。</p>

<h1>設定</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#spec/rails_help.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/rspec&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/rails&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capybara/poltergeist&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="c1">#要設定為 false ，就會實際存在 database，因此需要 database_cleaner 來清</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">use_transactional_fixtures</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#devise controller 設定</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">Devise</span><span class="o">::</span><span class="no">TestHelpers</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:controller</span>
</span><span class='line'>  <span class="c1">#devise capybara 設定</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">Warden</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Helpers</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#database_clean 設定 suite -&gt; 整個 rspec</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:suite</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean_with</span> <span class="ss">:truncation</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
</span><span class='line'>    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="ss">:js</span><span class="o">]</span> <span class="p">?</span> <span class="ss">:truncation</span> <span class="p">:</span> <span class="ss">:transaction</span>
</span><span class='line'>    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
</span><span class='line'>    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#可以設定環境變數，再跑指令時，下 DRIVER=selenium rspec spec/features 才會使用預設 :rack_test 跑，但沒有支援 js 因此才需要用到 selenium(跑瀏覽器)，poltergeist(跑console)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;DRIVER&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;selenium&quot;</span>
</span><span class='line'>    <span class="no">Capybara</span><span class="o">.</span><span class="n">javascript_driver</span> <span class="o">=</span> <span class="ss">:poltergeist</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Capybara</span><span class="o">.</span><span class="n">register_driver</span> <span class="ss">:poltergeist</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
</span><span class='line'>    <span class="no">Capybara</span><span class="o">::</span><span class="no">Poltergeist</span><span class="o">::</span><span class="no">Driver</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">app</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">js_errors</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">timeout</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">phantomjs_logger</span><span class="p">:</span> <span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/log/temp.log&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>spec</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#spec/features/user_spec.rb</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;home page&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@user</span>  <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># mock CSRF </span>
</span><span class='line'>    <span class="n">allow_any_instance_of</span><span class="p">(</span><span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:protect_against_forgery?</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;User is admin can login and see data&#39;</span><span class="p">,</span> <span class="ss">:js</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">visit</span> <span class="s1">&#39;/backend&#39;</span><span class="c1">#後台首頁</span>
</span><span class='line'>    <span class="n">fill_in</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;admin@gmail.com&#39;</span> <span class="c1">#輸入email</span>
</span><span class='line'>    <span class="n">fill_in</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s1">&#39;password&#39;</span> <span class="c1">#輸入密碼</span>
</span><span class='line'>    <span class="n">click_button</span> <span class="s1">&#39;submit&#39;</span> <span class="c1">#點擊登入</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;後台&#39;</span><span class="p">)</span> <span class="c1">#到後台看到後台的字</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="ss">:js</span><span class="o">=&gt;</span> <span class="kp">true</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">login_as</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="c1">#登入</span>
</span><span class='line'>    <span class="n">visit</span> <span class="s1">&#39;/backend/posts&#39;</span>  <span class="c1">#在內頁</span>
</span><span class='line'>    <span class="n">find</span><span class="p">(</span><span class="s2">&quot;#logout&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span> <span class="c1">#點擊登出，記得要下 id</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="c1">#回到首頁</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;首頁&#39;</span><span class="p">)</span> <span class="c1">#頁面上也首頁的字</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>gem：<br/>
<a href="https://github.com/jnicklas/capybara">capybara</a> <br/>
<a href="https://github.com/SeleniumHQ/selenium">selenium</a><br/>
<a href="https://github.com/teampoltergeist/poltergeist">poltergeist</a><br/>
<a href="https://github.com/DatabaseCleaner/database_cleaner">database_cleaner</a></p>

<p>參考文件：<br/>
<a href="http://blog.tomoyukikashiro.me/post/test-csrf-in-feature-test-using-capybara/">Test CSRF in feature test using Capybara</a>      <br/>
<a href="http://www.opinionatedprogrammer.com/2011/02/capybara-and-selenium-with-rspec-and-rails-3/">Capybara (and Selenium) with RSpec &amp; Rails 3: quick tutorial</a><br/>
<a href="https://github.com/plataformatec/devise/wiki/How-To:-Test-with-Capybara">Devise: How To: Test with Capybara</a><br/>
<a href="http://stackoverflow.com/questions/10904996/difference-between-truncation-transaction-and-deletion-database-strategies">Difference between truncation, transaction and deletion database strategies</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Angular Custom Directive]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/27/angular-custom-directive/"/>
    <updated>2016-03-27T21:07:16+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/27/angular-custom-directive</id>
    <content type="html"><![CDATA[<p>在 angular 當中可以自己客製 Directive，讓 code 變得更乾淨。</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;productTitle&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="k">return</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">restrict</span><span class="o">:</span> <span class="s1">&#39;E&#39;</span>
</span><span class='line'>      <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;product-title.html&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">product</span><span class="o">-</span><span class="nx">title</span><span class="o">&gt;&lt;</span><span class="err">/product-title&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;productTitle&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="k">return</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">restrict</span><span class="o">:</span> <span class="s1">&#39;A&#39;</span>
</span><span class='line'>      <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;product-title.html&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//js 的 productTitle 名稱在 html 就會變成 product-title</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h3</span> <span class="nx">product</span><span class="o">-</span><span class="nx">title</span><span class="o">&gt;&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">‘</span><span class="nx">A</span><span class="err">’</span> <span class="err">–</span> <span class="nx">Attribute</span> <span class="p">(</span><span class="nx">You</span> <span class="nx">want</span> <span class="nx">to</span> <span class="nx">use</span> <span class="nx">your</span> <span class="nx">directive</span> <span class="nx">as</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">rating</span><span class="o">&gt;</span><span class="p">)</span>
</span><span class='line'><span class="err">‘</span><span class="nx">E</span><span class="err">’</span> <span class="err">–</span> <span class="nx">Element</span> <span class="p">(</span><span class="nx">Use</span> <span class="nx">it</span> <span class="nx">as</span> <span class="o">&lt;</span><span class="nx">rating</span><span class="o">&gt;</span><span class="p">)</span>
</span><span class='line'><span class="err">‘</span><span class="nx">C</span><span class="err">’</span> <span class="err">–</span> <span class="nx">Class</span><span class="p">.</span> <span class="p">(</span><span class="nx">Use</span> <span class="nx">it</span> <span class="nx">like</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="err">”</span><span class="nx">rating</span><span class="err">”</span><span class="o">&gt;</span><span class="p">)</span>
</span><span class='line'><span class="err">‘</span><span class="nx">M</span><span class="err">’</span> <span class="err">–</span> <span class="nx">Comment</span> <span class="p">(</span><span class="nx">Use</span> <span class="nx">it</span> <span class="nx">like</span> <span class="o">&lt;!</span><span class="err">–</span> <span class="nx">directive</span><span class="o">:</span> <span class="nx">rating</span> <span class="err">–</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>controller</code> 一起包在 <code>app.directive</code> 裡面</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;productTitle&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="k">return</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">restrict</span><span class="o">:</span> <span class="s1">&#39;A&#39;</span>
</span><span class='line'>      <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;product-title.html&#39;</span>
</span><span class='line'>      <span class="nx">controller</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">tab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>      <span class="nx">controllerAs</span><span class="o">:</span> <span class="s2">&quot;tab&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//js 的 productTitle 名稱在 html 就會變成 product-title</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h3</span> <span class="nx">product</span><span class="o">-</span><span class="nx">title</span><span class="o">&gt;&lt;</span><span class="err">/h3&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：<br/>
<a href="http://ithelp.ithome.com.tw/question/10140689">入門AngularJS筆記-directive
</a><br/>
<a href="http://exile1030-blog.logdown.com/posts/167848-custom-angularjs-directive-1">自訂 AngularJs Directive (1) :開始</a><br/>
<a href="http://exile1030-blog.logdown.com/posts/168283-customizing-the-angularjs-directive-2">自訂 AngularJs Directive (2): Hello World</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Angular File Upload]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/27/angular-file-upload/"/>
    <updated>2016-03-27T21:03:04+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/27/angular-file-upload</id>
    <content type="html"><![CDATA[<p>網站上有時候會用到上傳檔案功能。<br/>
透過 angular，可以使用<a href="https://github.com/nervgh/angular-file-upload">angular-file-upload</a> 很方便的就建立出來</p>

<!-- more -->


<p></p>

<p>這個 module 也有提供很多 API 可以使用 <a href="https://github.com/nervgh/angular-file-upload/wiki/Module-API">Module-API</a></p>

<h1>controller</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span>
</span><span class='line'><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;VideoShowCtrl&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">[</span>        <span class="s1">&#39;$scope&#39;</span><span class="p">,</span> <span class="s1">&#39;$http&#39;</span><span class="p">,</span> <span class="s1">&#39;FileUploader&#39;</span><span class="p">,</span> <span class="s1">&#39;$stateParams&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="kd">function</span><span class="p">(</span> <span class="nx">$scope</span> <span class="p">,</span>  <span class="nx">$http</span> <span class="p">,</span>  <span class="nx">FileUploader</span> <span class="p">,</span>  <span class="nx">$stateParams</span><span class="p">){</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//透過 $stateParams (ui-router) 可以得到 router 上的 id</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">postID</span> <span class="o">=</span> <span class="nx">$stateParams</span><span class="p">.</span><span class="nx">id</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">uploader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileUploader</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/posts/show&#39;</span> <span class="o">+</span> <span class="nx">postID</span><span class="s1">&#39;,</span>
</span><span class='line'><span class="s1">        formData: [],</span>
</span><span class='line'><span class="s1">        headers: {</span>
</span><span class='line'><span class="s1">            &#39;</span><span class="nx">X</span><span class="o">-</span><span class="nx">CSRF</span><span class="o">-</span><span class="nx">TOKEN</span><span class="s1">&#39; : document.querySelector(&quot;meta[name=csrf-token]&quot;).content</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">    });</span>
</span><span class='line'><span class="s1"> </span>
</span><span class='line'><span class="s1"> //內建提供上傳檔案前可以做哪些事</span>
</span><span class='line'><span class="s1">    uploader.onBeforeUploadItem = function(item){</span>
</span><span class='line'><span class="s1">     //若是傳的是 array，接到的會變成 string，可能是放在 formData 的原因@@</span>
</span><span class='line'><span class="s1">        item.formData.push({ title: &#39;</span><span class="nx">hello</span><span class="err">&#39;</span> <span class="p">})</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//內建提供上傳檔案後做哪些事</span>
</span><span class='line'>    <span class="nx">uploader</span><span class="p">.</span><span class="nx">onAfterAddingFile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">uploader</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span> <span class="nx">item</span><span class="p">.</span><span class="nx">uploader</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">uploader</span> <span class="o">=</span> <span class="nx">uploader</span>
</span><span class='line'>
</span><span class='line'><span class="p">}]);</span>
</span></code></pre></td></tr></table></div></figure>


<h1>view</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;file&quot;</span> <span class="nx">nv</span><span class="o">-</span><span class="nx">file</span><span class="o">-</span><span class="nx">select</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="nx">uploader</span><span class="o">=</span><span class="s2">&quot;uploader&quot;</span> <span class="o">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：<br/>
<a href="https://github.com/angular-ui/ui-router/wiki/URL-Routing">URL Routing</a></p>

<p>gem：<br/>
<a href="https://github.com/Marthyn/angularjs-file-upload-rails">angularjs-file-upload-rails</a><br/>
<a href="https://github.com/nervgh/angular-file-upload">angular-file-upload</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Angular 筆記]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/27/angular-notes/"/>
    <updated>2016-03-27T20:43:10+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/27/angular-notes</id>
    <content type="html"><![CDATA[<p>最近有幸在專案上用到 angular，不過卡在非常尷尬的點&hellip;<br/>
已經出 angular2 了，但專案是用 angular1..但還是來學習一下吧</p>

<!-- more -->


<p>AngularJS 跟 Rails 一樣是 MVC 框架，<br/>
可以透過 Controller 來處理 Model 和 View 的綁定。</p>

<p>Model 可以在 Controller 中進行處理<br/>
並且透過 <code>雙向資料繫結 (Two Way Data-Binding)</code>，可以即時的互動!</p>

<h1>Angular Setting</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//app/asset/javascript/app.js</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//angular.module</span>
</span><span class='line'><span class="c1">//Where we write pieces of our Angular application.</span>
</span><span class='line'><span class="c1">//Makes our code more maintainable, testable, and readable. </span>
</span><span class='line'><span class="c1">//Where we define dependencies for our app.</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="c1">//設定 module 名稱，只能有一個</span>
</span><span class='line'>  <span class="p">[</span> <span class="s1">&#39;ui.router&#39;</span><span class="p">,</span>                <span class="c1">//Dependency Injection 其他 module</span>
</span><span class='line'>    <span class="s1">&#39;angularFileUpload&#39;</span>
</span><span class='line'>  <span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<h1>ui-router config</h1>

<p>可藉由 <code>ui-router</code> module 來自定前端的 router，要再另外 inject，因為不是內建的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//#字號前面為原本的 router，後面則為 ui-router，也可以透過 HTML5mode 來把 # 字號去除掉，但就要小心不要跟原本的 router 衝到。</span>
</span><span class='line'>
</span><span class='line'><span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:3000/#/posts/list</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span>
</span><span class='line'><span class="p">.</span><span class="nx">config</span><span class="p">([</span><span class="s1">&#39;$httpProvider&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$httpProvider</span><span class="p">){</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//防止 CSRF，rails 預設都必須帶 token，才可以發 post，防止外來的攻擊</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">$httpProvider</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">common</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">token_tag</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;meta[name=csrf-token]&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="nx">token_tag</span> <span class="p">){</span> <span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-CSRF-TOKEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">token_tag</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span> <span class="p">};</span>
</span><span class='line'>      <span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;X-Requested-With&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;XMLHttpRequest&#39;</span><span class="p">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">//另一種方式</span>
</span><span class='line'>      <span class="c1">//$httpProvider.defaults.headers.common[&#39;X-CSRF-TOKEN&#39;] = $(&#39;meta[name=csrf-token]&#39;).attr(&#39;content&#39;);</span>
</span><span class='line'><span class="p">}])</span>
</span><span class='line'><span class="p">.</span><span class="nx">config</span><span class="p">(</span>
</span><span class='line'>  <span class="p">[</span>      <span class="s1">&#39;$stateProvider&#39;</span><span class="p">,</span> <span class="s1">&#39;$urlRouterProvider&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="kd">function</span><span class="p">(</span><span class="nx">$stateProvider</span><span class="p">,</span>  <span class="nx">$urlRouterProvider</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// For any unmatched url, redirect to /state1</span>
</span><span class='line'>  <span class="nx">$urlRouterProvider</span><span class="p">.</span><span class="nx">otherwise</span><span class="p">(</span><span class="s2">&quot;/home&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Now set up the states</span>
</span><span class='line'>  <span class="nx">$stateProvider</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="kr">abstract</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span><span class="s2">&quot;/posts&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">template</span><span class="o">:</span> <span class="s2">&quot;&lt;ui-view&gt;&lt;/ui-view&gt;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;posts.list&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/list&quot;</span><span class="p">,</span> <span class="c1">//http://localhost:3000/#/posts/list</span>
</span><span class='line'>      <span class="nx">templateUrl</span><span class="o">:</span> <span class="s2">&quot;/posts/index.html&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">controller</span><span class="o">:</span> <span class="s1">&#39;PostIndexCrtl&#39;</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;posts.show&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/show/:id&quot;</span><span class="p">,</span> <span class="c1">//http://localhost:3000/#/posts/show/1</span>
</span><span class='line'>      <span class="nx">templateUrl</span><span class="o">:</span> <span class="s2">&quot;/posts/show.html&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">controller</span><span class="o">:</span> <span class="s1">&#39;PostShowCrtl&#39;</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="p">}])</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="https://github.com/angular-ui/ui-router">ui-router</a><br/>
<a href="https://angular-ui.github.io/ui-router/site/#/api/ui.router">ui-router github.io</a></p>

<h1>Angular Controller</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//app/asset/javascript/Post/PostIndexCrtl.js</span>
</span><span class='line'><span class="nx">app</span>
</span><span class='line'><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;PostIndexCrtl&#39;</span><span class="p">,</span> <span class="c1">//設定 controller 名稱，只能有一個</span>
</span><span class='line'>  <span class="p">[</span>       <span class="s1">&#39;$scope&#39;</span><span class="p">,</span> <span class="s1">&#39;$http&#39;</span><span class="p">,</span> <span class="c1">//注入這個 controller 會用到的模組</span>
</span><span class='line'>  <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$http</span><span class="p">){</span>   <span class="c1">//這裏在要注入一次到這個 function 裡面</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//定義一個 function 可以透過 $http 發 get 拿回 json</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">getPost</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/posts&#39;</span><span class="p">).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>              <span class="c1">//定義變數 post = 傳回來的dat</span>
</span><span class='line'>                <span class="nx">$scope</span><span class="p">.</span><span class="nx">posts</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//這裏馬上執行，因為一定要有 data 才能做其他事</span>
</span><span class='line'>    <span class="nx">getPost</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">//排序</span>
</span><span class='line'>   <span class="nx">$scope</span><span class="p">.</span><span class="nx">sortKey</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">;</span>
</span><span class='line'>   <span class="nx">$scope</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keyname</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">$scope</span><span class="p">.</span><span class="nx">sortKey</span> <span class="o">=</span> <span class="nx">keyname</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">$scope</span><span class="p">.</span><span class="nx">reverse</span> <span class="o">=</span> <span class="o">!</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">reverse</span><span class="p">;</span> <span class="c1">//加驚嘆號可以將值變成 boolean</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//checkboxs</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">selection</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">fruits</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>        <span class="s1">&#39;蘋果&#39;</span><span class="p">,</span><span class="s1">&#39;西瓜&#39;</span><span class="p">,</span><span class="s1">&#39;香蕉&#39;</span>
</span><span class='line'>    <span class="p">];</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">//當點擊 checkbox 將值丟到 selection，取消則刪除</span>
</span><span class='line'>   <span class="kd">var</span> <span class="nx">toggleSelection</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">toggleSelection</span><span class="p">(</span><span class="nx">fruit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">//indexOf()找出目前點擊的位置，若沒有則為 -1</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">fruit</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">idx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">//splice(位置，刪除第幾個，新增資料)</span>
</span><span class='line'>          <span class="nx">$scope</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">$scope</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fruit</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//也可以將所有變數定義在最後面，方便管理</span>
</span><span class='line'>   <span class="nx">$scope</span><span class="p">.</span><span class="nx">selection</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">;</span>
</span><span class='line'>   <span class="nx">$scope</span><span class="p">.</span><span class="nx">fruits</span> <span class="o">=</span> <span class="nx">fruits</span>
</span><span class='line'>   <span class="nx">$scope</span><span class="p">.</span><span class="nx">toggleSelection</span> <span class="o">=</span> <span class="nx">toggleSelection</span>
</span><span class='line'><span class="p">}])</span>
</span></code></pre></td></tr></table></div></figure>


<h1>view</h1>

<p>在 <html ng-app="app"> ， ng-app 用來宣告 angular 的範圍<br/>
記得要載入 angular library才能使用<br/>
惱人的 turbolink 記得拿掉</p>

<p><code>&lt;ui-view&gt;&lt;/ui-view&gt;</code><br/>
ui.router 的語法，用來顯示透過 angular 拉回來的 view ，有點像是上面的 yield 是拉 rails 裡的 view 一樣
範例就是會拉下面 index 的 view 進來</p>

<h1>Angluar View</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!--public/posts/index.html--&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;box&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;box-header&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&#39;pull-right&#39;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="c">&lt;!-- ng-model 綁定 data 用來篩選--&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label&gt;</span>Any: <span class="nt">&lt;input</span> <span class="na">ng-model=</span><span class="s">&quot;search.$&quot;</span><span class="nt">&gt;&lt;/label&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label&gt;</span>ID: <span class="nt">&lt;input</span> <span class="na">ng-model=</span><span class="s">&quot;search.id&quot;</span><span class="nt">&gt;&lt;/label&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;box-body&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;table table-bordered table-hover&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;thead&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>          <span class="c">&lt;!-- ng-clik 觸發 controller 裡的 sort() function 並帶參數進去 --&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th</span> <span class="na">ng-click=</span><span class="s">&quot;sort(&#39;id&#39;)&quot;</span> <span class="na">class=</span><span class="s">&#39;pointer&#39;</span><span class="nt">&gt;</span>ID
</span><span class='line'>          <span class="c">&lt;!-- ng-show true 顯示 flase 隱藏，相反為 ng-hide --&gt;</span>
</span><span class='line'>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;glyphicon&quot;</span> <span class="na">ng-show=</span><span class="s">&quot;sortKey==&#39;id&#39;&quot;</span> <span class="na">ng-class=</span><span class="s">&quot;{&#39;glyphicon-chevron-up&#39;:reverse,&#39;glyphicon-chevron-down&#39;:!reverse}&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th&gt;</span>名稱<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>          <span class="nt">&lt;th&gt;</span>描述<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/thead&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tbody&gt;</span>
</span><span class='line'>          <span class="c">&lt;!-- ng-repeat 展開取回來的 array data --&gt;</span>
</span><span class='line'>          <span class="c">&lt;!-- filter 篩選 --&gt;</span>
</span><span class='line'>          <span class="c">&lt;!-- orderBy 排序 --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr</span> <span class="na">ng-repeat=</span><span class="s">&quot;video in videos | filter:search:strict | orderBy:sortKey:reverse&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;</span><span class="nt">&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;</span><span class="nt">&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;</span><span class="nt">&lt;/td&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/table&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!--checkbox 多選項--&gt;</span>
</span><span class='line'><span class="nt">&lt;label</span> <span class="na">ng-repeat=</span><span class="s">&quot;fruit in fruits&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name=</span><span class="s">&quot;selectedFruits[]&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="na">ng-checked=</span><span class="s">&quot;selection.indexOf(fruit) &gt; -1&quot;</span>
</span><span class='line'>    <span class="na">ng-click=</span><span class="s">&quot;toggleSelection(fruit)&quot;</span> <span class="nt">&gt;</span>
</span><span class='line'>    
</span><span class='line'><span class="nt">&lt;/label&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;</span><span class="nt">&lt;/pre&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>指令</h1>

<ul>
<li><code>ng-app</code> 用來宣告 angular 的範圍，也可放在 <code>body</code> 裡面。</li>
<li><code>ng-init</code> 可以直接在 view 中設定初始值，不過偏好管理還是直接設在 js 比較方便</li>
<li><code>ng-model</code> 設定綁定的變數</li>
<li><code>ng-click</code> 點下去觸發，設定好的function()</li>
<li><code>ng-show ng-hide</code> 搭配 ng-model 綁定資料，就可以來根據各種情況來顯示會隱藏</li>
<li><code>ng-repeat</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">p</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">repeat</span><span class="o">=</span><span class="s2">&quot;post in posts&quot;</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$index</span> <span class="err">–</span> <span class="err">取出陣列中的</span><span class="nx">index</span><span class="err">。</span><span class="p">(</span><span class="err">從</span><span class="mi">0</span><span class="err">開始</span><span class="p">)</span>
</span><span class='line'><span class="nx">$first</span> <span class="err">–</span> <span class="err">如果是第一個項目，就傳回</span><span class="kc">true</span><span class="err">、否則為</span><span class="kc">false</span><span class="err">。</span>
</span><span class='line'><span class="nx">$middle</span> <span class="err">–</span> <span class="err">如果不是第一個和最後一個項目，就傳回</span><span class="kc">true</span><span class="err">、否則為</span><span class="kc">false</span><span class="err">。</span>
</span><span class='line'><span class="nx">$last</span> <span class="err">–</span> <span class="err">如果是最後一個項目，就傳回</span><span class="kc">true</span><span class="err">、否則為</span><span class="kc">false</span><span class="err">。</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>ng-checkbox</code> 勾選框</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">ng</span><span class="o">-</span><span class="kc">true</span><span class="o">-</span><span class="nx">value</span><span class="o">=</span><span class="s2">&quot;YES&quot;</span> <span class="nx">ng</span><span class="o">-</span><span class="kc">false</span><span class="o">-</span><span class="nx">value</span><span class="o">=</span><span class="s2">&quot;NO&quot;</span>
</span><span class='line'><span class="err">可搭配這兩個設定</span> <span class="nx">ture</span> <span class="err">和</span> <span class="kc">false</span> <span class="err">時的值</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>ng-checked</code> 可以讓勾選框有 &lsquo;選擇全部&rsquo; 勾選或 &lsquo;取消全部&rsquo; 勾選的狀態</li>
<li><code>ng-options</code> 下拉式選單</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">select</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">model</span><span class="o">=</span><span class="s2">&quot;Select1&quot;</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">options</span><span class="o">=</span><span class="s2">&quot;post.name for post in posts&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">option</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">&gt;--</span> <span class="err">請選擇</span> <span class="o">--&lt;</span><span class="err">/option&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/select&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>ng-switch</code> 可以搭配 <code>ng-options</code> <a href="http://ithelp.ithome.com.tw/question/10136011">ng-switch</a></li>
<li><code>ng-change</code> 當資料改變會跟者執行</li>
<li><code>ng-include</code> 像是 partial 一樣可以 include 其他 view 進來</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">ng</span><span class="o">-</span><span class="nx">include</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;&#39;/templates/search_bar.html&#39;&quot;</span><span class="o">&gt;&lt;</span><span class="err">/ng-include&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>ng-src</code> 用來取代 html 中 img 標籤裡的 src 屬性</li>
</ul>


<p>由於 AngularJS 是整個網站載完後才開始編譯，使用 ng-src 可以解決還沒載入完 html 發生的錯誤。</p>

<ul>
<li><code>ng-href</code>是用來取代html中 a 標籤裡的href屬性</li>
</ul>


<p>如果Angular還沒載入或載入失敗，會直接讓href讀取到的內容，
而a 標籤裡的href屬性無法辨識，就會連結到404的錯誤頁面。</p>

<ul>
<li><code>ng-bind</code> 綁定 model，避免 html 載入完畢，js 還沒載入導致畫面顯示  的狀態</li>
<li><code>ng-cloak</code> 跟 ng-bind 類似，需要另外增加css，用來解決跨瀏覽器顯示的問題</li>
<li><code>ng-bind-template</code> 可以一次綁定多個 model</li>
<li><code>ng-class</code> 用 angular 設定 class</li>
<li><code>ng-form</code> ng-form允許有巢狀表單(nest forms)，就是在表單內再增加一個或多個form，而form則無法達到此需求。</li>
<li><code>$scope</code> 用來宣告變數，有點像是 js 的 <code>var</code> 或著 rails 的 <code>@</code></li>
<li><code>$watch</code> <a href="http://jsbin.com/oHIXIqa/3/edit?html,js,output">範例</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$watch</span><span class="err">、</span><span class="nx">ng</span><span class="o">-</span><span class="nx">change</span><span class="err">、</span><span class="nx">ng</span><span class="o">-</span><span class="nx">click</span><span class="err">的比較</span>
</span><span class='line'>
</span><span class='line'><span class="err">範例中</span><span class="nx">$watch</span><span class="err">和</span><span class="nx">ng</span><span class="o">-</span><span class="nx">change</span><span class="err">的結果相同，</span>
</span><span class='line'><span class="err">但使用</span><span class="nx">$watch</span><span class="err">指令，</span><span class="nx">watch</span><span class="err">的值還會傳回</span><span class="nx">newValue</span><span class="p">,</span><span class="nx">oldValue</span><span class="err">，</span>
</span><span class='line'><span class="err">提供“改變的新數值”和“前一次改變的舊數值”。</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$watch</span><span class="err">和</span><span class="nx">ng</span><span class="o">-</span><span class="nx">change</span><span class="err">是在改變內容值的時候，觸發事件，</span><span class="nx">ng</span><span class="o">-</span><span class="nx">click</span><span class="err">則只會在點擊輸入框時被執行。</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>filter</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p"></span>
</span><span class='line'>
</span><span class='line'><span class="nx">currency</span>  <span class="err">貨幣符號</span>
</span><span class='line'><span class="nx">date</span>      <span class="err">將</span> <span class="nb">Date</span> <span class="err">轉成指定格式的日期</span>
</span><span class='line'><span class="nx">filter</span>    <span class="err">可以篩選陣列中的內容</span>
</span><span class='line'><span class="nx">json</span>      <span class="nx">json</span>
</span><span class='line'><span class="nx">limitTo</span>   <span class="err">限制陣列或字串裡面的字元個數</span>
</span><span class='line'><span class="nx">number</span>    <span class="err">可以為數值或指定小數以下位數</span>
</span><span class='line'><span class="nx">lowercase</span> <span class="err">將英文字串轉成英文小寫</span>
</span><span class='line'><span class="nx">uppercase</span> <span class="err">將英文字串轉成英文大寫</span>
</span><span class='line'><span class="nx">orderBy</span>   <span class="err">可以將資料作排序</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>官方文件：<br/>
<a href="https://angularjs.org/">AngularJs</a><br/>
<a href="https://angular-ui.github.io/bootstrap/">angular-ui</a><br/>
<a href="https://github.com/angular-ui/ui-router">ui-router</a>  <br/>
<a href="https://angular-ui.github.io/ui-router/site/#/api/ui.router">ui-router github.io</a></p>

<p>參考資料：<br/>
<a href="http://ithelp.ithome.com.tw/profile/share?id=20071512&amp;page=4">入門AngularJS筆記</a><br/>
<a href="http://programer-learn.blogspot.tw/p/angularjs.html">AngularJS 系列</a><br/>
<a href="http://sweeteason.pixnet.net/blog/post/40589830">AngularJS 學習筆記系列 </a><br/>
<a href="http://carolhsu.github.io/blog/2014/06/07/step-by-step-with-angularjs-and-rails/">給 Rails Developer 看的 Angular + Rails 起步走</a><br/>
<a href="http://code.ciphertrick.com/2015/06/01/search-sort-and-pagination-ngrepeat-angularjs/">Search Sort and Pagination in ng-repeat – AngularJS</a>  <br/>
<a href="http://www.angularjs.cn/T001">Angular 中文社區</a><br/>
<a href="http://kirkchen.logdown.com/posts/245678-angularjs-talking-about-the-angularjs-provider-mechanisms">[AngularJs]淺談Angular.js的Provider機制</a><br/>
<a href="http://blog.begin.com.tw/?p=30">ANGULARJS $Q DEFERRED 和 PROMISE</a><br/>
<a href="http://www.cnblogs.com/liulangmao/tag/angular/default.html?page=4">流浪貓の窩 - angular學習筆記</a><br/>
<a href="http://blog.darkthread.net/post-2014-06-11-angularjs-notes-1.aspx">NG筆記1-AngularJS學習資源與術語</a><br/>
<a href="https://github.com/jmcunningham/AngularJS-Learning/blob/master/ZH-TW.md">學習 AngularJS</a><br/>
<a href="http://ithelp.ithome.com.tw/profile/share?id=20091340&amp;page=2">初學 AngularJS 的路</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Pundit 來做權限管理]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/26/pundit-gem/"/>
    <updated>2016-03-26T09:47:16+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/26/pundit-gem</id>
    <content type="html"><![CDATA[<p>可以搭配 <a href="http://mgleon08.github.io/blog/2016/03/08/enum/">enum</a> 簡單快速地做出權限管理。</p>

<!--more-->


<h1>指令</h1>

<p>產生資料夾 <code>app/policies/</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">g</span> <span class="ss">pundit</span><span class="p">:</span><span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<h1>設定</h1>

<p>接著就可以根據你的每個 controller action 去個別設定是否有這權限<br/>
通常會搭配 <a href="http://mgleon08.github.io/blog/2016/01/21/devise-rolify-cancan/">devise</a> 和 <a href="http://mgleon08.github.io/blog/2016/03/08/enum/">enum</a>  加上欄位 role 去做調整。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PostPolicy</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:post</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>    <span class="vi">@post</span> <span class="o">=</span> <span class="n">post</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">update?</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">admin?</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">published?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Controller</h1>

<p>在 controller 就可以藉由 <code>authorize</code> 來設定要授權的是什麼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>  <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">authorize</span> <span class="vi">@post</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@post</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">post_params</span><span class="p">)</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="vi">@post</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:edit</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>記得要 <code>include Pundit</code><br/>
也可以加上 <code>verify_authorized</code> method 來確保每個 action 都有做好設定</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Pundit</span>
</span><span class='line'>  <span class="n">after_action</span> <span class="ss">:verify_authorized</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>錯誤處理 rescue</h1>

<p>可以在 <code>ApplicationController</code> 上面直接做處理，相當方便</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">protect_from_forgery</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Pundit</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">rescue_from</span> <span class="no">Pundit</span><span class="o">::</span><span class="no">NotAuthorizedError</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:user_not_authorized</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">user_not_authorized</span>
</span><span class='line'>    <span class="n">flash</span><span class="o">[</span><span class="ss">:alert</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;You are not authorized to perform this action.&quot;</span>
</span><span class='line'>    <span class="n">redirect_to</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">referrer</span> <span class="o">||</span> <span class="n">root_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>RSPEC</h1>

<p>基本上 github 上面就非常清楚了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#rails_helper.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;pundit/rspec&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#spec/policies</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">PostPolicy</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">subject</span> <span class="p">{</span> <span class="n">described_class</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">permissions</span> <span class="ss">:update?</span><span class="p">,</span> <span class="ss">:edit?</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;denies access if post is published&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">permit</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">admin</span><span class="p">:</span> <span class="kp">false</span><span class="p">),</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">published</span><span class="p">:</span> <span class="kp">true</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;grants access if post is published and user is an admin&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">permit</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">admin</span><span class="p">:</span> <span class="kp">true</span><span class="p">),</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">published</span><span class="p">:</span> <span class="kp">true</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;grants access if post is unpublished&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">permit</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">admin</span><span class="p">:</span> <span class="kp">false</span><span class="p">),</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">published</span><span class="p">:</span> <span class="kp">false</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>gem：
<a href="https://github.com/elabs/pundit">pundit</a></p>

<p>參考資料：<br/>
<a href="http://voice.lawrencesun.info/posts/2014/12/13/rails-notes-authorization-using-pundit/">Rails Notes: Authorization Using Pundit</a><br/>
<a href="http://www.learning-rails.net/2015/09/rail-authorization-with-pundit-and.html">Rail Authorization with pundit and devise</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Routes設定]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/26/rails-routes/"/>
    <updated>2016-03-26T09:37:30+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/26/rails-routes</id>
    <content type="html"><![CDATA[<p>要如何設計網站的 router 是非常重要的一件事。<br/>
在 rails 當中也有許多方法可以做設定。</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#直接設定</span>
</span><span class='line'><span class="n">get</span> <span class="s1">&#39;/patients/:id&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;patients#show&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">#REST</span>
</span><span class='line'><span class="c1">#設定 scope 有點像資料夾的概念，可用來區分後台可控制範圍</span>
</span><span class='line'><span class="n">namespace</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1">#也可用單數 resource (會少了 index，然後不用帶id)</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:show</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">member</span> <span class="k">do</span> <span class="c1">#Acts on a single resource</span>
</span><span class='line'>      <span class="n">post</span> <span class="ss">:follow</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">collection</span> <span class="k">do</span> <span class="c1">#Acts on a collection of resources</span>
</span><span class='line'>      <span class="n">get</span> <span class="ss">:follow</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>scope</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">get</span> <span class="s1">&#39;foo/meetings/:id&#39;</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;events#show&#39;</span>
</span><span class='line'><span class="n">post</span> <span class="s1">&#39;foo/meetings&#39;</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;events#create&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="err">可以改寫成</span>
</span><span class='line'>
</span><span class='line'><span class="n">scope</span> <span class="ss">:controller</span> <span class="o">=&gt;</span> <span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/foo&quot;</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="s2">&quot;bar&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;meetings/:id&#39;</span> <span class="o">=&gt;</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="s2">&quot;meeting&quot;</span>
</span><span class='line'>  <span class="n">post</span> <span class="s1">&#39;meetings&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;:create   , :as =&gt; &quot;meetings&quot;</span>
</span><span class='line'><span class="s1">end</span>
</span><span class='line'>
</span><span class='line'><span class="s1">scope :path =&gt; &#39;</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="s1">&#39;, :module =&gt; &quot;api_v1&quot;, :as =&gt; &#39;</span><span class="n">v1</span><span class="err">&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:projects</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>:as</code> 增加 vi_path(相對路徑) 和 v1_url(絕對路徑)<br/>
<code>: path</code>網址 <code>/api/v1/projects</code> <br/>
<code>:controller</code> 指定 controller 是哪個<br/>
<code>:module</code> 指定 controller 對應到 ApiV1::ProjectsController</p>

<h1>導向</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#靜態</span>
</span><span class='line'><span class="n">get</span> <span class="s2">&quot;/welcome&quot;</span> <span class="ss">to</span><span class="p">:</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/hello&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#動態</span>
</span><span class='line'><span class="n">get</span> <span class="s1">&#39;/stories/:name&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/articles/%{name}&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>redirect</code> 將網址導向到另一個網址</p>

<h1>設定沒有指定的 path 都導向同一個頁面</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">get</span> <span class="s2">&quot;*path&quot;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">&quot;welcome#welcome&quot;</span><span class="p">,</span> <span class="ss">:defaults</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="ss">:json</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>defaults</code> 設定此 routes 輸出都是 json 格式</p>

<h1>特殊條件限定</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#過濾id</span>
</span><span class='line'><span class="n">get</span> <span class="s1">&#39;photos/:id&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;photos#show&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="sr">/[A-Z]\d{5}/</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#設定子網域</span>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:admin</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">constraints</span> <span class="ss">subdomain</span><span class="p">:</span> <span class="s1">&#39;admin&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">resources</span> <span class="ss">:photos</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#黑名單</span>
</span><span class='line'><span class="k">class</span> <span class="nc">BlacklistConstraint</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@ips</span> <span class="o">=</span> <span class="no">Blacklist</span><span class="o">.</span><span class="n">retrieve_ips</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">matches?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@ips</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;*path&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;blacklist#index&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">constraints</span><span class="p">:</span> <span class="no">BlacklistConstraint</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="ow">or</span>
</span><span class='line'>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;*path&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;blacklist#index&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">constraints</span><span class="p">:</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">request</span><span class="o">|</span> <span class="no">Blacklist</span><span class="o">.</span><span class="n">retrieve_ips</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://guides.rubyonrails.org/routing.html">Rails Routing from the Outside In</a><br/>
<a href="http://rails.ruby.tw/routing.html">Rails 路由：深入淺出</a></p>

<p>參考文件：<br/>
<a href="https://ihower.tw/rails4/routing.html">路由(Routing)</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Email 寄信通知]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/26/rails-email/"/>
    <updated>2016-03-26T09:35:21+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/26/rails-email</id>
    <content type="html"><![CDATA[<p>網站中經常會使用寄信來通知用戶，像是註冊信件，確認更改密碼等等之類的。</p>

<!--more-->


<h1>指令</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">g</span> <span class="n">mailer</span> <span class="no">TestMailer</span> <span class="n">notify_job_apply</span>
</span></code></pre></td></tr></table></div></figure>


<h1>產生檔案</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/mailers/application_mailer.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">&quot;from@example.com&quot;</span>
</span><span class='line'>  <span class="n">layout</span> <span class="s1">&#39;mailer&#39;</span>
</span><span class='line'>  
</span><span class='line'> <span class="c1">#寄信給多個收件者</span>
</span><span class='line'> <span class="c1">#default to: Proc.new { Admin.pluck(:email) }, from: &#39;notification@example.com&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#app/mailer/test_mailer.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">TestMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
</span><span class='line'>  <span class="c1"># Subject can be set in your I18n file at config/locales/en.yml</span>
</span><span class='line'>  <span class="c1"># with the following lookup:</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1">#   en.test_mailer.notify_job_apply.subject</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">notify_job_apply</span>
</span><span class='line'>    <span class="vi">@greeting</span> <span class="o">=</span> <span class="s2">&quot;Hi&quot;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">#附件檔案</span>
</span><span class='line'>  <span class="n">attachments</span><span class="o">[</span><span class="s1">&#39;filename.jpg&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;/path/to/filename.jpg&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="s2">&quot;to@example.org&quot;</span>
</span><span class='line'>    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">bcc</span><span class="p">:</span><span class="o">[</span><span class="s2">&quot;sub-email&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">&quot;Title&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>信件內容</h1>

<p>因為不是每個人都可以顯示 html 檔案，因此要有兩份</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/views/test_mailer/notify_job_apply.html.erb</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">TestMailer</span><span class="c1">#notify_job_apply&lt;/h1&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="sx">%= @greeting %&gt;, find me in app/views/test_mailer/notify_job_apply.html.erb</span>
</span><span class='line'><span class="sx">&lt;/p&gt;</span>
</span><span class='line'><span class="sx">&lt;%=</span> <span class="n">image_tag</span> <span class="n">attachments</span><span class="o">[</span><span class="s1">&#39;image.jpg&#39;</span><span class="o">].</span><span class="n">url</span><span class="p">,</span> <span class="ss">alt</span><span class="p">:</span> <span class="s1">&#39;My Photo&#39;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;photos&#39;</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>純文字檔</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/views/test_mailer/notify_job_apply.text.erb </span>
</span><span class='line'><span class="no">TestMailer</span><span class="c1">#notify_job_apply</span>
</span><span class='line'><span class="o">&lt;%=</span> <span class="vi">@greeting</span> <span class="o">%&gt;</span><span class="p">,</span> <span class="n">find</span> <span class="n">me</span> <span class="k">in</span> <span class="n">app</span><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">test_mailer</span><span class="o">/</span><span class="n">notify_job_apply</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">erb</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/model/user.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">after_save</span> <span class="p">:</span> <span class="n">notify_job_apply_notification</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="p">:</span> <span class="n">notify_job_apply?</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">notify_job_apply_notification</span>
</span><span class='line'>      <span class="no">UserMailer</span><span class="o">.</span><span class="n">notify_job_apply</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'>      <span class="c1">#deliver_now! 立即送出</span>
</span><span class='line'>      <span class="c1">#deliver_later! 非同步去處理 ex: sidekiq</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="n">edn</span>
</span></code></pre></td></tr></table></div></figure>


<h1>設定</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/environments</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#忽略任何寄信錯誤</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">raise_delivery_errors</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'><span class="c1">#測試用，不會真的寄信</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:test</span>
</span><span class='line'><span class="c1">#用什麼方式傳遞</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
</span><span class='line'><span class="c1">#網站網址</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">default_url_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">host</span><span class="p">:</span> <span class="s2">&quot;http://localhost:3000&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="c1">#一定要轉 symbol 不然會吃不到</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">smtp_settings</span> <span class="o">=</span> <span class="n">config_for</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span><span class="o">.</span><span class="n">symbolize_keys</span>
</span><span class='line'><span class="c1">#使用 sidekiq 做背景處理</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">active_job</span><span class="o">.</span><span class="n">queue_adapter</span> <span class="o">=</span> <span class="ss">:sidekiq</span>
</span></code></pre></td></tr></table></div></figure>


<p>設定擋</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/email.yml</span>
</span><span class='line'><span class="ss">development</span><span class="p">:</span>
</span><span class='line'>  <span class="ss">address</span><span class="p">:</span> <span class="s2">&quot;smtp.mailgun.org&quot;</span>
</span><span class='line'>  <span class="ss">port</span><span class="p">:</span> <span class="mi">587</span>
</span><span class='line'>  <span class="ss">domain</span><span class="p">:</span> <span class="s2">&quot;google.com&quot;</span>
</span><span class='line'>  <span class="ss">authentication</span><span class="p">:</span> <span class="s2">&quot;plain&quot;</span>
</span><span class='line'>  <span class="ss">user_name</span><span class="p">:</span> <span class="s2">&quot;postmaster@leon.tw&quot;</span>
</span><span class='line'>  <span class="ss">password</span><span class="p">:</span> <span class="s2">&quot;1234567890&quot;</span>
</span><span class='line'>  <span class="ss">enable_starttls_auto</span><span class="p">:</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<h1>預覽測試</h1>

<p><a href="https://github.com/ryanb/letter_opener">letter_opener</a> 這個 gem 可以不用真的寄信，而是直接在畫面上顯示寄信內容，就可以拿來做測試</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/environments</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_mailer</span><span class="o">.</span><span class="n">delivery_method</span> <span class="o">=</span> <span class="ss">:letter_opener</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://guides.rubyonrails.org/action_mailer_basics.html">Action Mailer</a>  <br/>
<a href="http://rails.ruby.tw/action_mailer_basics.html">Action Mailer 中文</a></p>

<p>參考文件：<br/>
<a href="https://ihower.tw/rails4/actionmailer.html">ActionMailer - E-mail 發送</a><br/>
<a href="https://ihower.tw/blog/archives/3481">如何正確發送(大量) Email 信件</a></p>

<p>gem：<br/>
<a href="https://github.com/madmimi/madmimi-gem">madmimi-gem</a><br/>
<a href="https://github.com/mailgun/mailgun-ruby">mailgun-ruby</a><br/>
<a href="https://github.com/ryanb/letter_opener">letter_opener</a></p>

<p>email:<br/>
<a href="https://madmimi.com/">madmimi.com</a><br/>
<a href="https://www.mailgun.com/">mailgun</a><br/>
<a href="http://aws.amazon.com/tw/ses/">aws</a><br/>
<a href="http://mailchimp.com/">mailchimp</a><br/>
<a href="http://sendgrid.com/">SendGrid</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Module vs Class]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/26/module-and-class/"/>
    <updated>2016-03-26T09:34:18+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/26/module-and-class</id>
    <content type="html"><![CDATA[<p>在 ruby 中經常會使用到 <code>Class</code>，也常常看到 <code>Module</code>
那到底什麼時候要用哪個?</p>

<!-- more -->


<p>先看看兩者的差異</p>

<h1>Module</h1>

<ul>
<li>無法 instantiated（也就是沒有 new method）</li>
<li>可以被 include &amp; extend</li>
</ul>


<h1>Class</h1>

<ul>
<li>可以 instantiated</li>
<li>無法被 include</li>
</ul>


<p>簡單的來說，module 有點像是沒有 new 的 Class</p>

<p>並且可以用 <code>include</code> &amp; <code>extend</code> mixin 到 Class 裡面，變成 Class 的 <code>class method</code> or <code>instance method</code></p>

<p><a href="http://mgleon08.github.io/blog/2016/02/24/include-extend-require/">Ruby 中的 Include Extend Require Load</a></p>

<p>基本上兩種方式都有辦法達成同樣的效果，但差別就在於維護上</p>

<h1>維護</h1>

<p>用 Class 的話，勢必一定要先 new 出來，並且預設會執行 <code>initialize</code> 這個method<br/>
就可以預先設定好一些參數，看起來就會比較簡潔</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Pepole</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hi</span>
</span><span class='line'>    <span class="s2">&quot;hi, </span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">yo</span>
</span><span class='line'>    <span class="s2">&quot;yo, </span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">p</span> <span class="o">=</span> <span class="no">People</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;leon&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nb">p</span><span class="o">.</span><span class="n">hi</span> <span class="c1">#=&gt; &#39;hi leon&#39;</span>
</span><span class='line'><span class="nb">p</span><span class="o">.</span><span class="n">yo</span> <span class="c1">#=&gt; &#39;yo leon&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>用 Module 的話，就必須每次呼叫 <code>hi</code> <code>yo</code> method 時都要在傳入參數進去。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Man</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hi</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="s2">&quot;hi, </span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">yo</span>
</span><span class='line'>    <span class="s2">&quot;yo, </span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Man</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s1">&#39;leon&#39;</span><span class="p">)</span> <span class="c1">#=&gt; &#39;hi leon&#39;</span>
</span><span class='line'><span class="no">Man</span><span class="o">.</span><span class="n">yo</span><span class="p">(</span><span class="s1">&#39;leon&#39;</span><span class="p">)</span> <span class="c1">#=&gt; &#39;yo leon&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>另外是當 Class include 很多 module 時，都會變成 Class 的 <code>class method</code> or <code>instance method</code>，這時就很難去分辨是從哪個 module 來的 method。</p>

<p>因此使用上，看習慣，可維護性等等，去判斷要用 module or class<br/>
再細分要放在 <code>cocern</code> or <code>service object</code> or <code>lib</code></p>

<p>參考文件：<br/>
<a href="http://mgleon08.github.io/blog/2016/02/24/include-extend-require/">module include extend</a>
<a href="http://railsfun.tw/t/class-module-class/402">class與module的差異? class如何繼承</a><br/>
<a href="http://stackoverflow.com/questions/151505/difference-between-a-class-and-a-module">Difference between a class and a module</a><br/>
<a href="http://motion-express.com/blog/20141011-rails-module-model">Rails利用Module整理Model
</a><br/>
<a href="http://motion-express.com/blog/20141209-ruby-class-inheritance">Ruby class 基本的覆寫(override)及繼承(inheritance)</a><br/>
<a href="http://motion-express.com/blog/20141208-class-method-and-instance-method">Ruby當中的class method和instance method差在哪？</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Concern 來整理 Code]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/26/concern/"/>
    <updated>2016-03-26T09:32:30+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/26/concern</id>
    <content type="html"><![CDATA[<p>當有相當多地方用到同樣的東西時，就可以用 concern 來讓 code 變得更乾淨。</p>

<!--more-->


<h1>使用時機</h1>

<ul>
<li>DRYing up model codes</li>
<li><p>Skin Fat Models.</p></li>
<li><p>將可重用的功能抽出來，讓多個 model 共用</p></li>
<li>model 太肥大，將相關的邏輯的 code 放到不同的 concern 裡</li>
<li>ActiveSupport::Concern 的風格</li>
</ul>


<h1>ActiveSupport::Concern</h1>

<p>任務是讓管理 modules 之間的 dependencies 變得容易。<br/>
也可以用 <code>include</code> 同時達成 <code>class methods</code> <code>instance methods</code>
（原本必須 include + extend 才能達成）</p>

<h1>原本作法</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/concerns/sample.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Sample</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Sample2</span>
</span><span class='line'>  <span class="c1"># self.included 會在 Sample 被 include 時執行</span>
</span><span class='line'>  <span class="c1"># base 傳入是誰哪個 Class include 了這個 module</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span> <span class="c1"># 用 class_eval 在該 class 新增 Class method</span>
</span><span class='line'>      <span class="c1">#scope :disabled, -&gt; { where(disabled: true) } 可以定義 scope</span>
</span><span class='line'>      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">foo</span>
</span><span class='line'>            <span class="s2">&quot;這裡是 class 的 method&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">bar</span>
</span><span class='line'>     <span class="s2">&quot;這裡是 instance 的 method&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/models/test.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Test</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Samples</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Test</span><span class="o">.</span><span class="n">foo</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="s2">&quot;這裡是 class 的 method&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Test</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">bar</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="s2">&quot;這裡是 instance 的 method&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>兩個 module 可以互相 include</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/concerns/sample2.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Sample2</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1">#do something method</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/models/test.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Test</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Sample</span>
</span><span class='line'>  <span class="c1"># include Sample，再透過 Sample 去 include Sample2 ,這樣就不用一次 include 兩個 module了</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上看起來蠻理想的<br/>
但因為 include <code>Sample2</code> 的是 <code>Sample</code><br/>
所以 <code>Sample2</code> 的 base 就變成了 <code>Sample</code> ， 不是我們要的 <code>Test</code></p>

<h1>更改</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/concerns/sample.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Sample</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Sample2</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>    <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:method</span><span class="p">)</span> <span class="c1"># base 改成 self</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/concerns/sample2.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Sample2</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:methods</span><span class="p">)</span>  <span class="c1"># base 改成 self</span>
</span><span class='line'>    <span class="c1"># 可以在這裡放當 include 時要執行的東西</span>
</span><span class='line'>    <span class="c1"># 可以存取所有 class level 的東西</span>
</span><span class='line'>    <span class="c1"># ex1: 宣告 shared scope</span>
</span><span class='line'>    <span class="c1"># ex2: 可寫 shared validation</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#可以直接定義 ClassMethods 不需再 send(:extend, ClassMethods) 或是用 class_eval 去定義</span>
</span><span class='line'>   <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>        <span class="c1"># do something</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#可以直接定義 InstanceMethods 不需再 send(:include, InstanceMethods)或是用 instance_eval 去定義</span>
</span><span class='line'>   <span class="k">module</span> <span class="nn">InstanceMethods</span>  <span class="c1">#也可以不用特別定義 module InstanceMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">bar</span>
</span><span class='line'>         <span class="c1"># do something</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/models/test.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Test</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Sample</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>concern vs service object</h1>

<ul>
<li>concern</li>
<li>簡單說就是，有許多 model 有共用的邏輯片段，可以拆出來</li>
<li>service object</li>
<li><p>與 concern 不同</p></li>
<li><p>兩個搭配使用</p></li>
<li>將許多 service object 搬到 concern</li>
</ul>


<p>官方文件：<br/>
<a href="http://api.rubyonrails.org/classes/ActiveSupport/Concern.html">ActiveSupport</a></p>

<p>參考文件：<br/>
<a href="https://ruby-china.org/topics/18401">什麼時候使用Concerns，什麼時候使用Services？</a><br/>
<a href="https://ihower.tw/blog/archives/3949">深入Rails3: ActiveSupport::Concern</a><br/>
<a href="http://stackoverflow.com/questions/14541823/how-to-use-concerns-in-rails-4">How to use concerns in Rails 4</a><br/>
<a href="https://ruby-china.org/topics/19812">ActiveSupport::Concern 小結</a><br/>
<a href="http://adz.cool/posts/210893-rails-use-case-mixin-and-concerns">rails use case - mixin &amp; concerns</a><br/>
<a href="https://www.viget.com/articles/slimming-down-your-models-and-controllers">Slimming Down Your Models and Controllers with Concerns, Service Objects, and Tableless Models</a><br/>
<a href="https://ihower.tw/rails4/activesupport.html">ActiveSupport - 工具函式庫</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lib vs Service Object]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/26/lib-and-service-object/"/>
    <updated>2016-03-26T09:31:32+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/26/lib-and-service-object</id>
    <content type="html"><![CDATA[<p>大家都知道，fat models, skinny controllers<br/>
但要將 code 放在哪邊，才會比較好維護?這就有很多方式了</p>

<!-- more -->


<h1>/lib:</h1>

<ul>
<li>It is not coupled to my app&rsquo;s domain models.</li>
<li>It can be reused on other projects.</li>
<li>It can potentially become its own gem. Thus, putting it in lib/ is the first step in that direction.</li>
</ul>


<p>簡單的來說，<code>/lib</code> 放的比較像是，很多 project 都可以重複使用，並沒有專屬某個 project，並且可以包成一個 gem 給大家使用。</p>

<p>舉例: <code>FacebookAuth</code> <code>GithubAuth</code></p>

<h1>/app/services:</h1>

<ul>
<li>They tend to know a decent amount about the inner workings of domain models.</li>
<li>Perform work that is specific to business domain in my app.</li>
<li>Tend to be coupled to specific models.</li>
</ul>


<p>而 <code>/app/services</code> 比較像是，專屬於某個 <code>project</code>，並且與 business logic 息息相關，就像是某個服務一樣。</p>

<p>舉例: <code>UserAuthenticator</code> <code>開立發票</code> <code>寄密碼提醒信</code></p>

<h1>Service Object使用時機</h1>

<ul>
<li>The action is complex (e.g. closing the books at the end of an accounting period)</li>
<li>The action reaches across multiple models (e.g. an e-commerce purchase using Order, CreditCard and Customer objects)</li>
<li>The action interacts with an external service (e.g. posting to social networks)</li>
<li>The action is not a core concern of the underlying model (e.g. sweeping up outdated data after a certain time period).</li>
<li>There are multiple ways of performing the action (e.g. authenticating with an access token or password). This is the Gang of Four Strategy pattern.</li>
</ul>


<p>大致上就是</p>

<ol>
<li>邏輯複雜</li>
<li>牽扯到很多 model 關係 (ex: 兩個 model 的資料運算)</li>
<li>與外部服務相關 (ex: slack 通知)</li>
<li>與核心無關 (ex: 定時清理過期數據)</li>
<li>會經常重複使用</li>
</ol>


<h3>約定</h3>

<ul>
<li>一個Service Object 只做一件事。</li>
<li>每個Service Object 一個文件，統一放在app/services 目錄下。</li>
<li>命名採用動作，比如SignEstimate ，而不是EstimateSigner 。</li>
<li>instance級別實現兩個接口，initialize負責傳入所有依賴，call負責調用。</li>
<li>class級別實現一個接口call，用於簡單的實例化Service Object然後調用call 。</li>
<li>call的返回值默認為true/false，也可以有更複雜的形式，比如StatusObject 。</li>
</ul>


<blockquote><p>以上約定主要都是看個人習慣，也有人會放在 <code>app/controller</code> 底下<br/>
<a href="http://vrybas.github.io/blog/2014/08/15/a-way-to-organize-poros-in-rails/">A Way to Organize POROs in Rails</a></p></blockquote>

<h1>concern vs service object</h1>

<ul>
<li>concern</li>
<li>簡單說就是，有許多 model 有共用的邏輯片段，可以拆出來</li>
<li>service object</li>
<li><p>與 concern 不同的地方是，存放的是比較完成的 code，簡單多你丟什麼給它，他就會丟相對應的資料給你。</p></li>
<li><p>兩個搭配使用</p></li>
<li>將許多 service object 搬到 concern</li>
</ul>


<p>參考文件：<br/>
<a href="https://ruby-china.org/topics/18401">什麼時候使用Concerns，什麼時候使用Services？</a><br/>
<a href="https://ruby-china.org/topics/23892">Service Object 整理和小結</a><br/>
<a href="http://brewhouse.io/blog/2014/04/30/gourmet-service-objects.html">Gourmet Service Objects</a><br/>
<a href="http://blog.codeclimate.com/blog/2012/10/17/7-ways-to-decompose-fat-activerecord-models/">7 Patterns to Refactor Fat ActiveRecord Models</a><br/>
<a href="http://motion-express.com/blog/20141007-rails-service-object">Rails code 整理系列- Service Object 初探</a><br/>
<a href="http://stackoverflow.com/questions/16159021/rails-service-objects-vs-lib-classes">Rails service objects vs lib classes</a><br/>
<a href="http://www.johnnyji.me/rails/2015/05/19/lib-folder-vs-services-in-rails.html">Lib Folder vs. Services in Rails</a><br/>
<a href="http://tech.gadii.net/blog/2014/08/25/Service-Objects-%E6%95%B4%E7%90%86%E6%9E%B6%E6%A7%8B/">Service Objects 整理架構</a><br/>
<a href="https://blog.engineyard.com/2014/keeping-your-rails-controllers-dry-with-services">Using Services to Keep Your Rails Controllers Clean and DRY</a> <br/>
<a href="https://www.viget.com/articles/slimming-down-your-models-and-controllers">Slimming Down Your Models and Controllers with Concerns, Service Objects, and Tableless Models</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[引數的傳遞 Argument Parameter]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/26/argument-parameter/"/>
    <updated>2016-03-26T09:28:59+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/26/argument-parameter</id>
    <content type="html"><![CDATA[<p>經常會看到 <code>argument</code> 和 <code>parameter</code> 兩個很類似，卻代表的不同意義。<br/>
另外也有許多符號 * ** &amp; 可以使用。</p>

<!-- more -->


<h1>介紹</h1>

<ul>
<li><p>argument(actual argument 實際的值) 引數<br/>
「呼叫端」傳給呼叫對象的「值」</p></li>
<li><p>parameter(formal parameter 代表參數的符號) = 參數<br/>
「被呼叫端」用來接收引數的「變數」</p></li>
</ul>


<h1>範例</h1>

<p>有預設值的 <code>parameter</code> 要相連在一起</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>傳入參數時，會先將值帶入沒有預設值的 <code>a</code>，在緊接著給最左邊的 <code>c</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [3, 2, 3]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [3, 1, 3]</span>
</span></code></pre></td></tr></table></div></figure>


<p>預設值的位置不同，結果也不一樣</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, 2, 3] #直接給沒有預設值的 c</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [3, 2, 1] #有兩個值，會先將第一個值給有預設值的第一個 a，第二個才補到 c</span>
</span></code></pre></td></tr></table></div></figure>


<h1>* Array</h1>

<ul>
<li>當 <code>parameter</code> 前面加上 <code>*</code> 代表 <code>Array</code> 的意思</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#必須和有預設值得放在一起</span>
</span><span class='line'><span class="c1">#若要放中間，最後面不能放預設值(因為有預設值要擺在一起)，可以放變數</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [4, 5, [6, 7, 8]]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#至少兩個參數</span>
</span><span class='line'><span class="c1">#=&gt; [1, [], 2]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, [2], 3]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, [2, 3], 4]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, [2, 3, 4], 5]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>另一種用法將 Array 展開來</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="o">]</span>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [[4, 5, 6, 7, 8], 2, []] #將 numble 當成一個參數了ˊˋ</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="o">*</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [4, 5, [6, 7, 8]] #將 Array 給展開來</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, [], [4, 5, 6, 7, 8]]</span>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="o">*</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [4, [5, 6, 7], 8]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>** Hash</h1>

<ul>
<li>當 <code>parameter</code> 前面加上 <code>**</code> 代表 <code>Hash</code> 的意思</li>
<li>一定要擺到最後一個</li>
<li>只能有一個</li>
<li>並且要傳入的是 <code>Hash</code></li>
<li>傳入的值若不是在最後面，要加上 <code>{}</code>,預設會將後面所有的 <code>key-value</code> 包成一個 <code>Hash</code></li>
</ul>


<blockquote><p>即使後面不加 <code>**</code> 預設也會將後面的值都包成一個 hash</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, 2, {:j=&gt;4, :q=&gt;5, :k=&gt;6}]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">({</span><span class="s1">&#39;j&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">},</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># 放在前面加上 {}</span>
</span><span class='line'><span class="c1">#=&gt; [{:j=&gt;4, :q=&gt;5, :k=&gt;6}, 3, 4]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># &#39;b&#39;:1 傳入的值必須 key-value 並且要對到 key</span>
</span><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="ss">c</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="mi">44</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [{:a=&gt;11, :v=&gt;22, :c=&gt;33, :s=&gt;44}, 2, 3]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="mi">44</span><span class="p">},</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [{:a=&gt;11, :v=&gt;22, :c=&gt;33, :s=&gt;44}, 100, 3]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">c</span><span class="p">)</span> <span class="c1"># sample(a, b, c)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [4, {:a=&gt;1}, {}]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [4, 5, {:a=&gt;1, :b=&gt;2, :c=&gt;3}]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [4, {:a=&gt;1, :v=&gt;2, :c=&gt;4}, {}]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">({</span><span class="s1">&#39;z&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">},</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [{:z=&gt;5}, {:a=&gt;1, :v=&gt;2}, {:c=&gt;4}]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">},</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [4, {:a=&gt;1, :v=&gt;2}, {:c=&gt;4}]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>另一種用法將 Hash 展開</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">hash</span>  <span class="o">=</span> <span class="p">{</span><span class="ss">:q</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="ss">:w</span><span class="o">=&gt;</span><span class="mi">5</span><span class="p">,</span> <span class="ss">:e</span><span class="o">=&gt;</span><span class="mi">6</span><span class="p">}</span>
</span><span class='line'><span class="n">hash2</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:r</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="ss">:t</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:y</span><span class="o">=&gt;</span><span class="mi">5</span><span class="p">,</span> <span class="ss">:u</span><span class="o">=&gt;</span><span class="mi">6</span><span class="p">}}</span>
</span><span class='line'><span class="n">hash3</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:i</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="ss">:o</span><span class="o">=&gt;</span><span class="mi">5</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">hash</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt;  [1, {:q=&gt;4, :w=&gt;5, :e=&gt;6}, {}]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">hash</span><span class="p">,</span> <span class="n">hash2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, {:q=&gt;4, :w=&gt;5, :e=&gt;6}, {:r=&gt;4, :t=&gt;{:y=&gt;5, :u=&gt;6}}]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#將兩個 hash 合併成一個</span>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span> <span class="p">,</span><span class="o">**</span><span class="nb">hash</span><span class="p">,</span> <span class="o">**</span><span class="n">hash2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, {:q=&gt;4, :w=&gt;5, :e=&gt;6, :r=&gt;4, :t=&gt;{:y=&gt;5, :u=&gt;6}}, {}]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#展開後，後面就可以繼續塞 hash</span>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">**</span><span class="nb">hash</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span><span class="mi">123</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span><span class="mi">456</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, 2, {:q=&gt;4, :w=&gt;5, :e=&gt;6, :foo=&gt;123, :bar=&gt;456}]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">hash</span>  <span class="o">=</span> <span class="p">{</span><span class="ss">:q</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="ss">:w</span><span class="o">=&gt;</span><span class="mi">5</span><span class="p">,</span> <span class="ss">:e</span><span class="o">=&gt;</span><span class="mi">6</span><span class="p">}</span>
</span><span class='line'><span class="n">hash2</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:r</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="ss">:t</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:y</span><span class="o">=&gt;</span><span class="mi">5</span><span class="p">,</span> <span class="ss">:u</span><span class="o">=&gt;</span><span class="mi">6</span><span class="p">}}</span>
</span><span class='line'><span class="n">hash3</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:i</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="ss">:o</span><span class="o">=&gt;</span><span class="mi">5</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="o">**</span><span class="nb">hash</span><span class="p">,</span> <span class="o">**</span><span class="n">hash2</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, 100, {:j=&gt;4, :q=&gt;5, :k=&gt;6, :c=&gt;{:q=&gt;5, :k=&gt;6}}]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="o">**</span><span class="nb">hash</span><span class="p">,</span> <span class="o">**</span><span class="n">hash2</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, 100, {:q=&gt;4, :w=&gt;5, :e=&gt;6, :r=&gt;4, :t=&gt;{:y=&gt;5, :u=&gt;6}}]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="o">**</span><span class="nb">hash</span><span class="p">,</span> <span class="o">**</span><span class="n">hash2</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">123</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, 123, {:q=&gt;4, :w=&gt;5, :e=&gt;6, :r=&gt;4, :t=&gt;{:y=&gt;5, :u=&gt;6}, :test=&gt;100}]</span>
</span></code></pre></td></tr></table></div></figure>


<h1>&amp; 區塊傳遞</h1>

<p>若要調用在變數，前綴一個『&amp;』符號，並且要放在最後一個</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Array</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">iterate!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">code</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">array</span><span class="o">.</span><span class="n">iterate!</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
</span><span class='line'>  <span class="n">n</span> <span class="o">**</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="n">array</span><span class="o">.</span><span class="n">inspect</span>
</span></code></pre></td></tr></table></div></figure>


<h1>綜合使用</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;a=</span><span class="si">#{</span><span class="n">a</span><span class="si">}</span><span class="s2">, b=</span><span class="si">#{</span><span class="n">b</span><span class="si">}</span><span class="s2">, c=</span><span class="si">#{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">d</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="ss">x</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="ss">y</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">x</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#=&gt; a=1, b=[2, 3], c={:x=&gt;4, :y=&gt;5}</span>
</span><span class='line'><span class="c1">#=&gt; 100</span>
</span></code></pre></td></tr></table></div></figure>


<p>若最後面是 * 不限制長度，塞很多變數，或是後面接 hash 都不會錯</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="o">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">].</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, 2, [3, 4, 5]]</span>
</span><span class='line'>
</span><span class='line'><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; [1, 2, [{:a=&gt;1, :b=&gt;2}]]</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[自己定義 Rake Tasks]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/10/custom-tasks/"/>
    <updated>2016-03-10T21:29:39+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/10/custom-tasks</id>
    <content type="html"><![CDATA[<p>在寫 rails 當中，經常會用到 rake xxx，現在也可以自己定義了!</p>

<!-- more -->


<p>檔案放在 <code>/config/tasks/xxx.rake</code>
記得後面副檔名是 <code>rake</code></p>

<h1><a href="http://data.taipei/opendata/datalist/apiAccess?scope=resourceAquire&amp;rid=ddb80380-f1b3-4f8e-8016-7ed9cba571d5">Ubike</a></h1>

<p>get 台北 Uike 資料，並存取到資料庫。</p>

<p>可以用 <a href="https://github.com/rest-client/rest-client">rest-client</a> 這個gem
先用 <code>get</code> 取得資料，再用 <code>JSON.parse</code> 來將 <code>string</code> 解析成 <code>hash</code></p>

<p><code>rake dev:fetch_ubike</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#lib/tasks/dev.rake</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;get Ubike date&quot;</span> <span class="c1"># 新增訊息在 rake --tasks 裡面</span>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:dev</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:fetch_ubike</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;fetching ubike&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://data.taipei/opendata/datalist/apiAccess?scope=resourceAquire&amp;rid=ddb80380-f1b3-4f8e-8016-7ed9cba571d5&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">raw_content</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="n">raw_content</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">data</span><span class="o">[</span><span class="s2">&quot;result&quot;</span><span class="o">][</span><span class="s2">&quot;results&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span>
</span><span class='line'>      <span class="n">a</span> <span class="o">=</span> <span class="no">Ubike</span><span class="o">.</span><span class="n">find_by_ubike_id</span><span class="p">(</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;_id&quot;</span><span class="o">]</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="c1"># maybe update it!</span>
</span><span class='line'>        <span class="no">Ubike</span><span class="o">.</span><span class="n">create</span><span class="p">(</span> <span class="ss">:ubike_id</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;_id&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;sna&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="no">Ubike</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="ss">:ubike_id</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;_id&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">[</span><span class="s2">&quot;sna&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣只要打 <code>rake dev:fetch_ubike</code> 就會自動跑了!</p>

<h1><a href="http://vote.ly.g0v.tw/api/vote/?page=1">立委資料</a></h1>

<p><code>rake vote:fetch_raw_vote</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#立委資料，資料相當大，很多分頁</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;get vote data&quot;</span> <span class="c1"># 新增訊息在 rake --tasks 裡面</span>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:vote</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'> <span class="n">task</span> <span class="ss">:fetch_raw_vote</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>   <span class="nb">puts</span> <span class="s2">&quot;fetching raw_vote&quot;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://vote.ly.g0v.tw/api/vote/?page=1&quot;</span>
</span><span class='line'>   <span class="n">raw_content</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>   <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="n">raw_content</span> <span class="p">)</span>
</span><span class='line'>     <span class="k">while</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;next&quot;</span><span class="o">]</span> <span class="o">!=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="n">data</span><span class="o">[</span><span class="s2">&quot;results&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>           <span class="no">Vote</span><span class="o">.</span><span class="n">create</span><span class="p">(</span> <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;url&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;uid&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:sitting_id</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;sitting_id&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:vote_seq</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;vote_seq&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;content&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:conflict</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;conflict&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:results</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;results&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                           <span class="ss">:result</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;result&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>         <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">url</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;next&quot;</span><span class="o">]</span>
</span><span class='line'>         <span class="n">raw_content</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>         <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="n">raw_content</span> <span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>secret.yml</h1>

<p>或是定義可以直接下指令新增 <code>secret.yml</code></p>

<p><code>rake generate:secrets</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">paste_secrets</span>
</span><span class='line'>  <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span>
</span><span class='line'><span class="s2">    # Be sure to restart your server when you modify this file.</span>
</span><span class='line'>
</span><span class='line'><span class="s2">    # Your secret key is used for verifying the integrity of signed cookies.</span>
</span><span class='line'><span class="s2">    # If you change this key, all old signed cookies will become invalid!</span>
</span><span class='line'>
</span><span class='line'><span class="s2">    # Make sure the secret is at least 30 characters and all random,</span>
</span><span class='line'><span class="s2">    # no regular words or you&#39;ll be exposed to dictionary attacks.</span>
</span><span class='line'><span class="s2">    # You can use `rake secret` to generate a secure secret key.</span>
</span><span class='line'>
</span><span class='line'><span class="s2">    # Make sure the secrets in this file are kept private</span>
</span><span class='line'><span class="s2">    # if you&#39;re sharing your code publicly.</span>
</span><span class='line'>
</span><span class='line'><span class="s2">    development:</span>
</span><span class='line'><span class="s2">      secret_key_base: </span><span class="si">#{</span><span class="sb">`rake secret`</span><span class="o">.</span><span class="n">strip</span><span class="si">}</span><span class="s2"></span>
</span><span class='line'>
</span><span class='line'><span class="s2">    test:</span>
</span><span class='line'><span class="s2">      secret_key_base: </span><span class="si">#{</span><span class="sb">`rake secret`</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
</span><span class='line'>
</span><span class='line'><span class="s2">    # Do not keep production secrets in the repository,</span>
</span><span class='line'><span class="s2">    # instead read values from the environment.</span>
</span><span class='line'><span class="s2">    production:</span>
</span><span class='line'><span class="s2">      secret_key_base: </span><span class="si">#{</span><span class="sb">`rake secret`</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
</span><span class='line'><span class="s2">  &quot;</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/config/secrets.yml&quot;</span>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">){</span><span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;Add secrets.yml&quot;</span> <span class="c1"># 新增訊息在 rake --tasks 裡面</span>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:generate</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:secrets</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Generating: </span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/config/secrets.yml&quot;</span>
</span><span class='line'>    <span class="n">paste_secrets</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Done!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>之前寫的Json
<a href="http://mgleon08.github.io/blog/2016/01/09/ruby-on-rails-json/">Json</a></p>

<p>參考資料：
<a href="https://ihower.tw/rails4/rails-recipes.html">錦囊妙計</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Outputting XML]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/08/outputting-xml/"/>
    <updated>2016-03-08T23:03:49+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/08/outputting-xml</id>
    <content type="html"><![CDATA[<p>在 <code>rails</code> 當中，可以用 <code>xml.builder</code> 來輕鬆的輸出 <code>xml</code></p>

<!-- more -->


<h1>Format</h1>

<p>可以直接在 <code>routes</code> ，設定 format 格式</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">get</span>  <span class="ss">:l</span><span class="p">,</span> <span class="ss">:defaults</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="s1">&#39;xml&#39;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>或是 controller</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;csv&#39;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">PeopleController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="vi">@people</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">html</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span><span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="vi">@person</span><span class="o">.</span><span class="n">to_json</span> <span class="p">}</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">xml</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:xml</span> <span class="o">=&gt;</span> <span class="vi">@person</span><span class="o">.</span><span class="n">to_xml</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>View</h1>

<p><code>index.xml.builder</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">xml</span><span class="o">.</span><span class="n">instruct!</span>
</span><span class='line'><span class="n">xml</span><span class="o">.</span><span class="n">xml</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">xml</span><span class="o">.</span><span class="n">linkXml</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">xml</span><span class="o">.</span><span class="n">phone</span>  <span class="vi">@user</span>
</span><span class='line'>    <span class="n">xml</span><span class="o">.</span><span class="n">age</span>    <span class="vi">@age</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#&lt;xml&gt;</span>
</span><span class='line'>  <span class="c1">#&lt;linkXml&gt;</span>
</span><span class='line'>    <span class="c1">#&lt;phone&gt;1234-5678&lt;/phone&gt;</span>
</span><span class='line'>    <span class="c1">#&lt;age&gt;20&lt;/age&gt;</span>
</span><span class='line'>  <span class="c1">#&lt;/linkXml&gt;</span>
</span><span class='line'><span class="c1">#&lt;/xml&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>gem：<br/>
<a href="https://github.com/jimweirich/builder">builder</a></p>

<p>參考文件：<br/>
<a href="https://richonrails.com/articles/outputting-xml-using-ruby-on-rails">Outputting XML Using Ruby on Rails
</a>
<a href="https://ihower.tw/rails4/actionview.html">Action View - 樣板設計</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Migration 中新增欄位 + 指令]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/08/migration/"/>
    <updated>2016-03-08T22:50:55+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/08/migration</id>
    <content type="html"><![CDATA[<p>當已經上線的網站，需要新的欄位，而欄位又需要有值，這時就可以直接在 <code>migration</code> 下指令去跑。</p>

<!-- more -->


<p>在已經啟動的 project 新增欄位時，可以額外下指令，去給初始值。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">g</span> <span class="n">migration</span> <span class="n">add_Date_Time_To_User</span>
</span></code></pre></td></tr></table></div></figure>


<h1>execute</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddDateTimeToUser</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:confirmed_at</span><span class="p">,</span> <span class="ss">:datetime</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE users SET confirmed_at = NOW()&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="n">remove_columns</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:confirmed_at</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 <code>migration</code> 重算 <code>counter cache</code></p>

<p><a href="http://mgleon08.github.io/blog/2015/12/20/counter-cache/">counter cache</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddPostsCountToTopic</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:topics</span><span class="p">,</span> <span class="ss">:posts_count</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Topic</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>      <span class="no">Topic</span><span class="o">.</span><span class="n">reset_counters</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="ss">:posts</span><span class="p">)</span> <span class="c1"># 全部重算一次</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：<br/>
<a href="https://ihower.tw/rails4/migrations.html">Active Record - 資料庫遷移(Migration)</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Instance_eval & Class_eval 自己加 Method!]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/08/instance-eval-class-eval/"/>
    <updated>2016-03-08T22:46:28+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/08/instance-eval-class-eval</id>
    <content type="html"><![CDATA[<p>有時候會發現有些 object，沒有設定 setter &amp; getter ，剛好又需要用到，這時就可以派上用場拉。</p>

<!-- more -->


<h1>instance_eval &amp; class_eval</h1>

<p><code>instance_eval</code> Use ClassName.instance_eval to define a class method (one associated with the class object but not visible to instances).</p>

<p><code>class_eval</code> Use ClassName.class_eval to define an instance method (one that applies to all of the instances of ClassName).</p>

<p>簡單的來說，就是自己定義 class or instance 的 method</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyClass</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@num</span> <span class="o">=</span> <span class="n">num</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>錯誤，因為沒有 getter or setter methods</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">num</span>
</span><span class='line'><span class="c1">#=&gt;NoMethodError: undefined method `num&#39; for #&lt;MyClass:0x007fba5c02c858 @num=&quot;1&quot;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>自行加 instance method</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="vi">@num</span> <span class="p">}</span>
</span><span class='line'><span class="c1">#=&gt; 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以直接定義 method，這樣就可以一直重複使用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>   <span class="k">def</span> <span class="nf">num</span>
</span><span class='line'>     <span class="vi">@num</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">num</span>
</span><span class='line'><span class="c1">#=&gt; 1</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">num</span>
</span><span class='line'><span class="c1">#NoMethodError: undefined method `num&#39; for #&lt;MyClass:0x007fba5c08e5f8 @num=&quot;2&quot;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>上述指定義了 a 的 <code>instance method</code> 所以 b 會錯誤。<br/>
因此可以直接定義在 <code>class instance</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">MyClass</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">num</span>
</span><span class='line'>      <span class="vi">@num</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">num</span>
</span><span class='line'><span class="c1">#=&gt; 1</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">num</span>
</span><span class='line'><span class="c1">#=&gt; 2</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：<br/>
<a href="http://web.stanford.edu/~ouster/cgi-bin/cs142-winter15/classEval.php">Understanding class_eval and instance_eval</a><br/>
<a href="http://openhome.cc/Gossip/Ruby/Eval.html">eval</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[有什麼事，就問 Ruby 吧!]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/08/ask-ruby/"/>
    <updated>2016-03-08T22:43:33+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/08/ask-ruby</id>
    <content type="html"><![CDATA[<p>ruby 有趣的事，什麼都可以問它XD</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#問 a 的方法有哪些</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">methods</span>
</span><span class='line'><span class="c1">#=&gt; [:inspect, :to_s, :to_a, :to_h, :to_ary, :frozen?, :==, :eql?, :hash...]</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">public_methods</span>    <span class="c1">#取得實例上public方法</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">protected_methods</span> <span class="c1">#取得實例上protected方法</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">private_methods</span>   <span class="c1">#取得實例上private方法</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">instance_methods</span>           <span class="c1">#可取得類別或模組上定義的非private實例方法</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">public_instance_methods</span>    <span class="c1">#可取得類別或模組上定義的public實例方法</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">protected_instance_methods</span> <span class="c1">#可取得類別或模組上定義的protected實例方法</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">private_instance_methods</span>   <span class="c1">#可取得類別或模組上定義的private實例方法</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
</span><span class='line'><span class="err">如果呼叫方法時加上</span><span class="kp">false</span><span class="err">，表示僅取得類別或模組中定義的實例方法，排除繼承或含括而來的實例方法。</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">public_class_method</span>  <span class="c1">#取得public的模組或類別方法</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">private_class_method</span> <span class="c1">#取得private的模組或類別方法</span>
</span><span class='line'>
</span><span class='line'><span class="nb">local_variables</span>    <span class="c1">#區域變數清單</span>
</span><span class='line'><span class="nb">global_variables</span>   <span class="c1">#全域變數清單</span>
</span><span class='line'><span class="nb">instance_variables</span> <span class="c1">#物件的實例變數</span>
</span><span class='line'><span class="nb">class_variables</span>    <span class="c1">#類別或模組變數</span>
</span><span class='line'>
</span><span class='line'><span class="n">defined?</span> <span class="c1">#知道變數是哪個範圍的變數 local? global?</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#問它是否有這個方法</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">respond_to?</span> <span class="ss">:to_s</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#問它的 class 是什麼</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">class</span>
</span><span class='line'><span class="c1">#=&gt; Array</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#問爸爸的class 是什麼</span>
</span><span class='line'><span class="nb">Array</span><span class="o">.</span><span class="n">superclass</span>  <span class="o">=&gt;</span> <span class="no">Object</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#直接列出祖宗十八代</span>
</span><span class='line'><span class="nb">Array</span><span class="o">.</span><span class="n">ancestors</span>
</span><span class='line'><span class="c1">#=&gt; [Array, JSON::Ext::Generator::GeneratorMethods::Array, Enumerable, Object, ActiveSupport::Dependencies::Loadable, PP::ObjectMixin, JSON::Ext::Generator::GeneratorMethods::Object, Kernel, BasicObject]</span>
</span><span class='line'>
</span><span class='line'><span class="nb">Array</span><span class="o">.</span><span class="n">included_modules</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Double Colon(::) 是啥? 能吃嗎？]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/08/double-colon/"/>
    <updated>2016-03-08T22:42:03+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/08/double-colon</id>
    <content type="html"><![CDATA[<p>在 ruby 中常常會看到各種符號， 像是 <code>::</code> 在 ruby 就像是 <code>namespace</code> 的感覺。<br/>
<code>::</code> 加在最前面，就是會去參照最上面的 <code>namespace</code>。</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">MR_COUNT</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># constant defined on main Object class</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Foo</span>
</span><span class='line'>  <span class="no">MR_COUNT</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="o">::</span><span class="no">MR_COUNT</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c1"># set global count to 1</span>
</span><span class='line'>  <span class="no">MR_COUNT</span> <span class="o">=</span> <span class="mi">2</span>      <span class="c1"># set local count to 2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">puts</span> <span class="no">MR_COUNT</span>       <span class="c1"># this is the global constant</span>
</span><span class='line'><span class="nb">puts</span> <span class="no">Foo</span><span class="o">::</span><span class="no">MR_COUNT</span>  <span class="c1"># this is the local &quot;Foo&quot; constant</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Foo</span>
</span><span class='line'>  <span class="c1"># We may not know about this in real big apps</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Engine</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Engine1</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Engine</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Engine2</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Engine</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Foo</span><span class="o">::</span><span class="no">Engine1</span><span class="o">.</span><span class="n">superclass</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="no">Foo</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Engine</span> <span class="c1"># not what we want</span>
</span><span class='line'>
</span><span class='line'><span class="no">Foo</span><span class="o">::</span><span class="no">Engine2</span><span class="o">.</span><span class="n">superclass</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Engine</span> <span class="c1"># correct</span>
</span></code></pre></td></tr></table></div></figure>


<p>參考文件：<br/>
<a href="http://blog.eddie.com.tw/2015/04/19/namespace/">Ruby 語法放大鏡之「有時候會看到有兩個冒號寫法是什麼意思?」</a><br/>
<a href="http://stackoverflow.com/questions/4819312/double-colons-before-class-names-in-ruby">Double colons before class names in Ruby?</a><br/>
<a href="http://stackoverflow.com/questions/10482772/rubys-double-colon-operator-usage-differences">Ruby&rsquo;s double colon (::) operator usage differences</a><br/>
<a href="https://cbabhusal.wordpress.com/2015/03/26/ruby-ruby-dot-and-double-colon-operators/">Ruby : Ruby dot “.” and double Colon “::” Operators</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用 Enum 做選項]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/08/enum/"/>
    <updated>2016-03-08T22:39:02+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/08/enum</id>
    <content type="html"><![CDATA[<p>可將多的選項的欄位，用 interger 來儲存，在列舉出來。<br/>
好處是之後要更改欄位名稱，就可以直接更改相對應的值，就不用特別去資料庫更改。</p>

<!-- more -->


<h3>設定</h3>

<p>注意要 enum 的欄位必須是 <code>integer</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>t.integer gender</span></code></pre></td></tr></table></div></figure>


<p>model</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">enum</span> <span class="ss">gender</span><span class="p">:</span><span class="o">[</span><span class="ss">:male</span><span class="p">,</span> <span class="ss">:female</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">genders</span>
</span><span class='line'><span class="c1">#=&gt;{&quot;male&quot;=&gt;0, &quot;female&quot;=&gt;1}</span>
</span><span class='line'>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">keys</span>
</span><span class='line'><span class="c1">#=&gt;[&quot;male&quot;, &quot;female&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">gender</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">gender</span>
</span><span class='line'><span class="c1">#=&gt;&quot;male&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">male?</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">female?</span>
</span><span class='line'><span class="c1">#=&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://api.rubyonrails.org/v4.1/classes/ActiveRecord/Enum.html">api - Enum</a></p>

<p>參考文件：<br/>
<a href="https://ruby-china.org/topics/18504">Rails 4.1 的新特性（译）</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dirty Objects 追蹤 Model 的屬性是否有改變]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/08/dirty-objects/"/>
    <updated>2016-03-08T22:36:09+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/08/dirty-objects</id>
    <content type="html"><![CDATA[<p>可用來觀察，追蹤 Model 的屬性是否有改變<br/>
可在存進資料庫前，根據是否修改，來做其他動作</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">changed</span>
</span><span class='line'><span class="c1">#=&gt; []</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">changed?</span>
</span><span class='line'><span class="c1">#=&gt; false</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;abc&quot;</span>
</span><span class='line'><span class="c1">#=&gt; &quot;abc&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">changed?</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">changed</span>
</span><span class='line'><span class="c1">#=&gt; [&quot;title&quot;]</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">changes</span>
</span><span class='line'><span class="c1">#=&gt; {&quot;title&quot;=&gt;[&quot;ha&quot;, &quot;abc&quot;]}</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">title_was</span>
</span><span class='line'><span class="c1">#=&gt; &quot;ha&quot; 改變之前的值</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'><span class="c1">#=&gt; &quot;asd&quot;</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">title_change</span>
</span><span class='line'><span class="c1">#=&gt; [&quot;ha&quot;, &quot;asd&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="err">儲存進資料庫，追蹤記錄就消失了。</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">changed?</span>
</span><span class='line'><span class="c1">#=&gt; false</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">changed</span>
</span><span class='line'><span class="c1">#=&gt; []</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">changes</span>
</span><span class='line'><span class="c1">#=&gt; {}</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://api.rubyonrails.org/classes/ActiveModel/Dirty.html">api - Dirty</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Serialize & Store 將 Object 塞在欄位裡]]></title>
    <link href="http://mgleon08.github.com/blog/2016/03/08/serialize-store/"/>
    <updated>2016-03-08T22:33:45+08:00</updated>
    <id>http://mgleon08.github.com/blog/2016/03/08/serialize-store</id>
    <content type="html"><![CDATA[<p>當欄位上需要塞比較多 <code>data</code> 時就可以使用，相當便利。</p>

<!-- more -->


<h1>Serialize 序列化</h1>

<p>可以將一個 object 轉換成一個可被資料庫儲存及傳輸的純文字形態
反之讀出來就是，Deserialize 反序列。</p>

<p><code>serialize</code> 可指定欄位，在存入資料庫時，就會自動序列化成YAML格式。</p>

<h3>欄位必須是 text</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="n">types</span>
</span></code></pre></td></tr></table></div></figure>


<p>model</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">serialize</span> <span class="ss">:types</span>
</span><span class='line'>  <span class="c1">#若沒特別指定，任何形式都可存取</span>
</span><span class='line'>  <span class="n">serialize</span> <span class="ss">:types</span> <span class="nb">Array</span>
</span><span class='line'>  <span class="c1">#指定 Array，就不能塞 Hash 進去</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">profiles</span><span class="p">:</span> <span class="p">{</span><span class="ss">gender</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="ss">phone</span><span class="p">:</span> <span class="mi">12345</span><span class="p">})</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">profiles</span>
</span><span class='line'><span class="c1">#=&gt; {gender: &quot;male&quot;, phone: 12345}</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">profiles</span><span class="o">[</span><span class="ss">:gender</span><span class="o">]</span>
</span><span class='line'><span class="c1">#=&gt; male</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>缺點是 serialize 後的欄位，就無法用 where 進行查詢。</p></blockquote>

<h1>Store</h1>

<p>上述的 profiles 可以用 <code>store</code> 來設定。
就像是一般的變數一樣。</p>

<h3>欄位必須是 text</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="n">types</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">store</span> <span class="ss">:profiles</span><span class="p">,</span> <span class="ss">:accessors</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:gender</span><span class="p">,</span> <span class="ss">:phone</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">gender</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="ss">phone</span><span class="p">:</span> <span class="mi">12345</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">profiles</span>
</span><span class='line'><span class="c1">#=&gt; {:gender =&gt; &quot;male&quot;, :phone =&gt; 12345}</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">gender</span>
</span><span class='line'><span class="c1">#=&gt; &quot;male&quot;</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">phone</span>
</span><span class='line'><span class="c1">#=&gt; 12345</span>
</span></code></pre></td></tr></table></div></figure>


<p>官方文件：<br/>
<a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html#M001799">api - serialize</a><br/>
<a href="http://apidock.com/rails/ActiveRecord/Base/serialize/class">apidock - serialize</a><br/>
<a href="http://api.rubyonrails.org/classes/ActiveRecord/Store.html">api - Store</a></p>

<p>參考文件：<br/>
<a href="https://ihower.tw/rails4/activerecord-others.html">ActiveRecord - 進階功能</a></p>
]]></content>
  </entry>
  
</feed>
